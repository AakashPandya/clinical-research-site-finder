<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>CRSFinder</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè•</text></svg>" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Export libraries -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Define CommonJS globals for libraries that expect them -->
    <script>
      window.exports = window.exports || {};
      window.module = window.module || { exports: window.exports };
      // Redirect any deep link like /login to root so SPA works and URL shows domain only
    </script>
    <style>
        .identical-row {
            background-color: #f8fafc;
            opacity: 0.8;
        }
        

        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
        }
        
        /* Enhanced UX improvements */
        .site-checkbox {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        
        .site-checkbox:checked {
            transform: scale(1.1);
        }
        
        .comparison-button {
            transition: all 0.2s ease-in-out;
        }
        
        .comparison-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .profile-dropdown-menu {
            animation: slideDown 0.2s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .identical-row {
            transition: opacity 0.3s ease-in-out;
        }
        
        .identical-row.hidden {
            opacity: 0.3;
        }
        
        /* Custom slider styles */
        input[type="range"].sleek-slider::-webkit-slider-runnable-track {
            background: linear-gradient(to right, #3b82f6 0%, #3b82f6 var(--value-percent), #e0f2fe var(--value-percent), #e0f2fe 100%);
            height: 6px;
            border-radius: 3px;
        }
        input[type="range"].sleek-slider::-moz-range-track {
            background: linear-gradient(to right, #3b82f6 0%, #3b82f6 var(--value-percent), #e0f2fe var(--value-percent), #e0f2fe 100%);
            height: 6px;
            border-radius: 3px;
        }
        input[type="range"].sleek-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            margin-top: -5px;
            background-color: #3b82f6;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            cursor: pointer;
            transition: box-shadow 0.15s ease-in-out;
        }
        input[type="range"].sleek-slider:hover::-webkit-slider-thumb,
        input[type="range"].sleek-slider:focus::-webkit-slider-thumb {
            box-shadow: 0 0 0 6px rgba(59, 130, 246, 0.25);
        }
        
        /* Sidebar and layout fixes */
        .sidebar-container {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 50;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        
        /* Ensure perfect border alignment */
        .sidebar-container .border-b,
        .sidebar-container .border-t,
        header .border-b {
            border-color: #e5e7eb !important;
            border-width: 1px !important;
        }
        
        /* Enhanced visualization animations */
        @keyframes slideInFromLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .performance-metric {
            animation: fadeInUp 0.6s ease-out;
        }
        
        .geographic-bar {
            animation: slideInFromLeft 0.8s ease-out;
        }
        
        /* PDF Export Styling */
        .pdf-export-container {
            font-family: Arial, sans-serif;
            line-height: 1.4;
        }
        
        .pdf-export-container table {
            border-collapse: collapse;
        }
        
        .pdf-export-container th,
        .pdf-export-container td {
            border: 1px solid #d1d5db;
        }
        
        .main-content {
            margin-left: 0;
            min-height: 100vh;
            background-color: transparent;
        }
        
        /* Top Navigation Styles */
        .top-nav {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .nav-item {
            transition: all 0.2s ease-in-out;
            border-radius: 8px;
            margin: 0 4px;
        }
        
        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }
        
        .nav-item.active {
            background-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* Chat Panel Styles */
        .chat-panel {
            position: fixed;
            right: 0;
            top: 0;
            height: 100vh;
            width: 400px;
            background: white;
            box-shadow: -4px 0 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            z-index: 40;
        }
        
        .chat-panel.open {
            transform: translateX(0);
        }
        
        .chat-toggle {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            z-index: 50;
        }
        
        .chat-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }
        
        .chat-toggle.open {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        /* Create Scenario Form Improvements */
        .upload-area {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 3px dashed #cbd5e1;
            border-radius: 16px;
            transition: all 0.3s ease-in-out;
            cursor: pointer;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .upload-area:hover {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        }
        
        .upload-area.dragover {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            transform: scale(1.02);
        }
        
        .form-section {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease-in-out;
        }
        
        .form-section:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        /* Gradient Button Styles */
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            transition: all 0.2s ease-in-out;
        }
        
        .btn-gradient:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .btn-gradient:active {
            transform: translateY(0);
        }

        /* Responsive Grid for Cards */
        .responsive-grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            width: 100%;
        }

        /* Ensure cards handle content overflow properly */
        .responsive-grid > div {
            min-width: 0;
            overflow: hidden;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .upload-area {
                min-height: 150px;
                padding: 2rem 1rem;
            }
            
            .form-section {
                padding: 1.5rem;
                margin: 0 1rem;
            }
            
            .responsive-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 0 1rem;
            }

            /* Fix mobile layout issues */
            .chat-toggle {
                right: 1rem;
                bottom: 1rem;
                z-index: 50;
            }

            .chat-panel {
                width: 100%;
                right: 0;
                left: 0;
                height: 100vh;
                z-index: 60;
            }

            /* Prevent horizontal scroll */
            body {
                overflow-x: hidden;
            }

            .max-w-screen-2xl {
                max-width: 100%;
                padding-left: 1rem;
                padding-right: 1rem;
            }

            /* Mobile form adjustments */
            .grid.grid-cols-1.md\\:grid-cols-2 {
                grid-template-columns: 1fr;
            }

            /* Mobile button adjustments */
            .flex.gap-4 {
                flex-direction: column;
                gap: 0.5rem;
            }

            /* Mobile table adjustments */
            .overflow-x-auto {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Mobile navigation adjustments */
            .nav-item {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }

            /* Mobile header adjustments */
            .flex.items-center.space-x-8 {
                gap: 1rem;
            }

            .flex.items-center.space-x-8 > * {
                flex-shrink: 0;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .responsive-grid {
                grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
                gap: 1.5rem;
                width: 100%;
            }

            /* Tablet specific adjustments */
            .chat-panel {
                width: 400px;
            }

            .max-w-screen-2xl {
                max-width: 100%;
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }

            /* Tablet form adjustments */
            .grid.grid-cols-1.md\\:grid-cols-2 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Prevent horizontal scroll on all devices */
        html, body {
            overflow-x: hidden;
            max-width: 100vw;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }

        /* Ensure all containers respect viewport width */
        .container, .max-w-screen-2xl, .max-w-7xl, .max-w-5xl {
            max-width: 100%;
            box-sizing: border-box;
            padding-left: 1rem;
            padding-right: 1rem;
        }

        /* Mobile-specific container adjustments */
        @media (max-width: 768px) {
            .container, .max-w-screen-2xl, .max-w-7xl, .max-w-5xl {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }
        }

        /* Ensure tables don't cause horizontal scroll on mobile */
        .overflow-x-auto {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
        }

        /* Fix mobile button touch targets */
        button, .cursor-pointer {
            min-height: 44px;
            min-width: 44px;
        }

        /* Mobile form improvements */
        input, select, textarea {
            font-size: 16px; /* Prevents zoom on iOS */
        }

        /* Fresh, clean checkbox styling */
        input[type="checkbox"] {
            height: 1.25rem;
            width: 1.25rem;
            color: #2563eb;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        input[type="checkbox"]:checked {
            background-color: #2563eb;
            border-color: #2563eb;
        }

        input[type="checkbox"]:focus {
            outline: none;
            box-shadow: 0 0 0 2px #dbeafe;
            border-color: #2563eb;
        }

        input[type="checkbox"]:hover {
            @apply border-blue-400;
        }

        /* Site comparison checkboxes - Subtle indigo theme */
        .site-checkbox {
            @apply text-indigo-600 focus:ring-indigo-500;
        }

        /* Checkbox container improvements */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Ensure checkbox and label are perfectly aligned */
        .checkbox-container input[type="checkbox"] {
            margin: 0;
            flex-shrink: 0;
        }

        .checkbox-container label {
            margin: 0;
            line-height: 1.2;
            display: flex;
            align-items: center;
        }

        /* Match score badge alignment */
        .match-score-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 2.5rem;
        }

        /* Tooltip positioning improvements */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        /* Fix chat icon positioning and functionality */
        .chat-toggle {
            position: fixed;
            right: 2rem;
            bottom: 2rem;
            z-index: 50;
            cursor: pointer;
            touch-action: manipulation;
        }

        .chat-toggle:hover {
            transform: scale(1.05);
        }

        .chat-toggle:active {
            transform: scale(0.95);
        }

        /* Chat panel positioning */
        .chat-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease-in-out;
            z-index: 60;
            border-radius: 0;
            overflow: hidden;
        }

        .chat-panel.open {
            right: 0;
        }

        /* Ensure chat panel content is properly contained */
        .chat-panel .flex.flex-col.h-full {
            height: 100%;
            overflow: hidden;
        }

        .chat-panel .flex-1.p-4.overflow-y-auto {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        @media (max-width: 768px) {
            .chat-toggle {
                right: 1rem;
                bottom: 1rem;
                width: 3rem;
                height: 3rem;
            }

            .chat-toggle .w-6.h-6 {
                width: 1.25rem;
                height: 1.25rem;
            }

            .chat-panel {
                width: 100%;
                right: -100%;
                left: 0;
            }

            .chat-panel.open {
                right: 0;
                left: 0;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .chat-toggle {
                right: 1.5rem;
                bottom: 1.5rem;
            }

            .chat-panel {
                width: 350px;
            }
        }
        
        @media (max-width: 1023px) {
            .sidebar-container.open {
                transform: translateX(0);
            }
        }
        
        /* Ensure login page has clean background */
        body.login-page {
            background-color: #f9fafb;
        }
        
        /* Hide sidebar completely on login */
        .sidebar-container.hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
const { useState, useEffect, useMemo, useRef } = React;

// --- SVG Icon Components ---
const PinIcon = ({ className, isPinned }) => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    className={className}
    viewBox="0 0 24 24"
    strokeWidth="2"
    stroke="currentColor"
    fill={isPinned ? 'currentColor' : 'none'}
  >
    {/* Pin head (circle) */}
    <circle cx="12" cy="6" r="3" />
    {/* Pin shaft (line) */}
    <path
      strokeLinecap="round"
      strokeLinejoin="round"
      d="M12 9v12"
    />
    {/* Pin point (small triangle) */}
    <path
      strokeLinecap="round"
      strokeLinejoin="round"
      d="M10 21l2 2 2-2"
    />
  </svg>
);

const ArchiveIcon = ({ className }) => (
  <svg 
    className={className} 
    viewBox="0 0 24 24" 
    fill="none" 
    stroke="currentColor" 
    strokeWidth="2"
  >
    <path 
      strokeLinecap="round" 
      strokeLinejoin="round" 
      d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" 
    />
  </svg>
);

const UploadIcon = ({ className }) => (
  <svg className={className} viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clipRule="evenodd"/></svg>
);
const ChevronDownIcon = ({ className }) => (
  <svg className={className} viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clipRule="evenodd"/></svg>
);
const LoadingSpinner = ({ className }) => (
    <svg className={`animate-spin ${className}`} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
);
const CheckIcon = ({ className }) => (
    <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={3} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
);
const SparklesIcon = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.5 21.75l-.398-1.178a3.375 3.375 0 00-2.455-2.456L12.5 18l1.178-.398a3.375 3.375 0 002.455-2.456L16.5 14.25l.398 1.178a3.375 3.375 0 002.456 2.456L20.25 18l-1.178.398a3.375 3.375 0 00-2.456 2.456z" />
    </svg>
);

// --- Modern Dropdown Component ---
function ModernDropdown({ options, selected, onSelect, placeholder, className = "" }) {
    const [isOpen, setIsOpen] = useState(false);
    const dropdownRef = useRef(null);

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                setIsOpen(false);
            }
        };

        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    const selectedOption = options.find(option => option.value === selected);

    return (
        <div className={`relative ${className}`} ref={dropdownRef}>
            <button
                type="button"
                onClick={() => setIsOpen(!isOpen)}
                className="flex items-center justify-between min-w-[280px] max-w-[400px] px-3 py-2 text-sm bg-white/10 text-white border border-white/20 rounded-md hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-white/50 transition-all"
            >
                <div className="text-left min-w-0 flex-1">
                    <span className={`block ${selectedOption ? 'text-white' : 'text-white/70'} truncate`}>
                        {selectedOption ? selectedOption.label : placeholder}
                    </span>
                    {selectedOption && selectedOption.subtitle && (
                        <div className="text-xs text-white/70 truncate">
                            {selectedOption.subtitle}
                        </div>
                    )}
                </div>
                <ChevronDownIcon className={`w-4 h-4 text-white/70 transition-transform ${isOpen ? 'rotate-180' : ''} ml-2 flex-shrink-0`} />
            </button>
            
            {isOpen && (
                <div className="absolute right-0 mt-2 w-[400px] max-w-[90vw] bg-white rounded-md shadow-lg py-1 z-50 border border-gray-200 max-h-60 overflow-auto">
                    {options.map((option) => (
                        <button
                            key={option.value}
                            onClick={() => {
                                onSelect(option.value);
                                setIsOpen(false);
                            }}
                            className={`block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 transition-colors ${
                                option.value === selected 
                                    ? 'bg-gradient-to-r from-blue-50 to-indigo-50 text-blue-700 font-medium' 
                                    : 'text-gray-700'
                            }`}
                        >
                            <div className="font-medium truncate">{option.label}</div>
                            {option.subtitle && (
                                <div className="text-xs text-gray-500 mt-1 truncate">{option.subtitle}</div>
                            )}
                        </button>
                    ))}
                </div>
            )}
        </div>
    );
}




// --- Main App Component ---
function App() {
    const [currentPage, setCurrentPage] = useState('projects'); // Always start with projects for better UX
    const [projects, setProjects] = useState([]);
    const [currentProject, setCurrentProject] = useState(null);
    const [scenarios, setScenarios] = useState([]);
    const [currentScenario, setCurrentScenario] = useState(null);
    const [currentSite, setCurrentSite] = useState(null);
    const [comparisonScenarios, setComparisonScenarios] = useState(null);
    const [isLoading, setIsLoading] = useState(true);
    const [chatMessages, setChatMessages] = useState([]);
    const [isExportingExcel, setIsExportingExcel] = useState(false);
    const [isChatLoading, setIsChatLoading] = useState(false);
    const [selectedForComparison, setSelectedForComparison] = useState([]);
    const [input, setInput] = useState({
        email: '',
        password: ''
    });
    const [isOpen, setIsOpen] = useState(false);
    const [formData, setFormData] = useState({
        title: '',
        sponsor: '',
        studyId: '',
        indication: '',
        drugInfo: '',
        phase: 'Phase II',
        targetSubjects: 100,
        timeline: 12,
        startDate: '',
        preferredRegions: ['North America'],
        objective: '',
        protocolDetails: '',
        criteriaWeights: {
            patientAvailability: 25,
            enrollmentRate: 20,
            startupSpeed: 20,
            piMatch: 20,
            competition: 15
        }
    });
    const [sidebarOpen, setSidebarOpen] = useState(false);
    const [chatOpen, setChatOpen] = useState(false);

    // --- Utility Functions ---
    const getBasePath = () => window.location.hostname === 'aakashpandya.github.io' ? '/clinical-research-site-finder' : '';

    // --- Data ---
    // Initialize mock projects data and link scenarios
    useEffect(() => {
        if (projects.length === 0) {
            const mockProjects = [
                {
                    id: 1,
                    name: 'NEURO-001: Alzheimer\'s Disease Treatment Program',
                    description: 'Phase II/III clinical trials evaluating novel amyloid-targeting therapies and tau protein inhibitors for early-stage Alzheimer\'s disease. Multi-center, randomized, double-blind, placebo-controlled studies.',
                    therapeuticArea: 'Neurology',
                    sponsor: 'NeuroGen Therapeutics Inc.',
                    createdDate: '2024-01-15',
                    status: 'Active',
                    scenarios: [],
                    totalScenarios: 18,
                    completedTrials: 4,
                    activeTrials: 14,
                    regulatoryPhase: 'Phase II/III',
                    targetEnrollment: 2400,
                    estimatedCompletion: '2026-12-31',
                    primaryEndpoints: 'Cognitive decline, amyloid plaque reduction',
                    secondaryEndpoints: 'Quality of life, safety profile'
                },
                {
                    id: 2,
                    name: 'ONCO-002: Solid Tumor Immunotherapy Platform',
                    description: 'Multi-indication immunotherapy trials targeting PD-1/PD-L1 pathways in advanced solid tumors including NSCLC, melanoma, and renal cell carcinoma. Adaptive design with biomarker-driven patient selection.',
                    therapeuticArea: 'Oncology',
                    sponsor: 'OncoImmune Solutions Corp.',
                    createdDate: '2024-02-20',
                    status: 'Active',
                    scenarios: [],
                    totalScenarios: 22,
                    completedTrials: 6,
                    activeTrials: 16,
                    regulatoryPhase: 'Phase I/II',
                    targetEnrollment: 1800,
                    estimatedCompletion: '2027-06-30',
                    primaryEndpoints: 'Overall survival, progression-free survival',
                    secondaryEndpoints: 'Response rate, safety, quality of life'
                },
                {
                    id: 3,
                    name: 'CARDIO-003: Heart Failure Management Initiative',
                    description: 'Comprehensive heart failure studies evaluating novel SGLT2 inhibitors, ARNI therapies, and device-based interventions. Focus on reduced ejection fraction and preserved ejection fraction populations.',
                    therapeuticArea: 'Cardiovascular',
                    sponsor: 'CardioVascular Innovations Ltd.',
                    createdDate: '2024-03-10',
                    status: 'Active',
                    scenarios: [],
                    totalScenarios: 25,
                    completedTrials: 8,
                    activeTrials: 17,
                    regulatoryPhase: 'Phase III/IV',
                    targetEnrollment: 3200,
                    estimatedCompletion: '2026-09-30',
                    primaryEndpoints: 'Cardiovascular death, heart failure hospitalization',
                    secondaryEndpoints: 'Exercise capacity, NT-proBNP levels'
                },
                {
                    id: 4,
                    name: 'RHEUM-004: Autoimmune Disease Portfolio',
                    description: 'Multi-therapeutic area program covering rheumatoid arthritis, psoriasis, lupus, and inflammatory bowel disease. Novel biologic therapies targeting IL-17, IL-23, and JAK pathways.',
                    therapeuticArea: 'Rheumatology',
                    sponsor: 'RheumaTech Pharmaceuticals',
                    createdDate: '2024-04-05',
                    status: 'Active',
                    scenarios: [],
                    totalScenarios: 20,
                    completedTrials: 5,
                    activeTrials: 15,
                    regulatoryPhase: 'Phase II/III',
                    targetEnrollment: 2100,
                    estimatedCompletion: '2027-03-31',
                    primaryEndpoints: 'ACR50 response, PASI75 achievement',
                    secondaryEndpoints: 'Safety, quality of life, radiographic progression'
                },
                {
                    id: 5,
                    name: 'RESP-005: Respiratory Disease Network',
                    description: 'Asthma, COPD, and idiopathic pulmonary fibrosis trials evaluating novel bronchodilators, anti-inflammatory agents, and anti-fibrotic therapies. Patient-reported outcomes and lung function measures.',
                    therapeuticArea: 'Respiratory',
                    sponsor: 'PulmoCare Research Group',
                    createdDate: '2024-05-12',
                    status: 'Active',
                    scenarios: [],
                    totalScenarios: 16,
                    completedTrials: 3,
                    activeTrials: 13,
                    regulatoryPhase: 'Phase II/III',
                    targetEnrollment: 1600,
                    estimatedCompletion: '2026-11-30',
                    primaryEndpoints: 'FEV1 improvement, exacerbation reduction',
                    secondaryEndpoints: 'Quality of life, rescue medication use'
                },
                {
                    id: 6,
                    name: 'ENDO-006: Diabetes & Metabolic Disorders',
                    description: 'Type 1 and Type 2 diabetes management trials including novel GLP-1 agonists, SGLT2 inhibitors, and combination therapies. Cardiovascular outcomes and renal protection studies.',
                    therapeuticArea: 'Endocrinology',
                    sponsor: 'Metabolic Health Solutions',
                    createdDate: '2024-06-18',
                    status: 'Active',
                    scenarios: [],
                    totalScenarios: 19,
                    completedTrials: 4,
                    activeTrials: 15,
                    regulatoryPhase: 'Phase III/IV',
                    targetEnrollment: 2800,
                    estimatedCompletion: '2027-08-31',
                    primaryEndpoints: 'HbA1c reduction, cardiovascular outcomes',
                    secondaryEndpoints: 'Weight loss, renal function, safety'
                },
                {
                    id: 7,
                    name: 'PSYCH-007: Mental Health Innovation Program',
                    description: 'Depression, anxiety, and schizophrenia trials evaluating novel antidepressants, anxiolytics, and antipsychotic agents. Digital therapeutics and precision medicine approaches.',
                    therapeuticArea: 'Psychiatry',
                    sponsor: 'MindWell Therapeutics',
                    createdDate: '2024-07-22',
                    status: 'Active',
                    scenarios: [],
                    totalScenarios: 14,
                    completedTrials: 2,
                    activeTrials: 12,
                    regulatoryPhase: 'Phase II/III',
                    targetEnrollment: 1200,
                    estimatedCompletion: '2026-12-31',
                    primaryEndpoints: 'Depression/anxiety scale improvements',
                    secondaryEndpoints: 'Remission rates, functional outcomes'
                },
                {
                    id: 8,
                    name: 'DERM-008: Dermatology Research Network',
                    description: 'Atopic dermatitis, psoriasis, and rare skin disorder trials. Novel topical and systemic therapies targeting inflammatory pathways and skin barrier function.',
                    therapeuticArea: 'Dermatology',
                    sponsor: 'DermInnovate Research',
                    createdDate: '2024-08-30',
                    status: 'Active',
                    scenarios: [],
                    totalScenarios: 17,
                    completedTrials: 3,
                    activeTrials: 14,
                    regulatoryPhase: 'Phase II/III',
                    targetEnrollment: 1400,
                    estimatedCompletion: '2027-01-31',
                    primaryEndpoints: 'EASI improvement, IGA response',
                    secondaryEndpoints: 'Quality of life, safety profile'
                },
                {
                    id: 9,
                    name: 'HEMA-009: Hematology & Blood Disorders',
                    description: 'Comprehensive hematology program covering leukemia, lymphoma, multiple myeloma, and rare blood disorders. Novel targeted therapies and CAR-T cell approaches.',
                    therapeuticArea: 'Hematology',
                    sponsor: 'HemaTech Solutions',
                    createdDate: '2024-09-15',
                    status: 'Planning',
                    scenarios: [],
                    totalScenarios: 15,
                    completedTrials: 0,
                    activeTrials: 8,
                    regulatoryPhase: 'Phase I/II',
                    targetEnrollment: 1200,
                    estimatedCompletion: '2027-12-31',
                    primaryEndpoints: 'Overall survival, progression-free survival',
                    secondaryEndpoints: 'Response rates, safety profile, quality of life'
                },
                {
                    id: 10,
                    name: 'GI-010: Gastrointestinal Disorders',
                    description: 'Inflammatory bowel disease, celiac disease, and functional GI disorder trials. Novel biologic therapies and microbiome-based interventions.',
                    therapeuticArea: 'Gastroenterology',
                    sponsor: 'GastroHealth Innovations',
                    createdDate: '2024-10-20',
                    status: 'On Hold',
                    scenarios: [],
                    totalScenarios: 12,
                    completedTrials: 1,
                    activeTrials: 6,
                    regulatoryPhase: 'Phase II/III',
                    targetEnrollment: 800,
                    estimatedCompletion: '2028-03-31',
                    primaryEndpoints: 'Clinical remission, endoscopic improvement',
                    secondaryEndpoints: 'Quality of life, safety, biomarker changes'
                },
                {
                    id: 11,
                    name: 'NEPH-011: Renal & Kidney Disease',
                    description: 'Chronic kidney disease, diabetic nephropathy, and rare kidney disorder trials. Novel renoprotective agents and dialysis innovations.',
                    therapeuticArea: 'Nephrology',
                    sponsor: 'RenalTech Pharmaceuticals',
                    createdDate: '2024-11-05',
                    status: 'Completed',
                    scenarios: [],
                    totalScenarios: 8,
                    completedTrials: 8,
                    activeTrials: 3,
                    regulatoryPhase: 'Phase IV',
                    targetEnrollment: 600,
                    estimatedCompletion: '2024-12-31',
                    primaryEndpoints: 'eGFR preservation, proteinuria reduction',
                    secondaryEndpoints: 'Cardiovascular outcomes, safety profile'
                },
                {
                    id: 12,
                    name: 'OPTH-012: Ophthalmology Research',
                    description: 'Age-related macular degeneration, diabetic retinopathy, and glaucoma trials. Novel anti-VEGF therapies and sustained-release formulations.',
                    therapeuticArea: 'Ophthalmology',
                    sponsor: 'Ocular Innovations Inc.',
                    createdDate: '2024-12-01',
                    status: 'Terminated',
                    scenarios: [],
                    totalScenarios: 6,
                    completedTrials: 2,
                    activeTrials: 4,
                    regulatoryPhase: 'Phase II',
                    targetEnrollment: 400,
                    estimatedCompletion: 'N/A',
                    primaryEndpoints: 'Visual acuity improvement, retinal thickness',
                    secondaryEndpoints: 'Quality of life, safety, treatment burden'
                },
                {
                    id: 13,
                    name: 'PEDI-013: Pediatric Research Network',
                    description: 'Comprehensive pediatric trials across multiple therapeutic areas including rare diseases, oncology, and developmental disorders. Age-appropriate formulations and safety monitoring.',
                    therapeuticArea: 'Pediatrics',
                    sponsor: 'Pediatric Innovations Corp.',
                    createdDate: '2024-01-20',
                    status: 'Active',
                    scenarios: [],
                    totalScenarios: 28,
                    completedTrials: 7,
                    activeTrials: 21,
                    regulatoryPhase: 'Phase I/II/III',
                    targetEnrollment: 3500,
                    estimatedCompletion: '2027-09-30',
                    primaryEndpoints: 'Safety, efficacy, pharmacokinetics',
                    secondaryEndpoints: 'Quality of life, growth parameters, biomarkers'
                },
                {
                    id: 14,
                    name: 'RARE-014: Rare Disease Consortium',
                    description: 'Multi-center collaboration for rare disease research including genetic disorders, metabolic diseases, and orphan drug development. Patient advocacy partnerships.',
                    therapeuticArea: 'Rare Diseases',
                    sponsor: 'Rare Disease Alliance',
                    createdDate: '2024-02-10',
                    status: 'Active',
                    scenarios: [],
                    totalScenarios: 35,
                    completedTrials: 12,
                    activeTrials: 23,
                    regulatoryPhase: 'Phase I/II/III',
                    targetEnrollment: 2800,
                    estimatedCompletion: '2028-06-30',
                    primaryEndpoints: 'Disease-specific outcomes, safety',
                    secondaryEndpoints: 'Quality of life, biomarker changes, natural history'
                },
                {
                    id: 15,
                    name: 'VACC-015: Vaccine Development Platform',
                    description: 'Next-generation vaccine technologies including mRNA, viral vector, and protein-based approaches. Pandemic preparedness and emerging infectious disease focus.',
                    therapeuticArea: 'Vaccinology',
                    sponsor: 'VaccineTech Solutions',
                    createdDate: '2024-03-15',
                    status: 'Active',
                    scenarios: [],
                    totalScenarios: 42,
                    completedTrials: 18,
                    activeTrials: 24,
                    regulatoryPhase: 'Phase I/II/III',
                    targetEnrollment: 5200,
                    estimatedCompletion: '2028-12-31',
                    primaryEndpoints: 'Immunogenicity, safety, efficacy',
                    secondaryEndpoints: 'Durability, cross-protection, safety profile'
                }
            ];
            setProjects(mockProjects);
        }
    }, []);

    // Link scenarios to projects after both are loaded - ensure one-to-many relationship
    useEffect(() => {
        if (projects.length > 0 && scenarios.length > 0) {
            // Check if projects already have scenarios linked to prevent infinite loop
            const hasScenariosLinked = projects.some(project => project.scenarios && project.scenarios.length > 0);
            if (hasScenariosLinked) return;
            
            // Each scenario belongs to exactly one project (no duplication)
            const updatedProjects = projects.map(project => ({
                ...project,
                scenarios: scenarios.filter(scenario => scenario.projectId === project.id)
            }));
            setProjects(updatedProjects);
            
            // Verify no scenario duplication
            const allScenarioIds = new Set();
            updatedProjects.forEach(project => {
                project.scenarios.forEach(scenario => {
                    allScenarioIds.add(scenario.id);
                });
            });
            
            if (allScenarioIds.size !== scenarios.length) {
                console.warn('Warning: Some scenarios may be duplicated across projects!');
            }
        }
    }, [scenarios, projects]);

    function generateSites(count, seedBase) {
        const rand = (seed) => () => (seed = (seed * 48271) % 2147483647) / 2147483647;
        
        // Production-grade data arrays
        const states = ['CA', 'TX', 'NY', 'MA', 'FL', 'IL', 'WA', 'NC', 'AZ', 'PA', 'OH', 'MI', 'GA', 'CO', 'MN', 'VA', 'WI', 'OR', 'TN', 'LA', 'AL', 'SC', 'KY', 'OK', 'IA', 'AR', 'MS', 'KS', 'WV', 'NE'];
        const cities = {
            'CA': ['Los Angeles', 'San Francisco', 'San Diego', 'Sacramento', 'San Jose'],
            'TX': ['Houston', 'Dallas', 'Austin', 'San Antonio', 'Fort Worth'],
            'NY': ['New York', 'Buffalo', 'Rochester', 'Syracuse', 'Albany'],
            'MA': ['Boston', 'Worcester', 'Springfield', 'Cambridge', 'Lowell'],
            'FL': ['Miami', 'Orlando', 'Tampa', 'Jacksonville', 'Fort Lauderdale'],
            'IL': ['Chicago', 'Springfield', 'Peoria', 'Rockford', 'Naperville'],
            'WA': ['Seattle', 'Spokane', 'Tacoma', 'Vancouver', 'Bellevue'],
            'NC': ['Charlotte', 'Raleigh', 'Greensboro', 'Durham', 'Winston-Salem'],
            'AZ': ['Phoenix', 'Tucson', 'Mesa', 'Scottsdale', 'Glendale'],
            'PA': ['Philadelphia', 'Pittsburgh', 'Allentown', 'Erie', 'Reading']
        };
        
        const pis = [
            'Dr. Laura Bennett, MD, PhD', 'Dr. Samuel Ortiz, DO', 'Dr. Naomi Park, MD', 
            'Dr. Hannah Wright, MD', 'Dr. Marco Rivera, MD', 'Dr. Ayesha Khan, MD', 
            'Dr. Ellen Moore, MD', 'Dr. Grace Lin, MD', 'Dr. Omar Haddad, MD', 
            'Dr. Robert King, MD', 'Dr. Sarah Johnson, MD, PhD', 'Dr. David Kim, MD',
            'Dr. Lisa Rodriguez, MD', 'Dr. James Wilson, MD, PhD', 'Dr. Anna Thompson, MD',
            'Dr. Michael Chen, MD', 'Dr. Jennifer Lee, MD', 'Dr. Christopher Brown, MD',
            'Dr. Amanda Davis, MD', 'Dr. Kevin Martinez, MD'
        ];
        
        const hospitalTypes = [
            'Medical Center', 'Research Hospital', 'Clinical Institute', 'Academic Health Center',
            'Research Group', 'Trials Center', 'Health Research Institute', 'Trials Unit',
            'Medical Research', 'Clinical Research Center', 'Academic Medical Center',
            'Research Medical Center', 'Clinical Trials Center', 'Academic Research Institute'
        ];
        
        const therapeuticAreas = [
            'Oncology', 'Cardiology', 'Neurology', 'Immunology', 'Endocrinology',
            'Respiratory', 'Dermatology', 'Psychiatry', 'Rheumatology', 'Gastroenterology',
            'Hematology', 'Nephrology', 'Ophthalmology', 'Orthopedics', 'Urology'
        ];
        
        const testingFacilities = [
            'Biochemistry', 'Hematology', 'Microbiology', 'Molecular Biology',
            'Flow Cytometry', 'Next-Generation Sequencing', 'Biomarker Analysis',
            'Immunoassays', 'PCR Testing', 'ELISA', 'Western Blot', 'Mass Spectrometry'
        ];
        
        const labCertifications = ['CAP', 'CLIA', 'CAP/CLIA', 'ISO 15189', 'JCI'];
        const irbTypes = ['On-site IRB', 'Central IRB', 'WIRB', 'Advarra', 'Copernicus Group'];
        const accreditations = ['AAHRPP', 'JCI', 'AAHRPP/JCI', 'ISO 9001', 'NCQA'];
        
        const out = [];
        let r = rand(seedBase);
        
        for (let i = 1; i <= count; i++) {
            const st = states[Math.floor(r() * states.length)];
            const city = cities[st] ? cities[st][Math.floor(r() * cities[st].length)] : `${st} City`;
            const pi = pis[Math.floor(r() * pis.length)];
            const hospitalType = hospitalTypes[Math.floor(r() * hospitalTypes.length)];
            
            // Generate realistic scores
            const matchScore = Math.floor(70 + r() * 25); // 70-95 range
            const compositeScore = Math.floor(matchScore - 3 - r() * 8); // Slightly lower than match score
            
            // Generate realistic operational data
            const pastTrials = Math.floor(8 + r() * 35); // 8-43 trials
            const enrollmentRate = `${Math.floor(5 + r() * 15)} pts/mo`; // 5-20 patients/month
            const retentionRate = `${Math.floor(82 + r() * 15)}%`; // 82-97%
            const timeToActivate = `${Math.floor(35 + r() * 45)} days`; // 35-80 days
            const queryTurnaround = `${Math.floor(24 + r() * 72)} hrs`; // 24-96 hours
            
            // Generate realistic infrastructure data
            const hospitalBeds = Math.floor(150 + r() * 850); // 150-1000 beds
            const crcCount = Math.floor(6 + r() * 25); // 6-31 CRC staff
            const onSiteLab = r() > 0.3 ? 'Yes' : (r() > 0.6 ? 'Partial' : 'No');
            const dedicatedTrialUnit = r() > 0.4 ? 'Yes' : 'No';
            
            // Generate realistic therapeutic areas (1-3 areas per site)
            const numTherapeuticAreas = Math.floor(1 + r() * 3);
            const siteTherapeuticAreas = [];
            for (let j = 0; j < numTherapeuticAreas; j++) {
                const area = therapeuticAreas[Math.floor(r() * therapeuticAreas.length)];
                if (!siteTherapeuticAreas.includes(area)) {
                    siteTherapeuticAreas.push(area);
                }
            }
            
            // Generate realistic testing facilities (1-4 facilities per site)
            const numTestingFacilities = Math.floor(1 + r() * 4);
            const siteTestingFacilities = [];
            for (let j = 0; j < numTestingFacilities; j++) {
                const facility = testingFacilities[Math.floor(r() * testingFacilities.length)];
                if (!siteTestingFacilities.includes(facility)) {
                    siteTestingFacilities.push(facility);
                }
            }
            
            // Generate realistic sample storage
            const sampleStorage = [];
            if (r() > 0.3) sampleStorage.push('-20¬∞C');
            if (r() > 0.6) sampleStorage.push('-80¬∞C');
            if (r() > 0.8) sampleStorage.push('LN2');
            
            // Generate realistic imaging capabilities
            const imaging = [];
            if (r() > 0.2) imaging.push('CT');
            if (r() > 0.5) imaging.push('MRI');
            if (r() > 0.7) imaging.push('PET-CT');
            if (r() > 0.8) imaging.push('Ultrasound');
            
            // Generate realistic site name
            const siteName = `${city} ${hospitalType}`;
            
            out.push({
                site: siteName,
                siteCode: `SITE-${i.toString().padStart(3, '0')}`,
                state: st,
                matchScore: matchScore,
                compositeScore: compositeScore,
                details: {
                    siteInfo: {
                        pi: pi,
                        address: `${Math.floor(100 + r() * 900)} ${['Main St', 'Oak Ave', 'Pine Rd', 'Elm St', 'Maple Dr'][Math.floor(r() * 5)]}, ${city}, ${st}`,
                        contact: `${pi.split(' ')[1].toLowerCase()}.${pi.split(' ')[0].toLowerCase()}@${siteName.toLowerCase().replace(/\s+/g, '')}.org`,
                        website: `${siteName.toLowerCase().replace(/\s+/g, '')}.org`,
                        subInvestigators: [`Dr. ${['A. Kim', 'R. Shah', 'V. Patel', 'L. Wong', 'J. Carter'][Math.floor(r() * 5)]}`, `Dr. ${['M. Johnson', 'S. Davis', 'K. Wilson', 'T. Brown', 'N. Garcia'][Math.floor(r() * 5)]}`],
                        regulatoryApprovals: 'FDA'
                    },
                    infrastructure: {
                        onSiteLab: onSiteLab,
                        labCertifications: labCertifications[Math.floor(r() * labCertifications.length)],
                        sampleStorage: sampleStorage,
                        pharmacy: 'Yes',
                        imaging: imaging,
                        emergencyCare: r() > 0.2 ? 'Yes' : 'Limited',
                        hospitalBeds: hospitalBeds,
                        dedicatedTrialUnit: dedicatedTrialUnit,
                        itInfrastructure: ['EPIC EMR', 'Cerner EMR', 'eSource', 'eConsent', 'EPIC + eSource'][Math.floor(r() * 5)]
                    },
                    clinicalCapabilities: {
                        therapeuticAreas: siteTherapeuticAreas,
                        testingFacilities: siteTestingFacilities,
                        patientAccess: ['Urban', 'Suburban', 'Regional', 'Metro catchment'][Math.floor(r() * 4)],
                        crcCount: crcCount,
                        gcpTrained: 'Yes',
                        languageSupport: ['English', 'English, Spanish', 'English, Spanish, French', 'English, Chinese', 'English, Korean'][Math.floor(r() * 5)]
                    },
                    operationalPerformance: {
                        pastTrials: pastTrials,
                        enrollmentRate: enrollmentRate,
                        retentionRate: retentionRate,
                        queryTurnaround: queryTurnaround,
                        deviationHistory: r() > 0.7 ? 'Low' : (r() > 0.4 ? 'Medium' : 'High'),
                        auditHistory: `${['FDA', 'Sponsor', 'EMA'][Math.floor(r() * 3)]} (${2020 + Math.floor(r() * 4)}) - ${r() > 0.8 ? 'Clean' : (r() > 0.6 ? 'Minor findings' : 'Major findings')}`,
                        aeReporting: 'Compliant',
                        timeToActivate: timeToActivate
                    },
                    qualityCompliance: {
                        sops: r() > 0.1 ? 'Yes' : 'Partial',
                        irb: irbTypes[Math.floor(r() * irbTypes.length)],
                        regulatorySubmissions: 'FDA',
                        dataProtection: 'HIPAA Compliant'
                    },
                    additionalNotes: {
                        affiliations: ['University Network', 'Academic Medical Center', 'Regional Health System', 'Independent Research Group'][Math.floor(r() * 4)],
                        accreditations: accreditations[Math.floor(r() * accreditations.length)],
                        publications: `${Math.floor(15 + r() * 200)} publications`,
                        recruitmentStrategies: ['EMR flags', 'Patient referrals', 'Community outreach', 'Social media', 'Patient registry', 'Physician network'][Math.floor(r() * 6)]
                    }
                }
            });
        }
        
        // Sort sites by match score (highest first), then by composite score (highest first)
        out.sort((a, b) => {
            if (b.matchScore !== a.matchScore) {
                return b.matchScore - a.matchScore;
            }
            return b.compositeScore - a.compositeScore;
        });
        
        // Add rank based on sorted position
        out.forEach((site, index) => {
            site.rank = index + 1;
        });
        
        return out;
    }

    // Removed old hardcoded siteRankingData - now generated dynamically for each scenario

    function generateScenarios(count) {
    
        const authors = [
            'Dr. Evelyn Reed, MD, PhD', 'Dr. Samuel Chen, MD', 'Dr. Maria Garcia, MD, PhD', 
            'Dr. Ben Carter, MD', 'Dr. Priya Natarajan, MD', 'Dr. Michael Lee, MD, PhD',
            'Dr. Sarah Johnson, MD', 'Dr. David Kim, MD', 'Dr. Lisa Rodriguez, MD',
            'Dr. James Wilson, MD, PhD', 'Dr. Anna Thompson, MD', 'Dr. Robert Davis, MD'
        ];
        const sponsors = [
            'NeuroGen Therapeutics Inc.', 'OncoImmune Solutions Corp.', 'CardioVascular Innovations Ltd.',
            'RheumaTech Pharmaceuticals', 'PulmoCare Research Group', 'Metabolic Health Solutions',
            'MindWell Therapeutics', 'DermInnovate Research', 'Global Pharma Solutions',
            'Innovative Therapeutics', 'Advanced Research Labs', 'Precision Medicine Corp.'
        ];
        const scenarios = [];
        
        // Project 1: Neurology - Alzheimer's Disease Treatment Program
        const neurologyTitles = [
            'NEURO-001-01: Amyloid Beta Clearance Therapy - Phase II',
            'NEURO-001-02: Tau Protein Inhibition - Phase III',
            'NEURO-001-03: Cognitive Enhancement Compound - Phase II',
            'NEURO-001-04: Neuroprotective Agent - Phase I',
            'NEURO-001-05: Memory Consolidation Therapy - Phase III',
            'NEURO-001-06: Synaptic Plasticity Enhancement - Phase II',
            'NEURO-001-07: Microglia Modulation - Phase I',
            'NEURO-001-08: Blood-Brain Barrier Transport - Phase II',
            'NEURO-001-09: Neuroinflammation Control - Phase III',
            'NEURO-001-10: Mitochondrial Function Support - Phase II',
            'NEURO-001-11: Cholinergic System Enhancement - Phase I',
            'NEURO-001-12: Glutamatergic Modulation - Phase III',
            'NEURO-001-13: Oxidative Stress Reduction - Phase II',
            'NEURO-001-14: Apoptosis Prevention - Phase I',
            'NEURO-001-15: Neural Stem Cell Activation - Phase II',
            'NEURO-001-16: Synaptic Density Restoration - Phase III',
            'NEURO-001-17: Cognitive Reserve Building - Phase II',
            'NEURO-001-18: Biomarker Validation Study - Phase I'
        ];
        
        // Project 2: Oncology - Solid Tumor Immunotherapy Platform
        const oncologyTitles = [
            'ONCO-002-01: NSCLC PD-1/PD-L1 Inhibition - Phase II',
            'ONCO-002-02: Melanoma Combination Therapy - Phase III',
            'ONCO-002-03: Renal Cell Carcinoma - Phase I',
            'ONCO-002-04: Triple-Negative Breast Cancer - Phase II',
            'ONCO-002-05: Head & Neck Cancer - Phase III',
            'ONCO-002-06: Bladder Cancer - Phase I',
            'ONCO-002-07: Gastric Cancer - Phase II',
            'ONCO-002-08: Esophageal Cancer - Phase III',
            'ONCO-002-09: Ovarian Cancer - Phase I',
            'ONCO-002-10: Pancreatic Cancer - Phase II',
            'ONCO-002-11: Colorectal Cancer - Phase III',
            'ONCO-002-12: Liver Cancer - Phase I',
            'ONCO-002-13: Brain Metastases - Phase II',
            'ONCO-002-14: Bone Metastases - Phase III',
            'ONCO-002-15: Lymph Node Metastases - Phase I',
            'ONCO-002-16: Circulating Tumor Cells - Phase II',
            'ONCO-002-17: Tumor Microenvironment - Phase III',
            'ONCO-002-18: Biomarker Discovery - Phase I',
            'ONCO-002-19: Resistance Mechanisms - Phase II',
            'ONCO-002-20: Combination Strategies - Phase III',
            'ONCO-002-21: Patient Selection - Phase I',
            'ONCO-002-22: Response Prediction - Phase II'
        ];
        
        // Project 3: Cardiovascular - Heart Failure Management Initiative
        const cardiovascularTitles = [
            'CARDIO-003-01: HFrEF SGLT2 Inhibition - Phase III',
            'CARDIO-003-02: HFpEF Therapy - Phase II',
            'CARDIO-003-03: ARNI Combination - Phase III',
            'CARDIO-003-04: Beta-Blocker Optimization - Phase IV',
            'CARDIO-003-05: Diuretic Management - Phase III',
            'CARDIO-003-06: Aldosterone Antagonism - Phase II',
            'CARDIO-003-07: Ivabradine Therapy - Phase III',
            'CARDIO-003-08: Digoxin Optimization - Phase IV',
            'CARDIO-003-09: Hydralazine-ISDN - Phase III',
            'CARDIO-003-10: Anticoagulation - Phase II',
            'CARDIO-003-11: Antiplatelet Therapy - Phase III',
            'CARDIO-003-12: Statin Therapy - Phase IV',
            'CARDIO-003-13: ACE Inhibition - Phase III',
            'CARDIO-003-14: ARB Therapy - Phase II',
            'CARDIO-003-15: Calcium Channel Blockade - Phase III',
            'CARDIO-003-16: Device Therapy - Phase II',
            'CARDIO-003-17: Cardiac Resynchronization - Phase III',
            'CARDIO-003-18: Implantable Defibrillator - Phase IV',
            'CARDIO-003-19: Ventricular Assist Device - Phase II',
            'CARDIO-003-20: Heart Transplantation - Phase III',
            'CARDIO-003-21: Exercise Training - Phase II',
            'CARDIO-003-22: Dietary Intervention - Phase III',
            'CARDIO-003-23: Telemonitoring - Phase II',
            'CARDIO-003-24: Remote Monitoring - Phase III',
            'CARDIO-003-25: Quality of Life - Phase IV'
        ];
        
        // Project 4: Rheumatology - Autoimmune Disease Portfolio
        const rheumatologyTitles = [
            'RHEUM-004-01: RA JAK Inhibition - Phase III',
            'RHEUM-004-02: Psoriasis IL-17 Blockade - Phase II',
            'RHEUM-004-03: Lupus B-Cell Depletion - Phase III',
            'RHEUM-004-04: IBD TNF Inhibition - Phase II',
            'RHEUM-004-05: Ankylosing Spondylitis - Phase III',
            'RHEUM-004-06: Psoriatic Arthritis - Phase II',
            'RHEUM-004-07: Sj√∂gren\'s Syndrome - Phase I',
            'RHEUM-004-08: Systemic Sclerosis - Phase II',
            'RHEUM-004-09: Vasculitis - Phase III',
            'RHEUM-004-10: Myositis - Phase II',
            'RHEUM-004-11: Scleroderma - Phase I',
            'RHEUM-004-12: Polymyalgia Rheumatica - Phase II',
            'RHEUM-004-13: Giant Cell Arteritis - Phase III',
            'RHEUM-004-14: Beh√ßet\'s Disease - Phase II',
            'RHEUM-004-15: Sarcoidosis - Phase I',
            'RHEUM-004-16: Mixed Connective Tissue - Phase II',
            'RHEUM-004-17: Overlap Syndromes - Phase III',
            'RHEUM-004-18: Juvenile Arthritis - Phase II',
            'RHEUM-004-19: Pediatric Lupus - Phase I',
            'RHEUM-004-20: Familial Mediterranean Fever - Phase II'
        ];
        
        // Project 5: Respiratory - Respiratory Disease Network
        const respiratoryTitles = [
            'RESP-005-01: Asthma LABA/LAMA - Phase III',
            'RESP-005-02: COPD Triple Therapy - Phase II',
            'RESP-005-03: IPF Anti-Fibrotic - Phase III',
            'RESP-005-04: Cystic Fibrosis - Phase II',
            'RESP-005-05: Bronchiectasis - Phase I',
            'RESP-005-06: Pulmonary Hypertension - Phase III',
            'RESP-005-07: Sleep Apnea - Phase II',
            'RESP-005-08: Lung Cancer Screening - Phase IV',
            'RESP-005-09: Tuberculosis - Phase II',
            'RESP-005-10: Pneumonia - Phase III',
            'RESP-005-11: Bronchiolitis - Phase I',
            'RESP-005-12: Emphysema - Phase II',
            'RESP-005-13: Pulmonary Embolism - Phase III',
            'RESP-005-14: Pleural Effusion - Phase II',
            'RESP-005-15: Pneumothorax - Phase I',
            'RESP-005-16: Mesothelioma - Phase II'
        ];
        
        // Project 6: Endocrinology - Diabetes & Metabolic Disorders
        const endocrinologyTitles = [
            'ENDO-006-01: T2DM GLP-1 Agonist - Phase III',
            'ENDO-006-02: T1DM Immunotherapy - Phase II',
            'ENDO-006-03: Obesity Management - Phase III',
            'ENDO-006-04: Metabolic Syndrome - Phase II',
            'ENDO-006-05: PCOS Treatment - Phase I',
            'ENDO-006-06: Thyroid Disorders - Phase III',
            'ENDO-006-07: Adrenal Insufficiency - Phase II',
            'ENDO-006-08: Pituitary Disorders - Phase I',
            'ENDO-006-09: Growth Hormone - Phase III',
            'ENDO-006-10: Calcium Metabolism - Phase II',
            'ENDO-006-11: Vitamin D Deficiency - Phase IV',
            'ENDO-006-12: Parathyroid Disorders - Phase II',
            'ENDO-006-13: Gonadal Disorders - Phase I',
            'ENDO-006-14: Reproductive Health - Phase II',
            'ENDO-006-15: Menopause Management - Phase III',
            'ENDO-006-16: Andropause Therapy - Phase II',
            'ENDO-006-17: Infertility Treatment - Phase I',
            'ENDO-006-18: Hormone Replacement - Phase III',
            'ENDO-006-19: Endocrine Cancer - Phase II'
        ];
        
        // Project 7: Psychiatry - Mental Health Innovation Program
        const psychiatryTitles = [
            'PSYCH-007-01: MDD Novel Antidepressant - Phase III',
            'PSYCH-007-02: GAD Anxiolytic - Phase II',
            'PSYCH-007-03: Schizophrenia Antipsychotic - Phase III',
            'PSYCH-007-04: Bipolar Disorder - Phase II',
            'PSYCH-007-05: PTSD Treatment - Phase I',
            'PSYCH-007-06: OCD Therapy - Phase II',
            'PSYCH-007-07: ADHD Management - Phase III',
            'PSYCH-007-08: Autism Spectrum - Phase I',
            'PSYCH-007-09: Eating Disorders - Phase II',
            'PSYCH-007-10: Substance Abuse - Phase III',
            'PSYCH-007-11: Insomnia Treatment - Phase II',
            'PSYCH-007-12: Sleep Disorders - Phase I',
            'PSYCH-007-13: Personality Disorders - Phase II',
            'PSYCH-007-14: Geriatric Depression - Phase III'
        ];
        
        // Project 8: Dermatology - Dermatology Research Network
        const dermatologyTitles = [
            'DERM-008-01: Atopic Dermatitis - Phase III',
            'DERM-008-02: Psoriasis Plaque - Phase II',
            'DERM-008-03: Acne Vulgaris - Phase III',
            'DERM-008-04: Rosacea Treatment - Phase II',
            'DERM-008-05: Vitiligo Therapy - Phase I',
            'DERM-008-06: Alopecia Areata - Phase II',
            'DERM-008-07: Urticaria Management - Phase III',
            'DERM-008-08: Eczema Treatment - Phase II',
            'DERM-008-09: Fungal Infections - Phase III',
            'DERM-008-10: Bacterial Infections - Phase II',
            'DERM-008-11: Viral Infections - Phase I',
            'DERM-008-12: Skin Cancer - Phase II',
            'DERM-008-13: Melanoma - Phase III',
            'DERM-008-14: Basal Cell Carcinoma - Phase II',
            'DERM-008-15: Squamous Cell Carcinoma - Phase III',
            'DERM-008-16: Rare Skin Disorders - Phase I',
            'DERM-008-17: Wound Healing - Phase II'
        ];
        
        // Project 9: Hematology - Blood Disorders
        const hematologyTitles = [
            'HEMA-009-01: AML Targeted Therapy - Phase II',
            'HEMA-009-02: CLL B-Cell Inhibition - Phase III',
            'HEMA-009-03: Multiple Myeloma - Phase II',
            'HEMA-009-04: Lymphoma CAR-T - Phase I',
            'HEMA-009-05: MDS Treatment - Phase II',
            'HEMA-009-06: Aplastic Anemia - Phase III',
            'HEMA-009-07: Hemophilia Gene Therapy - Phase I',
            'HEMA-009-08: Sickle Cell Disease - Phase II',
            'HEMA-009-09: Thalassemia - Phase III',
            'HEMA-009-10: ITP Management - Phase II',
            'HEMA-009-11: TTP Treatment - Phase I',
            'HEMA-009-12: Myelofibrosis - Phase II',
            'HEMA-009-13: Polycythemia Vera - Phase III',
            'HEMA-009-14: Essential Thrombocythemia - Phase II',
            'HEMA-009-15: Rare Blood Disorders - Phase I'
        ];
        
        // Project 10: Gastroenterology - GI Disorders
        const gastroenterologyTitles = [
            'GI-010-01: Crohn\'s Disease - Phase III',
            'GI-010-02: Ulcerative Colitis - Phase II',
            'GI-010-03: Celiac Disease - Phase I',
            'GI-010-04: IBS Management - Phase III',
            'GI-010-05: GERD Treatment - Phase II',
            'GI-010-06: Peptic Ulcer - Phase III',
            'GI-010-07: Gastroparesis - Phase II',
            'GI-010-08: Eosinophilic Esophagitis - Phase I',
            'GI-010-09: Microscopic Colitis - Phase II',
            'GI-010-10: Diverticulitis - Phase III',
            'GI-010-11: Pancreatitis - Phase II',
            'GI-010-12: Liver Disease - Phase I'
        ];
        
        // Project 11: Nephrology - Renal & Kidney Disease
        const nephrologyTitles = [
            'NEPH-011-01: CKD Management - Phase IV',
            'NEPH-011-02: Diabetic Nephropathy - Phase III',
            'NEPH-011-03: IgA Nephropathy - Phase II',
            'NEPH-011-04: Focal Segmental - Phase III',
            'NEPH-011-05: Membranous Nephropathy - Phase II',
            'NEPH-011-06: Minimal Change - Phase III',
            'NEPH-011-07: Lupus Nephritis - Phase II',
            'NEPH-011-08: ANCA Vasculitis - Phase III'
        ];
        
        // Project 12: Ophthalmology - Eye Disease Research
        const ophthalmologyTitles = [
            'OPTH-012-01: AMD Treatment - Phase II',
            'OPTH-012-02: Diabetic Retinopathy - Phase III',
            'OPTH-012-03: Glaucoma Management - Phase II',
            'OPTH-012-04: Retinal Vein Occlusion - Phase I',
            'OPTH-012-05: Uveitis Therapy - Phase II',
            'OPTH-012-06: Dry Eye Syndrome - Phase III'
        ];
        
        let scenarioId = 1;
        
        // Generate scenarios for each project
        for (let projectId = 1; projectId <= 12; projectId++) {
            let titles, indication, drugInfo, objective, sponsor;
            
            switch (projectId) {
                case 1: // Neurology
                    titles = neurologyTitles;
                    indication = 'Alzheimer\'s Disease and Neurodegenerative Disorders';
                    drugInfo = 'Novel Amyloid Beta and Tau Protein Modulators';
                    objective = 'Evaluate safety and efficacy of novel neurological compounds in early-stage Alzheimer\'s disease patients';
                    sponsor = 'NeuroGen Therapeutics Inc.';
                    break;
                case 2: // Oncology
                    titles = oncologyTitles;
                    indication = 'Advanced Solid Tumors and Hematological Malignancies';
                    drugInfo = 'PD-1/PD-L1 Pathway Inhibitors and Combination Therapies';
                    objective = 'Assess safety and efficacy of immunotherapy approaches in advanced cancer patients';
                    sponsor = 'OncoImmune Solutions Corp.';
                    break;
                case 3: // Cardiovascular
                    titles = cardiovascularTitles;
                    indication = 'Heart Failure and Cardiovascular Disease Management';
                    drugInfo = 'SGLT2 Inhibitors, ARNI Therapies, and Device Interventions';
                    objective = 'Evaluate novel therapeutic approaches for heart failure management';
                    sponsor = 'CardioVascular Innovations Ltd.';
                    break;
                case 4: // Rheumatology
                    titles = rheumatologyTitles;
                    indication = 'Autoimmune and Inflammatory Rheumatic Diseases';
                    drugInfo = 'JAK Inhibitors, IL-17/IL-23 Blockers, and B-Cell Therapies';
                    objective = 'Assess novel biologic therapies for autoimmune disease management';
                    sponsor = 'RheumaTech Pharmaceuticals';
                    break;
                case 5: // Respiratory
                    titles = respiratoryTitles;
                    indication = 'Chronic Respiratory Diseases and Pulmonary Disorders';
                    drugInfo = 'Novel Bronchodilators, Anti-Inflammatory Agents, and Anti-Fibrotic Therapies';
                    objective = 'Evaluate respiratory therapies for chronic disease management';
                    sponsor = 'PulmoCare Research Group';
                    break;
                case 6: // Endocrinology
                    titles = endocrinologyTitles;
                    indication = 'Diabetes, Metabolic Disorders, and Endocrine Diseases';
                    drugInfo = 'GLP-1 Agonists, SGLT2 Inhibitors, and Novel Metabolic Modulators';
                    objective = 'Assess novel therapeutic approaches for metabolic disease management';
                    sponsor = 'Metabolic Health Solutions';
                    break;
                case 7: // Psychiatry
                    titles = psychiatryTitles;
                    indication = 'Mental Health Disorders and Neuropsychiatric Conditions';
                    drugInfo = 'Novel Antidepressants, Anxiolytics, and Antipsychotic Agents';
                    objective = 'Evaluate novel psychiatric therapies for mental health management';
                    sponsor = 'MindWell Therapeutics';
                    break;
                                 case 8: // Dermatology
                     titles = dermatologyTitles;
                     indication = 'Inflammatory Skin Disorders and Dermatological Conditions';
                     drugInfo = 'Novel Topical and Systemic Therapies for Skin Disease Management';
                     objective = 'Assess novel dermatological therapies for inflammatory skin conditions';
                     sponsor = 'DermInnovate Research';
                     break;
                 case 9: // Hematology
                     titles = hematologyTitles;
                     indication = 'Hematological Malignancies and Blood Disorders';
                     drugInfo = 'Novel Targeted Therapies and CAR-T Cell Approaches';
                     objective = 'Evaluate novel therapeutic approaches for blood disorder management';
                     sponsor = 'HemaTech Solutions';
                     break;
                 case 10: // Gastroenterology
                     titles = gastroenterologyTitles;
                     indication = 'Inflammatory Bowel Disease and Functional GI Disorders';
                     drugInfo = 'Novel Biologic Therapies and Microbiome-Based Interventions';
                     objective = 'Assess novel therapeutic approaches for gastrointestinal disease management';
                     sponsor = 'GastroHealth Innovations';
                     break;
                 case 11: // Nephrology
                     titles = nephrologyTitles;
                     indication = 'Chronic Kidney Disease and Renal Disorders';
                     drugInfo = 'Novel Renoprotective Agents and Dialysis Innovations';
                     objective = 'Evaluate novel therapeutic approaches for kidney disease management';
                     sponsor = 'RenalTech Pharmaceuticals';
                     break;
                 case 12: // Ophthalmology
                     titles = ophthalmologyTitles;
                     indication = 'Age-Related Eye Diseases and Retinal Disorders';
                     drugInfo = 'Novel Anti-VEGF Therapies and Sustained-Release Formulations';
                     objective = 'Assess novel therapeutic approaches for ophthalmological disease management';
                     sponsor = 'Ocular Innovations Inc.';
                     break;
            }
            
            // Generate scenarios for this project
            for (let i = 0; i < titles.length; i++) {
                const title = titles[i];
                const phase = title.includes('Phase') ? title.match(/Phase [IV]+/)[0] : ['Phase I', 'Phase II', 'Phase III', 'Phase IV'][i % 4];
                const targetSubjects = [120, 240, 480, 960, 1200, 1800, 2400, 3200][i % 8];
                const timeline = [12, 18, 24, 36, 48, 60][i % 6];
                
                                 scenarios.push({
                     id: scenarioId++,
                     projectId: projectId,
                     title: title,
                     performedBy: authors[i % authors.length],
                     createdDate: new Date(2024, (i % 12), 1 + (i % 28)).toISOString(),
                     phase: phase,
                     targetSubjects: targetSubjects,
                     timeline: timeline,
                     isPinned: i % 11 === 0,
                     isArchived: i % 17 === 0,
                     indication: indication,
                     drugInfo: drugInfo,
                     startDate: new Date(2024, (i % 12), 15).toISOString().slice(0,10),
                     objective: objective,
                     sponsor: sponsor,
                     studyId: `PRO${String(scenarioId-1).padStart(4,'0')}`,
                     preferredRegions: ['North America', 'Europe', 'Asia'].slice(0, 1 + (i % 3)),
                     protocolDetails: `Comprehensive clinical trial protocol for ${title} including patient recruitment, treatment administration, safety monitoring, and efficacy assessment.`,
                     criteriaWeights: {
                         patientAvailability: 60 + (i % 20),
                         enrollmentRate: 70 + (i % 20),
                         startupSpeed: 50 + (i % 30),
                         piMatch: 60 + (i % 30),
                         competition: 30 + (i % 50)
                     },
                     // Generate sites for each scenario
                     siteRankings: generateSites(25, scenarioId)
                 });
             }
         }
        return scenarios;
    }

    // Initialize scenarios data (only runs once on mount)
    useEffect(() => {
        // Generate initial scenarios if none exist
        if (scenarios.length === 0) {
            const initialScenarios = generateScenarios(50);
            setScenarios(initialScenarios);
    
        }
    }, []);



    // --- Session Management Functions ---
    const setSession = (page, data = null) => {
        const sessionData = {
            page,
            data,
            timestamp: Date.now(),
            expiresAt: Date.now() + (24 * 60 * 60 * 1000) // 24 hours from now
        };

        localStorage.setItem('session', JSON.stringify(sessionData));
        localStorage.setItem('currentPage', page);
    };

    const getSession = () => {
        const sessionStr = localStorage.getItem('session');
        if (!sessionStr) {
            return null;
        }
        
        try {
            const session = JSON.parse(sessionStr);
            const now = Date.now();
            
            // Check if session has expired
            if (now > session.expiresAt) {
                localStorage.removeItem('session');
                return null;
            }
            
            // Extend session if it's close to expiring (within 2 hours)
            if (session.expiresAt - now < (2 * 60 * 60 * 1000)) {
                const extendedSession = {
                    ...session,
                    expiresAt: Date.now() + (24 * 60 * 60 * 1000) // Extend to 24 hours
                };
                localStorage.setItem('session', JSON.stringify(extendedSession));
                return extendedSession;
            }
            
            return session;
        } catch (error) {
            console.error('Error parsing session:', error);
            localStorage.removeItem('session');
            return null;
        }
    };

    const clearSession = () => {
        localStorage.removeItem('session');
        localStorage.removeItem('currentPage');
    };

    const isSessionValid = () => {
        const session = getSession();
        return session !== null;
    };

    // --- Functions ---
    const handleLogin = (credentials) => {
        // Simple login validation
        if (credentials.email === 'jeremy@gmail.com' && credentials.password === 'Kj9mP2xQ') {
            setCurrentPage('projects');
            setSession('projects');
        } else {
            // Invalid credentials handled silently - user can see the error state
        }
    };

    const handleChatSubmit = async (query) => {
        const userMessage = { sender: 'user', text: query };
        setChatMessages(prev => [...prev, userMessage]);
        setIsChatLoading(true);

        try {
            // Simple AI response simulation
            const responses = [
                "Based on your clinical trial data, I can see that the top-ranked sites have excellent patient availability and enrollment rates. Would you like me to analyze specific aspects of these results?",
                "I notice your criteria weights are well-balanced. The patient availability and PI match scores are particularly strong for the top sites. What specific insights are you looking for?",
                "Your scenario shows promising site matches. The top 3 sites all have >90% match scores, which is excellent. How can I help you dive deeper into these results?",
                "Looking at your trial parameters, the sites with the highest composite scores also show strong historical performance. Would you like me to explain the ranking methodology?"
            ];
            
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            
            setTimeout(() => {
                const botMessage = { sender: 'bot', text: randomResponse };
                setChatMessages(prev => [...prev, botMessage]);
                setIsChatLoading(false);
            }, 1000);
        } catch (error) {
            console.error("Error with chat:", error);
            const errorMessage = { sender: 'bot', text: "Sorry, I'm having trouble processing that right now. Please try again." };
            setChatMessages(prev => [...prev, errorMessage]);
            setIsChatLoading(false);
        }
    };

    const handleSaveScenario = (scenario) => {
        const newScenario = {
            ...scenario,
            id: Date.now(),
            isPinned: false,
            isArchived: false,
            createdDate: new Date().toISOString(),
            // Preserve siteRankings data
            siteRankings: scenario.siteRankings || []
        };
        setScenarios(prev => [newScenario, ...prev]);
        setCurrentPage('scenarios');
        setSession('scenarios');
    };

    const handleSaveProject = (project) => {
        const newProject = {
            ...project,
            id: 'project_' + Date.now(),
            createdAt: new Date().toISOString(),
            scenarios: []
        };
        setProjects(prev => [newProject, ...prev]);
        setCurrentPage('projects');
        setSession('projects');
    };

    // --- Effects ---
    // Session restoration is now handled in the dedicated useEffect below

    // Initialize chat messages when scenario changes
    useEffect(() => {
        if (currentScenario?.siteRankings?.[0] && chatMessages.length === 0) {
            setChatMessages([{ 
                sender: 'bot', 
                text: `Welcome! I can see your scenario "${currentScenario.title}" has ${currentScenario.siteRankings.length} sites. The top-ranked site is ${currentScenario.siteRankings[0].site} with a ${currentScenario.siteRankings[0].matchScore}% match score. How can I help you analyze these results?` 
            }]);
        }
    }, [currentScenario, chatMessages.length]);

    // Handle click outside profile dropdown
    useEffect(() => {
        const handleClickOutside = (event) => {
            if (isOpen && !event.target.closest('.profile-dropdown')) {
                setIsOpen(false);
            }
        };

        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, [isOpen]);

    useEffect(() => {
        // Load external scripts for PDF export
        const jspdfScript = document.createElement('script');
        jspdfScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        jspdfScript.async = true;
        document.body.appendChild(jspdfScript);

        const html2canvasScript = document.createElement('script');
        html2canvasScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
        html2canvasScript.async = true;
        document.body.appendChild(html2canvasScript);

        return () => {
            document.body.removeChild(jspdfScript);
            document.body.removeChild(html2canvasScript);
        };
    }, []);

    // Scroll to top when page changes
    useEffect(() => {
        // Use setTimeout to ensure the page has fully rendered before scrolling
        const timer = setTimeout(() => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 100);
        
        // Clear navigation flag after page change
        localStorage.removeItem('isNavigating');
        
        return () => clearTimeout(timer);
    }, [currentPage]);

    // Handle page restoration on refresh
    useEffect(() => {
        // Prevent multiple executions
        if (!isLoading) return;
        
        // Always redirect to projects page on reload for better UX
        setCurrentPage('projects');
        
        // Clear any previous session data to start fresh
        setCurrentProject(null);
        setCurrentScenario(null);
        setCurrentSite(null);
        setComparisonScenarios(null);
        
        // Clear session data from localStorage
        localStorage.removeItem('session');
        localStorage.removeItem('pageData');
        localStorage.removeItem('currentPage');
        
        // Set loading to false after redirect
        setIsLoading(false);
    }, []); // Only run once on mount

    // Session refresh mechanism - extend session on user activity
    useEffect(() => {
        const handleUserActivity = () => {
            const session = getSession();
            if (session && session.page !== 'login') {
                // Extend session by 24 hours from current activity
                const extendedSession = {
                    ...session,
                    expiresAt: Date.now() + (24 * 60 * 60 * 1000) // 24 hours
                };
                localStorage.setItem('session', JSON.stringify(extendedSession));
            }
        };

        // Listen for user activity events (throttled to avoid excessive calls)
        let timeoutId;
        const throttledHandler = () => {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(handleUserActivity, 5000); // Only extend every 5 seconds
        };

        const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
        events.forEach(event => {
            document.addEventListener(event, throttledHandler, { passive: true });
        });

        return () => {
            clearTimeout(timeoutId);
            events.forEach(event => {
                document.removeEventListener(event, throttledHandler);
            });
        };
    }, []);



    // --- Navigation and Data Handling ---
    const navigateTo = (page, data = null) => {
        // Set navigation flag to prevent interference
        localStorage.setItem('isNavigating', 'true');
        
        if (page === 'results') {
            // Ensure the scenario always has an ID
            const scenarioWithId = {
                ...data,
                id: data.id || Date.now()
            };
            setCurrentScenario(scenarioWithId);
            // Save data to localStorage for refresh persistence
            localStorage.setItem('pageData', JSON.stringify({ results: [scenarioWithId] }));
                } else if (page === 'comparison') {
            setComparisonScenarios(data);
            localStorage.setItem('pageData', JSON.stringify({ comparison: data }));
        } else if (page === 'siteDetail') {
            setCurrentSite(data);
            localStorage.setItem('pageData', JSON.stringify({ 
                siteDetail: [data], 
                currentScenario: currentScenario 
            }));
        } else if (page === 'scenarios') {
            // Scenarios page always requires a project - redirect to projects if none provided
            if (!data) {
                navigateTo('projects');
                return;
            }
            setCurrentProject(data);
            localStorage.setItem('pageData', JSON.stringify({ page: 'scenarios', project: data }));
        } else if (page === 'create') {
            // For create page, just save the page info
            localStorage.setItem('pageData', JSON.stringify({ page: 'create' }));
        } else if (page === 'createProject') {
            // For createProject page, just save the page info
            localStorage.setItem('pageData', JSON.stringify({ page: 'createProject' }));
        }
        
        setCurrentPage(page);
        localStorage.setItem('currentPage', page);
        
        // Update session with current page and data
        setSession(page, data);
        
        // Get base path for current environment
        const basePath = getBasePath();
        
        // Update URL for proper routing with data
        let url;
        if (page === 'scenarios') {
            // Scenarios always require a project - use project ID in URL
            if (data && data.id) {
                url = `${basePath}/scenarios/${data.id}`;
            } else {
                // This shouldn't happen now, but fallback to projects
                url = `${basePath}/projects`;
            }
        } else if (page === 'results' && data) {
            const scenarioId = data.id || Date.now(); // Ensure we always have an ID
            url = `${basePath}/results/${scenarioId}`;
        } else if (page === 'siteDetail' && data) {
            url = `${basePath}/site/${data.siteCode}`;
        } else if (page === 'comparison' && data) {
            url = `${basePath}/comparison`;
        } else if (page === 'create') {
            url = `${basePath}/create`;
        } else if (page === 'createProject') {
            url = `${basePath}/create-project`;
        } else {
            url = `${basePath}/${page}`;
        }
        window.history.pushState({ page, data }, '', url);
    };

    // Function to restore data from URL
    const restoreDataFromURL = () => {
        const path = window.location.pathname;
        const pathParts = path.split('/').filter(Boolean);
        
        // Always redirect to projects on reload for better UX
        if (pathParts.length === 0 || pathParts[pathParts.length - 1] === 'index.html') {
            // Root path or index.html - redirect to projects
            setCurrentPage('projects');
            return;
        }
        
                    // Handle routing based on environment
            let page, scenarioId, siteCode, projectId;
            
            if (window.location.hostname === 'aakashpandya.github.io') {
                // GitHub Pages structure: /clinical-research-site-finder/page
                if (pathParts[0] === 'clinical-research-site-finder') {
                    if (pathParts.length === 1) {
                        // Just /clinical-research-site-finder/ - show login
                        setCurrentPage('login');
                        return;
                    }
                    // Extract the actual page from the second part
                    page = pathParts[1];
                    if (page === 'results' && pathParts.length > 2) {
                        scenarioId = parseInt(pathParts[2]); // Third part
                    } else if (page === 'site' && pathParts.length > 2) {
                        siteCode = pathParts[2]; // Third part
                    } else if (page === 'scenarios' && pathParts.length > 2) {
                        // Handle project-specific scenario URLs: /scenarios/1 (treat like project details)
                        projectId = parseInt(pathParts[2]);
                    }
                }
            } else {
                // Local development structure: /page
                page = pathParts[0];
                if (page === 'results' && pathParts.length > 1) {
                    scenarioId = parseInt(pathParts[1]); // Second part
                } else if (page === 'site' && pathParts.length > 1) {
                    siteCode = pathParts[1]; // Second part
                } else if (page === 'scenarios' && pathParts.length > 1) {
                    // Handle project-specific scenario URLs: /scenarios/1 (treat like project details)
                    projectId = parseInt(pathParts[1]);
                }
            }
        

        
        if (!page) {
            setCurrentPage('login');
            return;
        }
        
        const savedData = localStorage.getItem('pageData');
        let parsedData = null;
        
        try {
            if (savedData) {
                parsedData = JSON.parse(savedData);
            }
        } catch (e) {
            console.error('Failed to parse saved data:', e);
        }

        if (page === 'scenarios') {
            // Scenarios page requires a project - check if we have a project ID in the URL
            if (projectId) {
                const project = projects.find(p => p.id === projectId);
                if (project) {
                    setCurrentProject(project);
                    setCurrentPage('scenarios');
                    localStorage.setItem('currentPage', 'scenarios');
                } else {
                    // Project not found, redirect to projects
                    setCurrentPage('projects');
                    localStorage.setItem('currentPage', 'projects');
                }
            } else {
                // No project ID in URL, redirect to projects
                setCurrentPage('projects');
                localStorage.setItem('currentPage', 'projects');
            }
            return;
        }
        
        if (page === 'create') {
            setCurrentPage('create');
            localStorage.setItem('currentPage', 'create');
            return;
        }
        
        if (page === 'create-project') {
            setCurrentPage('createProject');
            localStorage.setItem('currentPage', 'createProject');
            return;
        }
        
        if (page === 'results' && scenarioId) {
            if (parsedData?.results) {
                const scenario = parsedData.results.find(s => s.id === scenarioId);
                if (scenario) {
                    setCurrentScenario(scenario);
                    setCurrentPage('results');
                    localStorage.setItem('currentPage', 'results');
                    return;
                }
            }
        }
        
        if (page === 'site' && siteCode) {
            if (parsedData?.siteDetail) {
                const site = parsedData.siteDetail.find(s => s.siteCode === siteCode);
                if (site) {
                    setCurrentSite(site);
                    if (parsedData.currentScenario) {
                        setCurrentScenario(parsedData.currentScenario);
                    }
                    setCurrentPage('siteDetail');
                    localStorage.setItem('currentPage', 'siteDetail');
                    return;
                }
            }
        }
        
        if (page === 'comparison' && parsedData?.comparison) {
            console.log('Setting page to comparison with data:', parsedData.comparison);
            console.log('Parsed comparison data type:', typeof parsedData.comparison);
            console.log('Parsed comparison data length:', parsedData.comparison ? parsedData.comparison.length : 'undefined');
            console.log('Parsed comparison data keys:', Object.keys(parsedData.comparison[0] || {}));
            console.log('Parsed comparison data first item:', parsedData.comparison[0]);
            console.log('Setting comparison scenarios state to:', parsedData.comparison);
            setComparisonScenarios(parsedData.comparison);
            setCurrentPage('comparison');
            localStorage.setItem('currentPage', 'comparison');
            console.log('Comparison page navigation completed');
            return;
        }
        
        // If no data found or invalid route, show login page instead of redirecting
        setCurrentPage('login');
        localStorage.setItem('currentPage', 'login');
        
        // Don't show alert for unknown routes - just show login
        // setTimeout(() => {
        //     alert('The requested page data was not found. Redirecting to scenarios.');
        // }, 100);
    };
    
    // --- Page Components ---
    const renderPage = () => {
        if (isLoading) {
            return <div className="flex items-center justify-center h-screen"><LoadingSpinner className="w-12 h-12 text-blue-600" /></div>;
        }
        
        switch (currentPage) {
            case 'login':
                return <LoginPage onLogin={handleLogin} />;
            case 'projects':
                return <ProjectsPage projects={projects} setProjects={setProjects} navigateTo={navigateTo} />;
            case 'scenarios':
                return <ScenariosListPage scenarios={scenarios} setScenarios={setScenarios} navigateTo={navigateTo} currentProject={currentProject} setCurrentProject={setCurrentProject} />;
            case 'create':
                return <CreateScenarioPage navigateTo={navigateTo} onSave={handleSaveScenario} siteRankingData={generateSites(25, Date.now())} />;
            case 'createProject':
                return <CreateProjectPage navigateTo={navigateTo} onSave={handleSaveProject} />;
            case 'results':
                return currentScenario ? <ResultsPage scenario={currentScenario} navigateTo={navigateTo} onSave={handleSaveScenario} chatMessages={chatMessages} isChatLoading={isChatLoading} onSubmitChat={handleChatSubmit} currentProject={currentProject} /> : null;
            case 'comparison':
                return <ComparisonPage scenarios={comparisonScenarios || []} navigateTo={navigateTo} projects={projects} currentProject={currentProject} />;
            case 'siteDetail':
                return currentSite ? <SiteDetailPage site={currentSite} scenario={currentScenario} navigateTo={navigateTo} currentProject={currentProject} /> : null;
            case 'siteComparison':
                return <SiteComparisonPage navigateTo={navigateTo} />;
            default:
                return <LoginPage onLogin={handleLogin} />;
        }
    };



    return (
        <div className={`min-h-screen ${currentPage === 'login' ? 'bg-gray-100' : 'bg-gray-50'}`}>
            {/* Header */}
            {currentPage !== 'login' && (
                <header className="top-nav relative">
                    <div className="flex items-center justify-between h-16 w-full px-4 sm:px-6 lg:px-8">
                        {/* Left side - Logo and Navigation */}
                        <div className="flex items-center gap-6">
                            {/* Mobile menu button */}
                            <button
                                onClick={() => setSidebarOpen(!sidebarOpen)}
                                className="md:hidden p-2 rounded-md text-white/80 hover:text-white hover:bg-white/10"
                            >
                                <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
                                </svg>
                            </button>
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 bg-white rounded-lg flex items-center justify-center">
                                    <svg className="w-5 h-5 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                                    </svg>
                                </div>
                                <h2 className="text-xl font-bold text-white">CRSFinder</h2>
                            </div>
                            
                            {/* Navigation Items */}
                            <nav className="hidden md:flex items-center gap-2">
                                <button
                                    onClick={() => navigateTo('projects')}
                                    className={`nav-item px-4 py-2 text-sm font-medium text-white transition-all ${
                                        currentPage === 'projects' ? 'active' : ''
                                    }`}
                                >
                                    <div className="flex items-center gap-2">
                                        <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2H5a2 2 0 00-2 2v2m14 0V5a2 2 0 00-2-2H5a2 2 0 00-2 2v2" />
                                        </svg>
                                        Projects
                                    </div>
                                </button>

                                <button
                                    onClick={() => navigateTo('create')}
                                    className={`nav-item px-4 py-2 text-sm font-medium text-white transition-all ${
                                        currentPage === 'create' || currentPage === 'createProject' ? 'active' : ''
                                    }`}
                                >
                                    <div className="flex items-center gap-2">
                                        <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                        </svg>
                                        Create
                                    </div>
                                </button>
                            </nav>
                        </div>
                        
                        {/* Right side - Project dropdown and Profile */}
                        <div className="flex items-center gap-3">
                            {/* Project Dropdown */}
                            {currentPage !== 'projects' && projects.length > 0 && (
                                <div className="hidden md:block">
                                    <ModernDropdown
                                        options={[
                                            { value: '', label: 'Select Project' },
                                            ...projects.map(project => ({
                                                value: project.id,
                                                label: `${project.name} (${project.therapeuticArea})`,
                                                subtitle: `${project.sponsor} ‚Ä¢ ${project.status}`
                                            }))
                                        ]}
                                        selected={currentProject?.id || ''}
                                        onSelect={(projectId) => {
                                            if (projectId) {
                                                const selectedProject = projects.find(p => p.id === projectId);
                                                if (selectedProject) {
                                                    setCurrentProject(selectedProject);
                                                    // Clear any existing comparison selection when switching projects
                                                    setComparisonScenarios(null);
                                                    // Navigate to scenarios with the new project
                                                    navigateTo('scenarios', selectedProject);
                                                }
                                            } else {
                                                // If no project selected, clear current project and go to projects page
                                                setCurrentProject(null);
                                                setComparisonScenarios(null);
                                                navigateTo('projects');
                                            }
                                        }}
                                        placeholder="Select Project"
                                    />
                                </div>
                            )}
                            
                            <div className="relative profile-dropdown">
                                <button 
                                    onClick={() => setIsOpen(!isOpen)}
                                    className="flex items-center gap-3 text-left hover:bg-white/10 rounded-md p-2 transition-colors"
                                >
                                    <div className="hidden sm:block text-right">
                                        <div className="text-sm font-medium text-white">Dr. Sarah Chen</div>
                                        <div className="text-xs text-white/80">Principal Investigator</div>
                                    </div>
                                    <svg className="h-5 w-5 text-white/80 hover:text-white flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                </button>
                                {isOpen && (
                                    <div className="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 profile-dropdown-menu">
                                        <div className="px-4 py-2 border-b border-gray-100">
                                            <div className="text-sm font-medium text-gray-900">Dr. Sarah Chen</div>
                                            <div className="text-xs text-gray-500">sarah.chen@research.org</div>
                                        </div>
                                        <button className="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                            Profile Settings
                                        </button>
                                        <button className="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                            Account Preferences
                                        </button>
                                        <div className="border-t border-gray-100"></div>
                                        <button 
                                            onClick={() => {
                                                setCurrentPage('login');
                                                clearSession();
                                                setSidebarOpen(false);
                                            }}
                                            className="flex items-center w-full px-2 py-2 text-sm font-medium text-red-600 rounded-md hover:bg-red-50 hover:text-red-700 transition-colors"
                                        >
                                            <svg className="mr-3 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                            </svg>
                                            Logout
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </header>
            )}

            {/* Mobile Navigation Menu */}
            {currentPage !== 'login' && sidebarOpen && (
                <div className="md:hidden fixed inset-0 bg-gray-600 bg-opacity-75 z-40">
                    <div className="fixed inset-y-0 left-0 w-64 bg-white shadow-lg">
                        <div className="flex items-center justify-between p-4 border-b border-gray-200">
                            <h2 className="text-lg font-bold text-gray-900">CRSFinder</h2>
                            <button
                                onClick={() => setSidebarOpen(false)}
                                className="p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100"
                            >
                                <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                                                <nav className="p-4 space-y-2">
                            <button
                                onClick={() => {
                                    navigateTo('projects');
                                    setSidebarOpen(false);
                                }}
                                className={`w-full flex items-center px-3 py-2 text-sm font-medium rounded-md ${
                                    currentPage === 'projects'
                                        ? 'btn-gradient' 
                                        : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
                                }`}
                            >
                                <svg className="mr-3 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2H5a2 2 0 00-2 2v2m14 0V5a2 2 0 00-2-2H5a2 2 0 00-2 2v2" />
                                </svg>
                                Projects
                            </button>

                            <button
                                onClick={() => {
                                    navigateTo('create');
                                    setSidebarOpen(false);
                                }}
                                className={`w-full flex items-center px-3 py-2 text-sm font-medium rounded-md ${
                                    currentPage === 'create' || currentPage === 'createProject'
                                        ? 'btn-gradient' 
                                        : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
                                }`}
                            >
                                <svg className="mr-3 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                Create
                            </button>
                        </nav>
                        <div className="p-4 border-t border-gray-200">
                            <button
                                onClick={() => {
                                    clearSession();
                                    setCurrentPage('login');
                                    setCurrentScenario(null);
                                    setComparisonScenarios([]);
                                    setCurrentSite(null);
                                    setSidebarOpen(false);
                                }}
                                className="flex items-center w-full px-3 py-2 text-sm font-medium text-red-600 rounded-md hover:bg-red-50 hover:text-red-700 transition-colors"
                            >
                                <svg className="mr-3 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                </svg>
                                Logout
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Chat Panel Toggle Button - Only on Results Page */}
            {currentPage === 'results' && (
                <div 
                    className={`chat-toggle ${chatOpen ? 'open' : ''}`}
                    onClick={() => setChatOpen(!chatOpen)}
                    title={chatOpen ? 'Close Chat' : 'Open Chat'}
                >
                    {chatOpen ? (
                        <svg className="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    ) : (
                        <svg className="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                    )}
                </div>
            )}

            {/* Chat Panel */}
            {currentPage === 'results' && (
                <div className={`chat-panel ${chatOpen ? 'open' : ''}`}>
                    <div className="flex flex-col h-full">
                        <div className="flex items-center justify-between p-4 border-b border-gray-200 bg-gradient-to-r from-blue-600 to-purple-600">
                            <h2 className="text-lg font-semibold text-white flex items-center gap-2">
                                <SparklesIcon className="w-5 h-5" />
                                AI Assistant
                            </h2>
                            <button 
                                onClick={() => setChatOpen(false)}
                                className="text-white/80 hover:text-white transition-colors p-2 rounded-md hover:bg-white/10"
                                title="Close Chat"
                            >
                                <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <div className="flex-1 p-4 overflow-y-auto">
                            {currentScenario ? (
                                <ChatPanel messages={chatMessages} onSubmit={handleChatSubmit} isLoading={isChatLoading} />
                            ) : (
                                <div className="text-center text-gray-500 mb-4">
                                    <p className="text-sm">Loading scenario data...</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            )}

            {/* Main Content */}
            <div className="main-content">
                {renderPage()}
            </div>
        </div>
    );
}

// --- Sub-Components (Pages) ---

function LoginPage({ onLogin }) {
    const [input, setInput] = useState({
        email: 'jeremy@gmail.com',
        password: 'Kj9mP2xQ'
    });
    const [error, setError] = useState('');

    const handleSubmit = (e) => {
        e.preventDefault();
        setError('');
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(input.email)) {
            setError('Please enter a valid email address.');
            return;
        }
        if (input.password.length < 4) {
            setError('Password must be at least 4 characters long.');
            return;
        }
        onLogin(input);
    };

    return (
        <div className="flex items-center justify-center min-h-screen bg-gray-100 px-4">
            <div className="w-full max-w-md mx-auto">
                <div className="bg-white rounded-xl shadow-2xl p-8 space-y-8 border border-gray-100">
                    <div className="text-center">
                        <h1 className="text-3xl font-bold text-gray-900 mb-2">Login</h1>
                        <p className="text-gray-600">Welcome to CRSFinder</p>
                    </div>
                    <form onSubmit={handleSubmit} className="space-y-6">
                        <div>
                            <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input
                                id="email"
                                type="email"
                                value={input.email}
                                onChange={(e) => setInput({ ...input, email: e.target.value })}
                                className="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                placeholder="you@example.com"
                            />
                        </div>
                        <div>
                            <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input
                                id="password"
                                type="password"
                                value={input.password}
                                onChange={(e) => setInput({ ...input, password: e.target.value })}
                                className="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            />
                        </div>
                        {error && <p className="text-sm text-red-600 text-center">{error}</p>}
                        <button type="submit" className="w-full flex items-center justify-center gap-3 py-3 px-4 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 transform hover:scale-[1.02]">
                            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                            </svg>
                            Login
                        </button>
                    </form>
                </div>
            </div>
        </div>
    );
}

function ProjectsPage({ projects, setProjects, navigateTo }) {
    const [filter, setFilter] = useState('');
    const [therapeuticAreaFilter, setTherapeuticAreaFilter] = useState('All');
    const [statusFilter, setStatusFilter] = useState('All');
    const [view, setView] = useState('card'); // 'card', 'table'
    const [sortConfig, setSortConfig] = useState({ key: 'createdDate', direction: 'descending' });

    const therapeuticAreaOptions = useMemo(() => ['All', ...new Set(projects.map(p => p.therapeuticArea))], [projects]);
    const statusOptions = useMemo(() => ['All', 'Active', 'Completed', 'On Hold'], []);

    const requestSort = (key) => {
        let direction = 'ascending';
        if (sortConfig.key === key && sortConfig.direction === 'ascending') {
            direction = 'descending';
        }
        setSortConfig({ key, direction });
    };

    const filteredAndSortedProjects = useMemo(() => {
        let sortableItems = [...projects];
        
        sortableItems = sortableItems
            .filter(p => {
                const q = filter.trim().toLowerCase();
                if (!q) return true;
                return (
                    (p.name || '').toLowerCase().includes(q) ||
                    (p.description || '').toLowerCase().includes(q) ||
                    (p.therapeuticArea || '').toLowerCase().includes(q) ||
                    (p.sponsor || '').toLowerCase().includes(q)
                );
            })
            .filter(p => therapeuticAreaFilter === 'All' || p.therapeuticArea === therapeuticAreaFilter)
            .filter(p => statusFilter === 'All' || p.status === statusFilter);

        sortableItems.sort((a, b) => {
            if (a[sortConfig.key] < b[sortConfig.key]) {
                return sortConfig.direction === 'ascending' ? -1 : 1;
            }
            if (a[sortConfig.key] > b[sortConfig.key]) {
                return sortConfig.direction === 'ascending' ? 1 : -1;
            }
            return 0;
        });

        return sortableItems;
    }, [projects, filter, therapeuticAreaFilter, statusFilter, sortConfig]);

    return (
        <div className="p-4 sm:p-6 lg:p-8 max-w-screen-2xl mx-auto">
            <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">Projects</h1>
                    <p className="text-gray-500 mt-1">Manage your clinical research projects and their scenarios.</p>
                </div>
                <div className="flex gap-4">
                    <button onClick={() => navigateTo('createProject')} className="btn-gradient flex items-center gap-2 px-4 py-2 font-semibold rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all whitespace-nowrap">
                        <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        Create New Project
                    </button>
                </div>
            </header>

            <div className="p-4 bg-white rounded-lg border border-gray-200 mb-6">
                <div className="flex flex-col lg:flex-row lg:items-center gap-4">
                    <input
                        type="text"
                        placeholder="Search project name, description, therapeutic area..."
                        value={filter}
                        onChange={(e) => setFilter(e.target.value)}
                        className="flex-1 min-w-[240px] px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                    />
                    <div className="flex flex-wrap items-center gap-4">
                        <CustomDropdown options={therapeuticAreaOptions} selected={therapeuticAreaFilter} onSelect={setTherapeuticAreaFilter} label="Area:" />
                        <CustomDropdown options={statusOptions} selected={statusFilter} onSelect={setStatusFilter} label="Status:" />
                    </div>
                </div>
                <div className="flex justify-between items-center mt-4 pt-4 border-t">
                    <div className="flex items-center gap-4">
                        <span className="text-sm text-gray-600">
                            {filteredAndSortedProjects.length} project{filteredAndSortedProjects.length !== 1 ? 's' : ''} found
                        </span>
                    </div>
                    <div className="inline-flex rounded-md shadow-sm">
                        <button onClick={() => setView('table')} className={`flex items-center gap-2 px-4 py-2 font-medium ${view === 'table' ? 'btn-gradient' : 'bg-white text-gray-700 hover:bg-gray-50'} rounded-l-lg border border-gray-200`}>
                            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h18v18H3V3zm2 2v14h14V5H5zm2 2h10v2H7V7zm0 4h10v2H7v-2zm0 4h7v2H7v-2z" />
                            </svg>
                            Table View
                        </button>
                        <button onClick={() => setView('card')} className={`flex items-center gap-2 px-4 py-2 font-medium ${view === 'card' ? 'btn-gradient' : 'bg-white text-gray-700 hover:bg-gray-50'} rounded-r-lg border border-gray-200`}>
                            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2H5a2 2 0 00-2 2v2m14 0V5a2 2 0 00-2-2H5a2 2 0 00-2 2v2" />
                            </svg>
                            Card View
                        </button>
                    </div>
                </div>
            </div>

            {view === 'card' ? (
                <>
                    {filteredAndSortedProjects.length > 0 ? (
                        <div className="responsive-grid">
                            {filteredAndSortedProjects.map(project => (
                                <ProjectCard key={project.id} project={project} navigateTo={navigateTo} />
                            ))}
                        </div>
                    ) : (
                        <div className="bg-white rounded-lg shadow-md border border-gray-200 p-8 text-center">
                            <div className="text-gray-500">
                                <svg className="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2H5a2 2 0 00-2 2v2m14 0V5a2 2 0 00-2-2H5a2 2 0 00-2 2v2" />
                                </svg>
                                <h3 className="text-lg font-medium text-gray-900 mb-2">No projects found</h3>
                                <p className="text-gray-500">Try adjusting your search criteria or create a new project.</p>
                            </div>
                        </div>
                    )}
                </>
            ) : (
                <ProjectTable projects={filteredAndSortedProjects} navigateTo={navigateTo} requestSort={requestSort} sortConfig={sortConfig} />
            )}
        </div>
    );
}

function ProjectCard({ project, navigateTo }) {
    return (
        <div className="bg-white rounded-lg shadow-md border border-gray-200 p-6 cursor-pointer hover:shadow-lg transition-all h-full flex flex-col" onClick={() => navigateTo('scenarios', project)}>
            <div className="flex justify-between items-start mb-4">
                <div className="flex-1">
                    <h3 className="text-lg font-bold text-gray-900 mb-2">{project.name}</h3>
                    <p className="text-sm text-gray-600 mb-3">{project.description}</p>
                </div>
                <div className="text-right">
                    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                        project.status === 'Active' ? 'bg-green-100 text-green-800' :
                        project.status === 'Completed' ? 'bg-blue-100 text-blue-800' :
                        'bg-yellow-100 text-yellow-800'
                    }`}>
                        {project.status}
                    </span>
                </div>
            </div>
            <div className="space-y-2 text-sm flex-grow">
                <div className="flex justify-between">
                    <span className="text-gray-600">Therapeutic Area:</span>
                    <span className="font-semibold text-gray-900">{project.therapeuticArea}</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-gray-600">Sponsor:</span>
                    <span className="font-semibold text-gray-900">{project.sponsor}</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-gray-600">Created:</span>
                    <span className="font-semibold text-gray-900">{new Date(project.createdDate).toLocaleDateString()}</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-gray-600">Total Scenarios:</span>
                    <span className="font-semibold text-gray-900">{project.totalScenarios || 0}</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-gray-600">Current Scenarios:</span>
                    <span className="font-semibold text-gray-900">{project.scenarios?.length || 0}</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-gray-600">Active Trials:</span>
                    <span className="font-semibold text-gray-900">{project.activeTrials || 0}</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-gray-600">Completed:</span>
                    <span className="font-semibold text-gray-900">{project.completedTrials || 0}</span>
                </div>
            </div>
            <div className="mt-4 pt-3 border-t border-gray-100 mt-auto">
                <button className="text-sm font-semibold text-indigo-600 hover:text-indigo-700">View Scenarios &rarr;</button>
            </div>
        </div>
    );
}

function ProjectTable({ projects, navigateTo, requestSort, sortConfig }) {
    if (!projects || projects.length === 0) {
        return (
            <div className="bg-white rounded-lg shadow-md border border-gray-200 p-8 text-center">
                <div className="text-gray-500">
                    <svg className="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2H5a2 2 0 00-2 2v2m14 0V5a2 2 0 00-2-2H5a2 2 0 00-2 2v2" />
                    </svg>
                    <h3 className="text-lg font-medium text-gray-900 mb-2">No projects found</h3>
                    <p className="text-gray-500">Try adjusting your search criteria or create a new project.</p>
                </div>
            </div>
        );
    }

    return (
        <div className="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden">
            <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200" style={{ minWidth: '1000px' }}>
                    <thead className="bg-gray-50 sticky top-0 z-10">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 w-80" onClick={() => requestSort('name')}>
                                <div className="flex items-center gap-2">
                                    Project Name
                                    {sortConfig.key === 'name' && (
                                        <svg className={`w-4 h-4 ${sortConfig.direction === 'ascending' ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                                        </svg>
                                    )}
                                </div>
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onClick={() => requestSort('therapeuticArea')}>
                                <div className="flex items-center gap-2">
                                    Therapeutic Area
                                    {sortConfig.key === 'therapeuticArea' && (
                                        <svg className={`w-4 h-4 ${sortConfig.direction === 'ascending' ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                                        </svg>
                                    )}
                                </div>
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onClick={() => requestSort('sponsor')}>
                                <div className="flex items-center gap-2">
                                    Sponsor
                                    {sortConfig.key === 'sponsor' && (
                                        <svg className={`w-4 h-4 ${sortConfig.direction === 'ascending' ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                                        </svg>
                                    )}
                                </div>
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onClick={() => requestSort('status')}>
                                <div className="flex items-center gap-2">
                                    Status
                                    {sortConfig.key === 'status' && (
                                        <svg className={`w-4 h-4 ${sortConfig.direction === 'ascending' ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                                        </svg>
                                    )}
                                </div>
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onClick={() => requestSort('createdDate')}>
                                <div className="flex items-center gap-2">
                                    Created Date
                                    {sortConfig.key === 'createdDate' && (
                                        <svg className={`w-4 h-4 ${sortConfig.direction === 'ascending' ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                                        </svg>
                                    )}
                                </div>
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Total Scenarios
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Active Trials
                            </th>

                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {projects.map(project => (
                            <tr key={project.id} className="hover:bg-gray-50 cursor-pointer" onClick={() => navigateTo('scenarios', project)}>
                                <td className="px-6 py-4 text-sm text-gray-900">
                                    <div>
                                        <div className="font-medium text-gray-900 mb-1">{project.name}</div>
                                        <div className="text-sm text-gray-500 leading-relaxed">{project.description}</div>
                                    </div>
                                </td>
                                <td className="px-6 py-4 text-sm text-gray-900">{project.therapeuticArea}</td>
                                <td className="px-6 py-4 text-sm text-gray-900">{project.sponsor}</td>
                                <td className="px-6 py-4">
                                    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                        project.status === 'Active' ? 'bg-green-100 text-green-800' :
                                        project.status === 'Completed' ? 'bg-blue-100 text-blue-800' :
                                        'bg-yellow-100 text-yellow-800'
                                    }`}>
                                        {project.status}
                                    </span>
                                </td>
                                <td className="px-6 py-4 text-sm text-gray-900">{project.totalScenarios || 0}</td>
                                <td className="px-6 py-4 text-sm text-gray-900">{project.activeTrials || 0}</td>

                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    );
}

function ScenariosListPage({ scenarios, setScenarios, navigateTo, currentProject, setCurrentProject }) {
    // Guard: scenarios page always requires a project - redirect to projects if none
    useEffect(() => {
        if (!currentProject) {
            navigateTo('projects');
        }
    }, [currentProject, navigateTo]);

    // Don't render anything while redirecting
    if (!currentProject) {
        return null;
    }

    // Breadcrumb component
    const Breadcrumbs = () => (
        <nav className="flex items-center space-x-2 text-sm text-gray-500 mb-6">
            <button 
                onClick={() => navigateTo('projects')} 
                className="hover:text-blue-600 transition-colors"
            >
                Projects
            </button>
            <span className="text-gray-400">/</span>
            <span className="text-gray-900 font-medium">{currentProject.name}</span>
        </nav>
    );

    const [filter, setFilter] = useState('');
    const [showArchived, setShowArchived] = useState(false);
    const [createdByFilter, setCreatedByFilter] = useState('All');
    const [phaseFilter, setPhaseFilter] = useState('All');

    const [view, setView] = useState('table'); // 'card', 'table'
    const [sortConfig, setSortConfig] = useState({ key: 'createdDate', direction: 'descending' });
    const [currentPage, setCurrentPage] = useState(1);
    const [itemsPerPage, setItemsPerPage] = useState(6);
    const [selectedForComparison, setSelectedForComparison] = useState([]);
    const [displayedItems, setDisplayedItems] = useState(6);
    const [isLoadingMore, setIsLoadingMore] = useState(false);

    // Filter options based on current project scenarios only
    const projectScenarios = useMemo(() => {
        if (currentProject) {
            return scenarios.filter(s => s.projectId === currentProject.id);
        }
        return scenarios;
    }, [scenarios, currentProject]);

    const createdByOptions = useMemo(() => ['All', ...new Set(projectScenarios.map(s => s.performedBy))], [projectScenarios]);
    const phaseOptions = useMemo(() => ['All', 'Phase I', 'Phase II', 'Phase III', 'Phase IV'], []);


    const togglePin = (id) => {
        setScenarios(scenarios.map(s => s.id === id ? { ...s, isPinned: !s.isPinned } : s));
    };
    const toggleArchive = (id) => {
        setScenarios(scenarios.map(s => s.id === id ? { ...s, isArchived: !s.isArchived } : s));
    };

    const requestSort = (key) => {
        let direction = 'ascending';
        if (sortConfig.key === key && sortConfig.direction === 'ascending') {
            direction = 'descending';
        }
        setSortConfig({ key, direction });
    };

    const handleSelectForComparison = (id) => {
        setSelectedForComparison(prev => {
            const newSelection = prev.includes(id) ? prev.filter(item => item !== id) : [...prev, id];
            return newSelection;
        });
    };

    const handleCompare = () => {
        // Use projectScenarios instead of global scenarios to ensure proper filtering
        const scenariosToCompare = projectScenarios.filter(s => selectedForComparison.includes(s.id));
        
        if (scenariosToCompare.length < 2) {
            alert('Please select at least 2 scenarios to compare.');
            return;
        }
        
        // Ensure we have valid scenario data
        if (scenariosToCompare.every(s => s && s.id && s.title)) {
            navigateTo('comparison', scenariosToCompare);
        } else {
            alert('Error: Invalid scenario data. Please try again.');
        }
    };

    const filteredAndSortedScenarios = useMemo(() => {
        let sortableItems = [...scenarios];
        
        // Filter by current project first (one-to-many relationship)
        if (currentProject) {
            sortableItems = sortableItems.filter(s => s.projectId === currentProject.id);
        }
        
        sortableItems = sortableItems
            .filter(s => showArchived || !s.isArchived)
            .filter(s => {
                const q = filter.trim().toLowerCase();
                if (!q) return true;
                return (
                    (s.title || '').toLowerCase().includes(q) ||
                                          (s.performedBy || '').toLowerCase().includes(q) ||
                      (s.phase || '').toLowerCase().includes(q)
                  );
            })
            .filter(s => createdByFilter === 'All' || s.performedBy === createdByFilter)
            .filter(s => phaseFilter === 'All' || s.phase === phaseFilter)
            

        sortableItems.sort((a, b) => {
            if (a.isPinned && !b.isPinned) return -1;
            if (!a.isPinned && b.isPinned) return 1;

            if (a[sortConfig.key] < b[sortConfig.key]) {
                return sortConfig.direction === 'ascending' ? -1 : 1;
            }
            if (a[sortConfig.key] > b[sortConfig.key]) {
                return sortConfig.direction === 'ascending' ? 1 : -1;
            }
            return 0;
        });

        return sortableItems;
    }, [scenarios, filter, showArchived, createdByFilter, phaseFilter, sortConfig]);

    // Reset displayed items when filters change
    useEffect(() => {
        setDisplayedItems(6);
        setCurrentPage(1);
    }, [filter, showArchived, createdByFilter, phaseFilter, sortConfig]);

    // Reset filters and pagination when project changes
    useEffect(() => {
        setFilter('');
        setShowArchived(false);
        setCreatedByFilter('All');
        setPhaseFilter('All');
        setSelectedForComparison([]);
        setDisplayedItems(6);
        setCurrentPage(1);
        setSortConfig({ key: 'createdDate', direction: 'descending' });
        

    }, [currentProject]);

    // Adjust displayed items based on content height
    useEffect(() => {
        if (view === 'card' && filteredAndSortedScenarios.length > 0) {
            // If we have less than 6 items, show all
            if (filteredAndSortedScenarios.length <= 6) {
                setDisplayedItems(filteredAndSortedScenarios.length);
            } else {
                // Start with 6, but if page won't be scrollable, show more
                const initialCount = Math.min(12, filteredAndSortedScenarios.length);
                setDisplayedItems(initialCount);
            }
        }
    }, [view, filteredAndSortedScenarios.length]);

    // Check if there are more items to load
    const hasMoreItems = displayedItems < filteredAndSortedScenarios.length;

    // Lazy loading for card view
    useEffect(() => {
        if (view !== 'card') return;

        const handleScroll = () => {
            if (isLoadingMore) return;
            
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const windowHeight = window.innerHeight;
            const documentHeight = document.documentElement.scrollHeight;
            
            // Load more when user is near bottom (within 100px)
            if (scrollTop + windowHeight >= documentHeight - 100) {
                loadMoreItems();
            }
        };

        // Only add scroll listener if there are more items to load and page is scrollable
        if (hasMoreItems && document.documentElement.scrollHeight > window.innerHeight) {
            window.addEventListener('scroll', handleScroll);
            return () => window.removeEventListener('scroll', handleScroll);
        }
    }, [view, isLoadingMore, filteredAndSortedScenarios.length, displayedItems, hasMoreItems]);

    const loadMoreItems = () => {
        if (displayedItems >= filteredAndSortedScenarios.length) return;
        
        setIsLoadingMore(true);
        setTimeout(() => {
            setDisplayedItems(prev => Math.min(prev + 6, filteredAndSortedScenarios.length));
            setIsLoadingMore(false);
        }, 300);
    };


    
    const paginatedScenarios = useMemo(() => {
        if (view === 'card') {
            return filteredAndSortedScenarios.slice(0, displayedItems);
        }
        const indexOfLastItem = currentPage * itemsPerPage;
        const indexOfFirstItem = indexOfLastItem - itemsPerPage;
        return filteredAndSortedScenarios.slice(indexOfFirstItem, indexOfLastItem);
    }, [currentPage, itemsPerPage, filteredAndSortedScenarios, view, displayedItems]);

    return (
        <div className="p-4 sm:p-6 lg:p-8 max-w-screen-2xl mx-auto">
            <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
                <div>
                    <Breadcrumbs />
                    <button onClick={() => {
                        setCurrentProject(null);
                        navigateTo('projects');
                    }} className="flex items-center gap-2 text-blue-600 hover:text-blue-700 hover:underline mb-2 h-6 transition-colors">
                        <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                        Back to Projects
                    </button>
                    <div className="flex items-center gap-4">
                        <h1 className="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                            {currentProject ? `${currentProject.name}: Scenarios` : 'Scenarios'}
                        </h1>
                        {currentProject && (
                            <div className="flex items-center gap-2">
                                <span className="px-3 py-1 text-sm font-medium bg-gradient-to-r from-blue-100 to-indigo-100 text-blue-800 rounded-full border border-blue-200">
                                    {projectScenarios.length} Scenarios
                                </span>
                                <span className="px-3 py-1 text-sm font-medium bg-gradient-to-r from-green-100 to-emerald-100 text-green-800 rounded-full border border-green-200">
                                    {projectScenarios.filter(s => !s.isArchived).length} Active
                                </span>
                            </div>
                        )}
                    </div>
                    <p className="text-gray-500 mt-1">
                        Manage and review your clinical trial scenarios.
                    </p>
                    {currentProject && (
                        <div className="mt-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg">
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                                <div>
                                    <span className="font-semibold text-blue-800">Sponsor:</span>
                                    <span className="ml-2 text-blue-700">{currentProject.sponsor}</span>
                                </div>
                                <div>
                                    <span className="font-semibold text-blue-800">Status:</span>
                                    <span className={`ml-2 px-2 py-1 rounded-full text-xs font-medium ${
                                        currentProject.status === 'Active' ? 'bg-green-100 text-green-800' :
                                        currentProject.status === 'Completed' ? 'bg-blue-100 text-blue-800' :
                                        'bg-yellow-100 text-yellow-800'
                                    }`}>
                                        {currentProject.status}
                                    </span>
                                </div>
                                <div>
                                    <span className="font-semibold text-blue-800">Created:</span>
                                    <span className="ml-2 text-blue-700">{new Date(currentProject.createdDate).toLocaleDateString()}</span>
                                </div>
                                <div>
                                    <span className="font-semibold text-blue-800">Therapeutic Area:</span>
                                    <span className="ml-2 text-blue-700">{currentProject.therapeuticArea}</span>
                                </div>
                            </div>
                            <div className="mt-4 pt-4 border-t border-blue-200">
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                                    <div>
                                        <span className="font-semibold text-blue-800">Total Scenarios:</span>
                                        <span className="ml-2 text-blue-700">{projectScenarios.length}</span>
                                    </div>
                                    <div>
                                        <span className="font-semibold text-blue-800">Active Trials:</span>
                                        <span className="ml-2 text-blue-700">{projectScenarios.filter(s => !s.isArchived).length}</span>
                                    </div>
                                    <div>
                                        <span className="font-semibold text-blue-800">Target Enrollment:</span>
                                        <span className="ml-2 text-blue-700">{currentProject.targetEnrollment?.toLocaleString() || 'N/A'}</span>
                                    </div>
                                    <div>
                                        <span className="font-semibold text-blue-800">Estimated Completion:</span>
                                        <span className="ml-2 text-blue-700">{currentProject.estimatedCompletion || 'N/A'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
                <div className="flex gap-4">
                    <button onClick={() => navigateTo('create')} className="btn-gradient flex items-center gap-2 px-4 py-2 font-semibold rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all whitespace-nowrap">
                        <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        Create New Scenario
                    </button>
                </div>
            </header>

            <div className="p-4 bg-gradient-to-r from-white to-blue-50 rounded-lg border border-gray-200 mb-6">
                <div className="flex flex-col lg:flex-row lg:items-center gap-4">
                    <input
                        type="text"
                        placeholder={currentProject ? `Search ${currentProject.name} scenarios...` : "Search title, author, phase..."}
                        value={filter}
                        onChange={(e) => setFilter(e.target.value)}
                        className="flex-1 min-w-[240px] px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white"
                    />
                    <div className="flex flex-wrap items-center gap-4">
                        <CustomDropdown options={createdByOptions} selected={createdByFilter} onSelect={setCreatedByFilter} label="Author:" />
                        <CustomDropdown options={phaseOptions} selected={phaseFilter} onSelect={setPhaseFilter} label="Phase:" />
                    </div>
                </div>
                <div className="flex justify-between items-center mt-4 pt-4 border-t border-gray-200">
                    <div className="flex items-center gap-4">
                        <div className="checkbox-container">
                            <input
                                id="show-archived"
                                type="checkbox"
                                checked={showArchived}
                                onChange={(e) => setShowArchived(e.target.checked)}
                            />
                            <label htmlFor="show-archived" className="text-sm font-medium text-gray-700 cursor-pointer hover:text-gray-900 transition-colors">
                                Show Archived Scenarios
                            </label>
                        </div>
                        <button 
                            onClick={handleCompare}
                            disabled={selectedForComparison.length < 2}
                            className={`flex items-center gap-2 px-4 py-2 font-semibold rounded-md transition-colors ${
                                selectedForComparison.length >= 2 
                                    ? 'btn-gradient' 
                                    : 'text-gray-400 bg-gray-200 cursor-not-allowed'
                            }`}
                        >
                            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            Compare ({selectedForComparison.length})
                        </button>
                        <div className="text-xs text-gray-500 mt-1">
                            {selectedForComparison.length < 2 ? 'Select 2+ scenarios to compare' : 'Ready to compare'}
                        </div>
                    </div>
                    <div className="inline-flex rounded-md shadow-sm">
                        <button onClick={() => setView('table')} className={`flex items-center gap-2 px-4 py-2 font-medium ${view === 'table' ? 'btn-gradient' : 'bg-white text-gray-700 hover:bg-gray-50'} rounded-l-lg border border-gray-200`}>
                            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h18v18H3V3zm2 2v14h14V5H5zm2 2h10v2H7V7zm0 4h10v2H7v-2zm0 4h7v2H7v-2z" />
                            </svg>
                            Table View
                        </button>
                        <button onClick={() => setView('card')} className={`flex items-center gap-2 px-4 py-2 font-medium ${view === 'card' ? 'btn-gradient' : 'bg-white text-gray-700 hover:bg-gray-50'} rounded-r-lg border border-gray-200`}>
                            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2H5a2 2 0 00-2 2v2m14 0V5a2 2 0 00-2-2H5a2 2 0 00-2 2v2" />
                            </svg>
                            Card View
                        </button>
                    </div>
                </div>
                {currentProject && (
                    <div className="mt-4 pt-4 border-t border-gray-200">
                        <div className="flex items-center gap-4 text-sm text-gray-600">
                            <span className="font-medium">Project Filters:</span>
                            <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">
                                {currentProject.therapeuticArea}
                            </span>
                            <span className="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">
                                {currentProject.sponsor}
                            </span>
                            <span className="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs">
                                {currentProject.regulatoryPhase || 'N/A'}
                            </span>
                        </div>
                    </div>
                )}
            </div>



            {view === 'card' ? (
                <>
                    {paginatedScenarios.length > 0 ? (
                        <>
                            <div className="responsive-grid">
                                {paginatedScenarios.map(scenario => (
                                    <ScenarioCard key={scenario.id} scenario={scenario} onPin={togglePin} onArchive={toggleArchive} navigateTo={navigateTo} onSelect={handleSelectForComparison} isSelected={selectedForComparison.includes(scenario.id)} />
                                ))}
                            </div>
                            {isLoadingMore && (
                                <div className="flex justify-center mt-6">
                                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                                </div>
                            )}
                            {hasMoreItems && !isLoadingMore && (
                                <div className="text-center mt-6">
                                    <button 
                                        onClick={loadMoreItems}
                                        className="btn-gradient flex items-center gap-2 px-6 py-3 font-medium rounded-lg transition-all"
                                    >
                                        <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                        </svg>
                                        Load More Scenarios ({filteredAndSortedScenarios.length - displayedItems} remaining)
                                    </button>
                                    <p className="text-gray-500 mt-2">Or scroll down to load automatically</p>
                                </div>
                            )}
                        </>
                    ) : (
                        <div className="bg-white rounded-lg shadow-md border border-gray-200 p-8 text-center">
                            <div className="text-gray-500">
                                <svg className="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <h3 className="text-lg font-medium text-gray-900 mb-2">No scenarios found</h3>
                                <p className="text-gray-500">Try adjusting your search criteria or filters to find scenarios.</p>
                            </div>
                        </div>
                    )}
                </>
            ) : (
                <>
                    <ScenarioTable scenarios={paginatedScenarios} onPin={togglePin} onArchive={toggleArchive} navigateTo={navigateTo} requestSort={requestSort} sortConfig={sortConfig} onSelect={handleSelectForComparison} selectedItems={selectedForComparison} />
                    {filteredAndSortedScenarios.length > 0 && (
                        <Pagination
                            currentPage={currentPage}
                            totalPages={Math.ceil(filteredAndSortedScenarios.length / itemsPerPage)}
                            onPageChange={setCurrentPage}
                        />
                    )}
                </>
            )}
        </div>
    );
}

function ScenarioCard({ scenario, onPin, onArchive, navigateTo, onSelect, isSelected }) {
    const { id, title, performedBy, createdDate, phase, isPinned, isArchived } = scenario;
    
    const phaseColors = {
        'Phase I': 'bg-purple-100 text-purple-800',
        'Phase II': 'bg-blue-100 text-blue-800',
        'Phase III': 'bg-green-100 text-green-800',
        'Phase IV': 'bg-yellow-100 text-yellow-800',
    };

    return (
        <div className={`flex flex-col bg-white rounded-lg shadow-md border ${isPinned ? 'border-blue-500' : 'border-gray-200'} ${isSelected ? 'ring-2 ring-indigo-500' : ''} transition-all`}>
            <div className="p-5 flex-grow cursor-pointer" onClick={() => navigateTo('results', scenario)}>
                <div className="flex justify-between items-start gap-2">
                    <h3 className="text-lg font-bold text-gray-900 mb-2 flex-1">{title}</h3>
                    <span className={`px-3 py-1 text-xs font-medium rounded-full whitespace-nowrap ${phaseColors[phase] || 'bg-gray-100 text-gray-800'}`}>
                        {phase}
                    </span>
                </div>
                <p className="text-sm text-gray-500">Performed by: {performedBy}</p>
                <p className="text-sm text-gray-500">Created: {new Date(createdDate).toLocaleDateString()}</p>
            </div>
            <div className="flex justify-between items-center p-3 bg-gray-50 border-t border-gray-200 rounded-b-lg">
                 <div className="checkbox-container">
                    <input 
                        type="checkbox" 
                        checked={isSelected}
                        onChange={() => onSelect(id)}
                        className="site-checkbox"
                    />
                    <label className="text-sm text-gray-600">Compare</label>
                </div>
                <div className="flex items-center gap-2">
                    <Tooltip text={isPinned ? "Unpin Scenario" : "Pin Scenario"}>
                        <button onClick={(e) => { e.stopPropagation(); onPin(id); }} className={`p-2 rounded-full ${isPinned ? 'text-blue-600 bg-blue-100' : 'text-gray-500 hover:bg-gray-200'} transition-colors`}>
                            <PinIcon className="w-5 h-5" isPinned={isPinned} />
                        </button>
                    </Tooltip>
                    <Tooltip text={isArchived ? "Unarchive Scenario" : "Archive Scenario"}>
                        <button onClick={(e) => { e.stopPropagation(); onArchive(id); }} className={`p-2 rounded-full ${isArchived ? 'text-yellow-600 bg-yellow-100' : 'text-gray-500 hover:bg-gray-200'} transition-colors`}>
                            <ArchiveIcon className="w-5 h-5" />
                        </button>
                    </Tooltip>
                </div>
            </div>
        </div>
    );
}

function ScenarioTable({ scenarios, onPin, onArchive, navigateTo, requestSort, sortConfig, onSelect, selectedItems }) {
    
    if (!scenarios || scenarios.length === 0) {
        return (
            <div className="bg-white rounded-lg shadow-md border border-gray-200 p-8 text-center">
                <div className="text-gray-500">
                    <svg className="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h3 className="text-lg font-medium text-gray-900 mb-2">No scenarios found</h3>
                    <p className="text-gray-500">Try adjusting your search criteria or filters to find scenarios.</p>
                </div>
            </div>
        );
    }
    
    return (
        <div className="bg-white rounded-lg shadow-md border border-gray-200 overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50 sticky top-0 z-10">
                    <tr>
                        <th className="px-6 py-3"></th>
                        <th className={`px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 ${sortConfig.key === 'title' ? 'bg-blue-50 text-blue-700' : ''}`} onClick={() => requestSort('title')}>
                            <div className="flex items-center justify-between">
                                <span>Title</span>
                                <div className="flex flex-col items-center ml-2">
                                    <svg className={`w-3 h-3 ${sortConfig.key === 'title' && sortConfig.direction === 'ascending' ? 'text-blue-600' : 'text-gray-400'}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                                    </svg>
                                    <svg className={`w-3 h-3 ${sortConfig.key === 'title' && sortConfig.direction === 'descending' ? 'text-blue-600' : 'text-gray-400'}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                    </svg>
                                </div>
                            </div>
                        </th>
                        <th className={`px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 ${sortConfig.key === 'performedBy' ? 'bg-blue-50 text-blue-700' : ''}`} onClick={() => requestSort('performedBy')}>
                            <div className="flex items-center justify-between">
                                <span>Performed By</span>
                                <div className="flex flex-col items-center ml-2">
                                    <svg className={`w-3 h-3 ${sortConfig.key === 'performedBy' && sortConfig.direction === 'ascending' ? 'text-blue-600' : 'text-gray-400'}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                                    </svg>
                                    <svg className={`w-3 h-3 ${sortConfig.key === 'performedBy' && sortConfig.direction === 'descending' ? 'text-blue-600' : 'text-gray-400'}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                    </svg>
                                </div>
                            </div>
                        </th>

                        <th className={`px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 ${sortConfig.key === 'createdDate' ? 'bg-blue-50 text-blue-700' : ''}`} onClick={() => requestSort('createdDate')}>
                            <div className="flex items-center justify-between">
                                <span>Created Date</span>
                                <div className="flex flex-col items-center ml-2">
                                    <svg className={`w-3 h-3 ${sortConfig.key === 'createdDate' && sortConfig.direction === 'ascending' ? 'text-blue-600' : 'text-gray-400'}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                                    </svg>
                                    <svg className={`w-3 h-3 ${sortConfig.key === 'createdDate' && sortConfig.direction === 'descending' ? 'text-blue-600' : 'text-gray-400'}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                    </svg>
                                </div>
                            </div>
                        </th>
                        <th className={`px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 ${sortConfig.key === 'phase' ? 'bg-blue-50 text-blue-700' : ''}`} onClick={() => requestSort('phase')}>
                            <div className="flex items-center justify-between">
                                <span>Phase</span>
                                <div className="flex flex-col items-center ml-2">
                                    <svg className={`w-3 h-3 ${sortConfig.key === 'phase' && sortConfig.direction === 'ascending' ? 'text-blue-600' : 'text-gray-400'}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                                    </svg>
                                    <svg className={`w-3 h-3 ${sortConfig.key === 'phase' && sortConfig.direction === 'descending' ? 'text-blue-600' : 'text-gray-400'}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                    </svg>
                                </div>
                            </div>
                        </th>
                        <th className="relative px-6 py-3"><span className="sr-only">Actions</span></th>
                    </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                    {scenarios.map(scenario => (
                        <tr key={scenario.id} className={`${selectedItems.includes(scenario.id) ? 'bg-indigo-50' : ''}`}>
                            <td className="px-6 py-4" onClick={(e)=>e.stopPropagation()}>
                                <input 
                                    type="checkbox" 
                                    checked={selectedItems.includes(scenario.id)}
                                    onChange={() => onSelect(scenario.id)}
                                    className="site-checkbox"
                                />
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 cursor-pointer hover:text-blue-600 hover:underline" onClick={() => navigateTo('results', scenario)}>{scenario.title}</td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{scenario.performedBy}</td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{new Date(scenario.createdDate).toLocaleDateString()}</td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{scenario.phase}</td>
                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium" onClick={(e)=>e.stopPropagation()}>
                                <div className="flex items-center justify-end gap-3">
                                    <Tooltip text={scenario.isPinned ? "Unpin Scenario" : "Pin Scenario"}>
                                        <button onClick={(e) => { e.stopPropagation(); onPin(scenario.id); }} className={`inline-flex items-center justify-center h-8 w-8 rounded-full ${scenario.isPinned ? 'text-blue-600 bg-blue-100' : 'text-gray-500 hover:bg-gray-200'} transition-colors`}>
                                            <PinIcon className="w-5 h-5" isPinned={scenario.isPinned} />
                                        </button>
                                    </Tooltip>
                                    <Tooltip text={scenario.isArchived ? "Unarchive Scenario" : "Archive Scenario"}>
                                        <button onClick={(e) => { e.stopPropagation(); onArchive(scenario.id); }} className={`inline-flex items-center justify-center h-8 w-8 rounded-full ${scenario.isArchived ? 'text-yellow-600 bg-yellow-100' : 'text-gray-500 hover:bg-gray-200'} transition-colors`}>
                                            <ArchiveIcon className="w-5 h-5" />
                                        </button>
                                    </Tooltip>
                                </div>
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
    );
}

function CreateScenarioPage({ navigateTo, onSave, siteRankingData }) {
    const [formData, setFormData] = useState({
        title: '', 
        sponsor: '',
        studyId: '',
        indication: '', 
        drugInfo: '', 
        objective: '',
        protocolDetails: '', 
        targetSubjects: '',
        timeline: '', 
        phase: 'Phase I', 
        startDate: '', 
        preferredRegions: [],
        criteriaWeights: { patientAvailability: 50, enrollmentRate: 50, startupSpeed: 50, piMatch: 50, competition: 50 }
    });
    const [isUploading, setIsUploading] = useState(false);
    const fileInputRef = useRef(null);

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const handleSliderChange = (e) => {
        const { name, value } = e.target;
        const slider = e.target;
        slider.style.setProperty('--value-percent', `${value}%`);
        setFormData(prev => ({ ...prev, criteriaWeights: { ...prev.criteriaWeights, [name]: parseInt(value) } }));
    };

    const handlePdfUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
            setIsUploading(true);
            setTimeout(() => {
                // Generate random study data for variety
                const studyTypes = [
                    {
                        title: 'Pembrolizumab in NSCLC Study',
                        sponsor: 'Merck & Co., Inc.',
                        studyId: 'MK-3475-189',
                        indication: 'Non-Small Cell Lung Cancer (NSCLC)',
                        drugInfo: 'Pembrolizumab (Keytruda)',
                        objective: 'To evaluate the efficacy and safety of Pembrolizumab in combination with chemotherapy for the first-line treatment of metastatic non-small cell lung cancer.',
                        protocolDetails: 'A Phase III, randomized, double-blind study to evaluate the efficacy and safety of Pembrolizumab in combination with chemotherapy.',
                        targetSubjects: 500,
                        timeline: 24,
                        phase: 'Phase III',
                        startDate: '2024-09-01',
                        preferredRegions: ['North America', 'Europe']
                    },
                    {
                        title: 'Atezolizumab Breast Cancer Trial',
                        sponsor: 'Genentech, Inc.',
                        studyId: 'GO39909',
                        indication: 'Triple-Negative Breast Cancer (TNBC)',
                        drugInfo: 'Atezolizumab (Tecentriq)',
                        objective: 'To assess the efficacy and safety of Atezolizumab in combination with chemotherapy for the treatment of early-stage triple-negative breast cancer.',
                        protocolDetails: 'A Phase III, multicenter, randomized study evaluating Atezolizumab plus chemotherapy versus chemotherapy alone in patients with early-stage TNBC.',
                        targetSubjects: 1200,
                        timeline: 36,
                        phase: 'Phase III',
                        startDate: '2024-10-15',
                        preferredRegions: ['North America', 'Europe', 'Asia']
                    },
                    {
                        title: 'Nivolumab Melanoma Study',
                        sponsor: 'Bristol-Myers Squibb',
                        studyId: 'CA209-9LA',
                        indication: 'Advanced Melanoma',
                        drugInfo: 'Nivolumab (Opdivo)',
                        objective: 'To evaluate the long-term survival and safety of Nivolumab in patients with advanced melanoma who have progressed on or after prior therapy.',
                        protocolDetails: 'A Phase III, open-label, single-arm study to assess the long-term safety and efficacy of Nivolumab in patients with advanced melanoma.',
                        targetSubjects: 300,
                        timeline: 18,
                        phase: 'Phase III',
                        startDate: '2024-11-01',
                        preferredRegions: ['North America', 'Europe']
                    },
                    {
                        title: 'CAR-T Cell Therapy Study',
                        sponsor: 'Novartis Pharmaceuticals',
                        studyId: 'CTL019-001',
                        indication: 'B-Cell Acute Lymphoblastic Leukemia (B-ALL)',
                        drugInfo: 'Tisagenlecleucel (Kymriah)',
                        objective: 'To evaluate the safety and efficacy of Tisagenlecleucel in pediatric and young adult patients with relapsed or refractory B-ALL.',
                        protocolDetails: 'A Phase II, single-arm, multicenter study to assess the safety and efficacy of Tisagenlecleucel in patients with relapsed or refractory B-ALL.',
                        targetSubjects: 150,
                        timeline: 12,
                        phase: 'Phase II',
                        startDate: '2024-12-01',
                        preferredRegions: ['North America', 'Europe']
                    },
                    {
                        title: 'Gene Therapy for Hemophilia',
                        sponsor: 'BioMarin Pharmaceutical',
                        studyId: 'BMN-270-001',
                        indication: 'Hemophilia A',
                        drugInfo: 'Valoctocogene Roxaparvovec (Roctavian)',
                        objective: 'To assess the long-term safety and efficacy of Valoctocogene Roxaparvovec in adult patients with severe hemophilia A.',
                        protocolDetails: 'A Phase III, open-label, single-dose study to evaluate the safety and efficacy of Valoctocogene Roxaparvovec in patients with severe hemophilia A.',
                        targetSubjects: 200,
                        timeline: 48,
                        phase: 'Phase III',
                        startDate: '2025-01-15',
                        preferredRegions: ['North America', 'Europe', 'Australia']
                    }
                ];
                
                // Randomly select a study type
                const selectedStudy = studyTypes[Math.floor(Math.random() * studyTypes.length)];
                
                // Generate optimized criteria weights based on study type
                const newWeights = { 
                    patientAvailability: Math.floor(Math.random() * 30) + 60, // 60-90
                    enrollmentRate: Math.floor(Math.random() * 25) + 55,      // 55-80
                    startupSpeed: Math.floor(Math.random() * 30) + 60,        // 60-90
                    piMatch: Math.floor(Math.random() * 20) + 75,            // 75-95
                    competition: Math.floor(Math.random() * 30) + 30          // 30-60
                };
                
                setFormData({
                    ...selectedStudy,
                    criteriaWeights: newWeights
                });
                
                // Manually update slider visual state after auto-fill
                Object.keys(newWeights).forEach(key => {
                    const slider = document.querySelector(`input[name="${key}"]`);
                    if(slider) {
                        slider.style.setProperty('--value-percent', `${newWeights[key]}%`);
                    }
                });
                
                setIsUploading(false);
                
                // Success message handled silently - form is now populated
            }, 2000);
        }
    };

    const getTotalCriteriaWeight = () => {
        return Object.values(formData.criteriaWeights).reduce((sum, weight) => sum + weight, 0);
    };

    const isFormValid = () => {
        return (
            formData.title && formData.title.trim() &&
            formData.phase &&
            formData.indication && formData.indication.trim() &&
            formData.targetSubjects && formData.targetSubjects > 0 &&
            formData.timeline && formData.timeline > 0 &&
            getTotalCriteriaWeight() === 100
        );
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        
        // Validate required fields: Title, Phase, Indication, Timeline, and Target Subjects
        if (!formData.title || !formData.title.trim()) {
            return;
        }
        if (!formData.phase) {
            return;
        }
        if (!formData.indication.trim()) {
            return;
        }
        if (!formData.targetSubjects || formData.targetSubjects <= 0) {
            return;
        }
        if (!formData.timeline || formData.timeline <= 0) {
            return;
        }
        
        // Validate criteria weights total 100%
        if (getTotalCriteriaWeight() !== 100) {
            return;
        }
        
        const previewScenario = {
            ...formData,
            id: Date.now(), // Ensure scenario has a proper ID
            isPreview: true,
            siteRankings: siteRankingData || [], // siteRankingData is already an array
        };
        
        navigateTo('results', previewScenario);
    };

    return (
        <div className="max-w-screen-2xl mx-auto p-4 sm:p-6 lg:p-8">
            <header className="mb-8">
                <button onClick={() => navigateTo('projects')} className="flex items-center gap-2 text-blue-600 hover:underline mb-2 h-6">
                    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Projects
                </button>
                <h1 className="text-3xl font-bold text-gray-900">Create New Scenario</h1>
                <p className="text-gray-500 mt-1">Define the parameters for your clinical trial simulation.</p>
            </header>
            
            <form onSubmit={handleSubmit} className="space-y-8">
                {/* PDF Upload Section - Google Reverse Image Search Style */}
                <div className="form-section p-8">
                    <div className="text-center mb-8">
                        <h2 className="text-2xl font-bold text-gray-800 mb-2">Upload Clinical Trial Protocol</h2>
                        <p className="text-gray-600">Drag and drop your PDF protocol or click to browse. We'll automatically extract and populate all form fields.</p>
                    </div>
                    
                    <div 
                        className="upload-area p-8 text-center cursor-pointer"
                        onClick={() => fileInputRef.current.click()}
                        onDragOver={(e) => {
                            e.preventDefault();
                            e.currentTarget.classList.add('dragover');
                        }}
                        onDragLeave={(e) => {
                            e.currentTarget.classList.remove('dragover');
                        }}
                        onDrop={(e) => {
                            e.preventDefault();
                            e.currentTarget.classList.remove('dragover');
                            const file = e.dataTransfer.files[0];
                            if (file && file.type === 'application/pdf') {
                                const event = { target: { files: [file] } };
                                handlePdfUpload(event);
                            }
                        }}
                    >
                        <input type="file" accept=".pdf" ref={fileInputRef} onChange={handlePdfUpload} className="hidden" />
                        
                        <div className="space-y-3">
                            <div className="mx-auto w-16 h-16 bg-gradient-to-br from-blue-100 to-purple-100 rounded-full flex items-center justify-center">
                                {isUploading ? (
                                    <LoadingSpinner className="w-8 h-8 text-blue-600" />
                                ) : (
                                    <UploadIcon className="w-8 h-8 text-blue-600" />
                                )}
                            </div>
                            
                            <div>
                                <h3 className="text-base font-semibold text-gray-800 mb-1">
                                    {isUploading ? 'Processing PDF...' : 'Drop your PDF here'}
                                </h3>
                                <p className="text-sm text-gray-500 mb-3">
                                    {isUploading 
                                        ? 'Extracting clinical trial data...' 
                                        : 'or click to browse files'
                                    }
                                </p>
                                
                                {!isUploading && (
                                    <button 
                                        type="button"
                                        className="btn-gradient inline-flex items-center gap-2 px-4 py-2 text-sm font-semibold rounded-lg transition-all"
                                    >
                                        <UploadIcon className="w-4 h-4" />
                                        Choose PDF File
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>

                {/* OR Divider Section */}
                <div className="text-center space-y-4">
                    <div className="inline-flex items-center">
                        <div className="flex-1 h-px bg-gray-300"></div>
                        <div className="px-4 py-2 bg-white">
                            <div className="w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-full flex items-center justify-center shadow-lg">
                                <span className="text-white font-bold text-sm">OR</span>
                            </div>
                        </div>
                        <div className="flex-1 h-px bg-gray-300"></div>
                    </div>
                    
                    <p className="text-gray-600 text-sm">manually fill out the form below</p>
                </div>

                {/* Form Fields Section */}
                <div className="form-section p-8">
                    <h2 className="text-xl font-semibold text-gray-800 mb-6">Scenario Details</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <InputField label="Title *" name="title" value={formData.title} onChange={handleInputChange} required />
                        <InputField label="Sponsor" name="sponsor" value={formData.sponsor} onChange={handleInputChange} />
                        <InputField label="Study ID" name="studyId" value={formData.studyId} onChange={handleInputChange} />
                        <InputField label="Indication *" name="indication" value={formData.indication} onChange={handleInputChange} required />
                        <InputField label="Drug Info" name="drugInfo" value={formData.drugInfo} onChange={handleInputChange} />
                        <CustomDropdownField label="Phase *" options={['Phase I', 'Phase II', 'Phase III', 'Phase IV']} selected={formData.phase} onSelect={(val) => setFormData(p => ({...p, phase: val}))} required />
                        <InputField label="Target Subjects *" name="targetSubjects" type="number" value={formData.targetSubjects} onChange={handleInputChange} required />
                        <InputField label="Timeline (Months) *" name="timeline" type="number" value={formData.timeline} onChange={handleInputChange} required />
                        <div className="col-span-1">
                            <label htmlFor="startDate" className="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                            <input
                                id="startDate"
                                type="date"
                                name="startDate"
                                value={formData.startDate}
                                onChange={handleInputChange}
                                className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                            />
                        </div>

                        <MultiSelectDropdownField 
                            label="Preferred Regions"
                            options={['North America', 'South America', 'Europe', 'Asia', 'Africa', 'Australia']}
                            selected={formData.preferredRegions}
                            onSelect={(val) => setFormData(p => ({...p, preferredRegions: val}))}
                        />
                        <TextAreaField label="Objective" name="objective" value={formData.objective} onChange={handleInputChange} className="md:col-span-2" />
                        <TextAreaField label="Protocol Details" name="protocolDetails" value={formData.protocolDetails} onChange={handleInputChange} className="md:col-span-2" />
                    </div>
                </div>

                <div className="form-section p-8">
                    <h2 className="text-xl font-semibold mb-6 text-gray-800">Key Criteria Weights *</h2>
                    <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <div className="flex items-center justify-between">
                            <span className="text-sm text-blue-800 font-medium">Total Criteria Weight:</span>
                            <span className={`text-lg font-bold ${getTotalCriteriaWeight() === 100 ? 'text-green-600' : 'text-red-600'}`}>
                                {getTotalCriteriaWeight()}%
                            </span>
                        </div>
                        {getTotalCriteriaWeight() !== 100 && (
                            <p className="text-sm text-red-600 mt-2">
                                ‚ö†Ô∏è Total must equal 100%. Current total: {getTotalCriteriaWeight()}%
                            </p>
                        )}
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-8">
                        <SliderField label="Patient Availability" name="patientAvailability" value={formData.criteriaWeights.patientAvailability} onChange={handleSliderChange} />
                        <SliderField label="Historical Enrollment Rate" name="enrollmentRate" value={formData.criteriaWeights.enrollmentRate} onChange={handleSliderChange} />
                        <SliderField label="Start-up Speed" name="startupSpeed" value={formData.criteriaWeights.startupSpeed} onChange={handleSliderChange} />
                        <SliderField label="PI/Specialty Match" name="piMatch" value={formData.criteriaWeights.piMatch} onChange={handleSliderChange} />
                        <SliderField label="Competition Load" name="competition" value={formData.criteriaWeights.competition} onChange={handleSliderChange} />
                    </div>
                </div>

                <div className="flex justify-end items-center pt-4 gap-4">
                    <button type="button" onClick={() => navigateTo('projects')} className="flex items-center gap-2 px-6 py-2 font-semibold text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">
                        <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        Cancel
                    </button>
                    <button 
                        type="submit" 
                        disabled={!isFormValid()}
                        className={`flex items-center gap-2 px-6 py-2 font-semibold rounded-md transition-all ${
                            isFormValid() 
                                ? 'btn-gradient' 
                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                        }`}
                    >
                        <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Submit & View Results
                    </button>
                </div>
            </form>
        </div>
    );
}

function ResultsPage({ scenario, navigateTo, onSave, chatMessages, isChatLoading, onSubmitChat, currentProject }) {
    const [view, setView] = useState('table'); // 'table', 'card'
    const [expandedRows, setExpandedRows] = useState(new Set());
    const [isExportingPdf, setIsExportingPdf] = useState(false);
    const [isExportingExcel, setIsExportingExcel] = useState(false);
    const [currentPage, setCurrentPage] = useState(1);
    const [itemsPerPage] = useState(10);
    const [displayedSites, setDisplayedSites] = useState(6);
    const [isLoadingMore, setIsLoadingMore] = useState(false);
    const [selectedSites, setSelectedSites] = useState([]);
    const exportRef = useRef(null);
    const pdfExportRef = useRef(null);

    // Calculate pagination for sites
    const indexOfLastItem = currentPage * itemsPerPage;
    const indexOfFirstItem = indexOfLastItem - itemsPerPage;
    const currentSites = scenario?.siteRankings?.slice(indexOfFirstItem, indexOfLastItem) || [];
    const totalPages = Math.ceil((scenario?.siteRankings?.length || 0) / itemsPerPage);

    // Check if there are more sites to load for card view
    const hasMoreItems = displayedSites < (scenario?.siteRankings?.length || 0);

    // Lazy loading for card view
    useEffect(() => {
        if (view !== 'card') return;

        const handleScroll = () => {
            if (isLoadingMore) return;
            
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const windowHeight = window.innerHeight;
            const documentHeight = document.documentElement.scrollHeight;
            
            // Load more when user is near bottom (within 100px)
            if (scrollTop + windowHeight >= documentHeight - 100) {
                loadMoreSites();
            }
        };

        // Only add scroll listener if there are more items to load and page is scrollable
        if (hasMoreItems && document.documentElement.scrollHeight > window.innerHeight) {
            window.addEventListener('scroll', handleScroll);
            return () => window.removeEventListener('scroll', handleScroll);
        }
    }, [view, isLoadingMore, scenario?.siteRankings?.length, displayedSites, hasMoreItems]);

    const loadMoreSites = () => {
        if (!scenario?.siteRankings || displayedSites >= scenario.siteRankings.length) return;
        
        setIsLoadingMore(true);
        setTimeout(() => {
            setDisplayedSites(prev => Math.min(prev + 6, scenario.siteRankings.length));
            setIsLoadingMore(false);
        }, 300);
    };

    // Reset displayed sites when view changes
    useEffect(() => {
        if (view === 'card') {
            setDisplayedSites(6);
        }
    }, [view]);

    // Adjust displayed sites based on content height
    useEffect(() => {
        if (view === 'card' && scenario?.siteRankings?.length > 0) {
            // If we have less than 6 sites, show all
            if (scenario.siteRankings.length <= 6) {
                setDisplayedSites(scenario.siteRankings.length);
            } else {
                // Start with 6, but if page won't be scrollable, show more
                const initialCount = Math.min(12, scenario.siteRankings.length);
                setDisplayedSites(initialCount);
            }
        }
    }, [view, scenario?.siteRankings?.length]);

    const handlePageChange = (pageNumber) => {
        setCurrentPage(pageNumber);
        setExpandedRows(new Set()); // Reset expanded rows when page changes
    };

    const handleSiteSelect = (siteId) => {
        setSelectedSites(prev => 
            prev.includes(siteId) 
                ? prev.filter(id => id !== siteId)
                : [...prev, siteId]
        );
    };

    const handleCompareSites = () => {
        if (selectedSites.length < 2) {
            // Validation error handled silently - user can see selection count
            return;
        }
        
        const sitesToCompare = scenario.siteRankings.filter(site => 
            selectedSites.includes(site.siteCode)
        );
        
        // Save comparison data to localStorage
        localStorage.setItem('pageData', JSON.stringify({
            siteComparison: {
                sites: sitesToCompare,
                scenario: scenario
            }
        }));
        
        // Navigate to site comparison page
        navigateTo('siteComparison');
    };

    const handleExportExcel = () => {
        setIsExportingExcel(true);
        // Use a short timeout to allow the UI to update to the loading state
        setTimeout(() => {
            try {
                const rows = scenario.siteRankings.map(s => ({
                    Rank: s.rank,
                    Site: s.site,
                    State: s.state,
                    'Match Score': s.matchScore,
                    'Composite Score': s.compositeScore,
                    'PI': s.details?.siteInfo?.pi || 'N/A',
                    'Site Code': s.siteCode,
                    'Address': s.details?.siteInfo?.address || 'N/A',
                    'Email': s.details?.siteInfo?.contact || 'N/A',
                    'Website': s.details?.siteInfo?.website || 'N/A',
                    'Enrollment Rate': s.details?.operationalPerformance?.enrollmentRate || 'N/A',
                    'Retention Rate': s.details?.operationalPerformance?.retentionRate || 'N/A',
                    'Time to Activate': s.details?.operationalPerformance?.timeToActivate || 'N/A',
                    'Past Trials': s.details?.operationalPerformance?.pastTrials || 'N/A',
                    'Query Turnaround': s.details?.operationalPerformance?.queryTurnaround || 'N/A',
                    'Lab Certifications': s.details?.infrastructure?.labCertifications || 'N/A',
                    'On-site Lab': s.details?.infrastructure?.onSiteLab || 'N/A',
                    'Pharmacy': s.details?.infrastructure?.pharmacy || 'N/A',
                    'Imaging': (s.details?.infrastructure?.imaging || []).join(', ') || 'N/A',
                    'Therapeutic Areas': (s.details?.clinicalCapabilities?.therapeuticAreas || []).join(', ') || 'N/A',
                    'CRC Count': s.details?.clinicalCapabilities?.crcCount || 'N/A',
                }));
                // Create worksheet with proper formatting
                const ws = XLSX.utils.json_to_sheet(rows);
                
                // Set column widths for better readability
                const colWidths = [
                    { wch: 8 },   // Rank
                    { wch: 30 },  // Site
                    { wch: 12 },  // State
                    { wch: 12 },  // Match Score
                    { wch: 15 },  // Composite Score
                    { wch: 25 },  // PI
                    { wch: 15 },  // Site Code
                    { wch: 35 },  // Address
                    { wch: 25 },  // Email
                    { wch: 20 },  // Website
                    { wch: 15 },  // Enrollment Rate
                    { wch: 15 },  // Retention Rate
                    { wch: 18 },  // Time to Activate
                    { wch: 12 },  // Past Trials
                    { wch: 18 },  // Query Turnaround
                    { wch: 20 },  // Lab Certifications
                    { wch: 15 },  // On-site Lab
                    { wch: 12 },  // Pharmacy
                    { wch: 20 },  // Imaging
                    { wch: 25 },  // Therapeutic Areas
                    { wch: 12 }   // CRC Count
                ];
                ws['!cols'] = colWidths;
                
                // Add auto-filter to the entire data range
                ws['!autofilter'] = { ref: ws['!ref'] };
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Sites');
                XLSX.writeFile(wb, `sites-${(scenario.title||'scenario').replace(/\s+/g,'-')}.xlsx`);
            } catch (e) {
                console.error('Excel export failed', e);
            } finally {
                setIsExportingExcel(false);
            }
        }, 100);
    };



    if (!scenario) {
        return <div className="p-8">Error: No scenario data found. <button onClick={() => navigateTo('projects')} className="flex items-center gap-2 text-blue-600 hover:underline">
            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Go back
        </button></div>;
    }

    const toggleRow = (rank) => {
        const newSet = new Set(expandedRows);
        if (newSet.has(rank)) {
            newSet.delete(rank);
        } else {
            newSet.add(rank);
        }
        setExpandedRows(newSet);
    };


    
    const handleExport = async () => {
        setIsExportingPdf(true);
        
        const exportContainer = pdfExportRef.current;
        if (!exportContainer) {
            setIsExportingPdf(false);
            return;
        }

        try {
            const { jsPDF } = window.jspdf;
            
            // Use landscape orientation for better content fitting
            const pdf = new jsPDF({
                orientation: 'l', // landscape
                unit: 'mm',
                format: 'a4'
            });

            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            
            // Capture with better quality and fit
            const canvas = await window.html2canvas(exportContainer, { 
                scale: 1.5, // Reduced scale for better fitting
                useCORS: true,
                width: exportContainer.scrollWidth,
                height: exportContainer.scrollHeight
            });
            
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = canvas.width;
            const imgHeight = canvas.height;
            
            // Calculate dimensions to fit content properly
            const ratio = imgWidth / imgHeight;
            let newImgWidth = pdfWidth;
            let newImgHeight = pdfWidth / ratio;
            
            // If height is too large, scale down proportionally
            if (newImgHeight > pdfHeight) {
                newImgHeight = pdfHeight;
                newImgWidth = pdfHeight * ratio;
            }
            
            // Center the image on the page
            const xOffset = (pdfWidth - newImgWidth) / 2;
            const yOffset = (pdfHeight - newImgHeight) / 2;
            
            pdf.addImage(imgData, 'PNG', xOffset, yOffset, newImgWidth, newImgHeight);
            
            pdf.save(`scenario-results-${scenario.title.replace(/\s+/g, '-')}.pdf`);
        } catch (error) {
            console.error('PDF export failed:', error);
        } finally {
            setIsExportingPdf(false);
        }
    };


    return (
        <div className="p-4 sm:p-6 lg:p-8 max-w-screen-2xl mx-auto">
            <header className="mb-6 flex items-center justify-between">
                <div>
                    {/* Breadcrumbs */}
                    <nav className="flex items-center space-x-2 text-sm text-gray-500 mb-4">
                        <button 
                            onClick={() => navigateTo('projects')} 
                            className="hover:text-blue-600 transition-colors"
                        >
                            Projects
                        </button>
                        <span className="text-gray-400">/</span>
                        {currentProject && (
                            <>
                                <button 
                                    onClick={() => navigateTo('scenarios', currentProject)} 
                                    className="hover:text-blue-600 transition-colors"
                                >
                                    {currentProject.name}
                                </button>
                                <span className="text-gray-400">/</span>
                            </>
                        )}
                        <span className="text-gray-900 font-medium">{scenario.title}</span>
                    </nav>
                    <h1 className="text-3xl font-bold text-gray-900">{scenario.title}</h1>
                    <p className="text-gray-500 mt-1">Results and site ranking based on your criteria.</p>
                </div>
                <div className="flex items-center gap-4">
                    {scenario.isPreview && (
                        <button onClick={() => onSave(scenario)} className="btn-gradient flex items-center gap-2 px-4 py-2 font-semibold rounded-md transition-all">
                            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                            </svg>
                            Save Scenario
                        </button>
                    )}
                    <button onClick={handleExportExcel} disabled={isExportingExcel} className="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white flex items-center gap-2 px-4 py-2 font-semibold rounded-md transition-all disabled:opacity-50 shadow-md hover:shadow-lg">
                        {isExportingExcel ? <LoadingSpinner className="w-5 h-5" /> : <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>}
                        {isExportingExcel ? 'Exporting...' : 'Export to Excel'}
                    </button>
                    <button onClick={handleExport} disabled={isExportingPdf} className="bg-gradient-to-r from-purple-500 to-violet-600 hover:from-purple-600 hover:to-violet-700 text-white flex items-center gap-2 px-4 py-2 font-semibold rounded-md transition-all disabled:opacity-50 shadow-md hover:shadow-lg">
                        {isExportingPdf ? <LoadingSpinner className="w-5 h-5" /> : <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>}
                        {isExportingPdf ? 'Exporting...' : 'Export to PDF'}
                    </button>
                </div>
            </header>



            <div className="grid grid-cols-1 lg:grid-cols-1 gap-6 lg:gap-8">
                {/* Main Content: Site Ranking */}
                <div className="lg:col-span-1">
                    <div ref={exportRef} className="bg-white p-4 rounded-lg border border-gray-200">
                        <div className="mb-6 p-4 border-b">
                            <h3 className="text-lg font-semibold text-gray-700 mb-3">Objective</h3>
                            <p className="text-sm text-gray-600">{scenario.objective}</p>
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4 p-4">
                            {scenario.sponsor && (
                                <div className="text-sm"><span className="font-medium text-gray-600">Sponsor: </span><span className="font-semibold text-gray-900">{scenario.sponsor}</span></div>
                            )}
                            {scenario.studyId && (
                                <div className="text-sm"><span className="font-medium text-gray-600">Study ID: </span><span className="font-semibold text-gray-900">{scenario.studyId}</span></div>
                            )}
                        </div>
                        <div className="mb-6 p-4">
                            <h3 className="text-lg font-semibold text-gray-700 mb-3">Criteria Weights</h3>
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-x-8 gap-y-2">
                                {Object.entries(scenario?.criteriaWeights || {}).map(([key, value]) => (
                                    <div key={key} className="text-sm">
                                        <span className="font-medium capitalize">{key.replace(/([A-Z])/g, ' $1')}: </span>
                                        <span className="font-bold text-blue-600">{value}%</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="flex justify-between items-center mb-4 px-4">
                             <div className="flex items-center gap-4">
                                <h3 className="text-lg font-semibold text-gray-700">Site Rankings</h3>
                                <button 
                                    onClick={handleCompareSites}
                                    disabled={selectedSites.length < 2}
                                    className={`comparison-button flex items-center gap-2 px-4 py-2 font-semibold rounded-md transition-colors ${
                                        selectedSites.length >= 2 
                                            ? 'btn-gradient' 
                                            : 'text-gray-400 bg-gray-200 cursor-not-allowed'
                                    }`}
                                >
                                    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                    </svg>
                                    Compare ({selectedSites.length})
                                </button>
                             </div>
                            <div className="inline-flex rounded-md shadow-sm">
                                <button onClick={() => setView('table')} className={`flex items-center gap-2 px-4 py-2 font-medium ${view === 'table' ? 'btn-gradient' : 'bg-white text-gray-700 hover:bg-gray-50'} rounded-l-lg border border-gray-200`}>
                                    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h18v18H3V3zm2 2v14h14V5H5zm2 2h10v2H7V7zm0 4h10v2H7v-2zm0 4h7v2H7v-2z" />
                                    </svg>
                                    Table View
                                </button>
                                <button onClick={() => setView('card')} className={`flex items-center gap-2 px-4 py-2 text-sm font-medium ${view === 'card' ? 'btn-gradient' : 'bg-white text-gray-700 hover:bg-gray-50'} rounded-r-lg border border-gray-200`}>
                                    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2H5a2 2 0 00-2 2v2m14 0V5a2 2 0 00-2-2H5a2 2 0 00-2 2v2" />
                                    </svg>
                                    Card View
                                </button>
                            </div>
                        </div>
                        {view === 'table' ? (
                            <>
                                <SiteTable sites={currentSites} expandedRows={expandedRows} toggleRow={toggleRow} navigateTo={navigateTo} onSelect={handleSiteSelect} selectedSites={selectedSites} />
                                {totalPages > 1 && (
                                    <Pagination 
                                        currentPage={currentPage} 
                                        totalPages={totalPages} 
                                        onPageChange={handlePageChange} 
                                    />
                                )}
                            </>
                        ) : (
                            <div className="p-4">
                                <SiteCardView sites={scenario.siteRankings?.slice(0, displayedSites) || []} navigateTo={navigateTo} onSelect={handleSiteSelect} selectedSites={selectedSites} />
                                {isLoadingMore && (
                                    <div className="flex justify-center mt-6">
                                        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                                    </div>
                                )}
                                {displayedSites < (scenario.siteRankings?.length || 0) && !isLoadingMore && (
                                    <div className="text-center mt-6">
                                        <button 
                                            onClick={loadMoreSites}
                                            className="btn-gradient flex items-center gap-2 px-6 py-3 text-sm font-medium rounded-lg transition-all"
                                        >
                                            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                            </svg>
                                            Load More Sites ({scenario.siteRankings.length - displayedSites} remaining)
                                        </button>
                                        <p className="text-gray-500 mt-2">Or scroll down to load automatically</p>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            </div>
            
            {/* Hidden component for PDF export */}
            <div className="absolute -left-[9999px] top-auto w-[1200px] p-6 bg-white" ref={pdfExportRef}>
                <PdfExportContent scenario={scenario} />
            </div>
        </div>
    );
}

// --- Reusable Form & UI Components ---

const InputField = ({ label, name, value = '', ...props }) => {
    const isRequired = label.includes('*');
    const displayLabel = label.replace('*', '');
    
    return (
        <div>
            <label htmlFor={name} className="block text-sm font-medium text-gray-700 mb-1">
                {displayLabel}
                {isRequired && <span className="text-red-500 ml-1">*</span>}
            </label>
            <input id={name} name={name} value={value} {...props} className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" />
        </div>
    );
};

const TextAreaField = ({ label, name, value = '', ...props }) => (
    <div>
        <label htmlFor={name} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
        <textarea id={name} name={name} value={value} rows="4" {...props} className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" />
    </div>
);


const SliderField = ({ label, name, value = 50, onChange }) => (
    <div>
        <div className="flex justify-between items-center mb-1">
            <label className="text-sm font-medium text-gray-700">{label}</label>
            <span className="text-sm font-semibold text-gray-800 bg-blue-100 px-2 py-1 rounded-md">{value}%</span>
        </div>
        <input
            type="range"
            name={name}
            min="0"
            max="100"
            value={value}
            onChange={onChange}
            className="w-full h-2 bg-blue-50 rounded-lg appearance-none cursor-pointer sleek-slider"
            style={{ '--value-percent': `${value}%` }}
        />
    </div>
);

function CustomDropdown({ options, selected, onSelect, label }) {
    const [isOpen, setIsOpen] = useState(false);
    const dropdownRef = useRef(null);

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                setIsOpen(false);
            }
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);

    return (
        <div className="flex items-center gap-2" ref={dropdownRef}>
            <label className="text-sm font-medium text-gray-700 whitespace-nowrap">{label}</label>
            <div className="relative">
                <button type="button" onClick={() => setIsOpen(!isOpen)} className="flex items-center justify-between w-48 px-3 py-2 text-left bg-white border border-gray-300 rounded-md shadow-sm">
                    <span className="truncate">{selected}</span>
                    <ChevronDownIcon className={`w-5 h-5 text-gray-400 transition-transform flex-shrink-0 ${isOpen ? 'transform rotate-180' : ''}`} />
                </button>
                {isOpen && (
                    <div className="absolute z-10 w-48 mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto">
                        {options.map(option => (
                            <div key={option} onClick={() => { onSelect(option); setIsOpen(false); }} className="px-3 py-2 cursor-pointer hover:bg-gray-100 text-sm">
                                {option}
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </div>
    );
}

const CustomDropdownField = ({ label, options, selected, onSelect }) => {
    const [isOpen, setIsOpen] = useState(false);
    const dropdownRef = useRef(null);
    const isRequired = label.includes('*');
    const displayLabel = label.replace('*', '');

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                setIsOpen(false);
            }
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);

    return (
        <div ref={dropdownRef}>
            <label className="block text-sm font-medium text-gray-700 mb-1">
                {displayLabel}
                {isRequired && <span className="text-red-500 ml-1">*</span>}
            </label>
            <div className="relative">
                <button type="button" onClick={() => setIsOpen(!isOpen)} className="w-full flex items-center justify-between px-3 py-2 text-left bg-white border border-gray-300 rounded-md shadow-sm">
                    <span>{selected}</span>
                    <ChevronDownIcon className={`w-5 h-5 text-gray-400 transition-transform ${isOpen ? 'transform rotate-180' : ''}`} />
                </button>
                {isOpen && (
                    <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg">
                        {options.map(option => (
                            <div key={option} onClick={() => { onSelect(option); setIsOpen(false); }} className="px-3 py-2 cursor-pointer hover:bg-gray-100">
                                {option}
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </div>
    );
};

const MultiSelectDropdownField = ({ label, options, selected, onSelect }) => {
    const [isOpen, setIsOpen] = useState(false);
    const dropdownRef = useRef(null);

    const handleToggleOption = (option) => {
        const newSelected = selected.includes(option)
            ? selected.filter(item => item !== option)
            : [...selected, option];
        onSelect(newSelected);
    };

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                setIsOpen(false);
            }
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);

    return (
        <div ref={dropdownRef}>
            <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
            <div className="relative">
                <button type="button" onClick={() => setIsOpen(!isOpen)} className="w-full flex items-center justify-between px-3 py-2 text-left bg-white border border-gray-300 rounded-md shadow-sm min-h-[42px]">
                    <div className="flex flex-wrap gap-1">
                        {selected.length > 0 ? selected.map(item => (
                            <span key={item} className="px-2 py-0.5 text-sm bg-blue-100 text-blue-800 rounded-full">{item}</span>
                        )) : <span className="text-gray-500">Select regions...</span>}
                    </div>
                    <ChevronDownIcon className={`w-5 h-5 text-gray-400 transition-transform ${isOpen ? 'transform rotate-180' : ''}`} />
                </button>
                {isOpen && (
                    <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto">
                        {options.map(option => (
                            <div key={option} onClick={() => handleToggleOption(option)} className="flex items-center justify-between px-3 py-2 cursor-pointer hover:bg-gray-100">
                                <span>{option}</span>
                                {selected.includes(option) && <CheckIcon className="w-5 h-5 text-blue-600" />}
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </div>
    );
};

function Tooltip({ children, text }) {
    const [show, setShow] = useState(false);
    const [position, setPosition] = useState({ x: 0, y: 0 });
    
    const handleMouseEnter = (e) => {
        const rect = e.currentTarget.getBoundingClientRect();
        const tooltipWidth = 200; // Approximate tooltip width
        
        // Calculate position to center the tooltip above the element
        // Use the exact center of the triggering element
        let left = rect.left + (rect.width / 2);
        
        // Ensure tooltip doesn't go off-screen
        if (left - tooltipWidth / 2 < 0) {
            left = tooltipWidth / 2;
        } else if (left + tooltipWidth / 2 > window.innerWidth) {
            left = window.innerWidth - tooltipWidth / 2;
        }
        
        setPosition({
            x: left,
            y: rect.top - 8
        });
        setShow(true);
    };
    
    const handleMouseLeave = () => {
        setShow(false);
    };
    
    return (
        <>
            <div onMouseEnter={handleMouseEnter} onMouseLeave={handleMouseLeave}>
                {children}
            </div>
            {show && (
                <div 
                    className="fixed z-[9999] px-3 py-2 bg-gray-900 text-white text-xs rounded-lg shadow-xl max-w-xs text-left whitespace-pre-line"
                    style={{
                        left: `${position.x}px`,
                        top: `${position.y}px`,
                        transform: 'translateX(-50%) translateY(-100%)'
                    }}
                >
                    {text}
                    <div className="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900" style={{ marginLeft: '-2px' }}></div>
                </div>
            )}
        </>
    );
}

function ChatPanel({ messages, onSubmit, isLoading }) {
    const [input, setInput] = useState('');
    const messagesEndRef = useRef(null);

    useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    }, [messages]);

    const handleSubmit = (e) => {
        e.preventDefault();
        if (input.trim() && !isLoading) {
            onSubmit(input.trim());
            setInput('');
        }
    };

    return (
        <div className="bg-white rounded-lg border border-gray-200 flex flex-col h-[70vh]">
            <h2 className="text-lg font-semibold p-4 border-b border-gray-200 flex items-center gap-2">
                <SparklesIcon className="w-5 h-5 text-blue-500" />
                Ask about this result
            </h2>
            <div className="flex-grow p-4 overflow-y-auto space-y-4">
                {messages.map((msg, index) => (
                    <div key={index} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                        <div className={`max-w-[80%] p-3 rounded-lg ${msg.sender === 'user' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800'}`}>
                            {msg.text}
                        </div>
                    </div>
                ))}
                {isLoading && (
                    <div className="flex justify-start">
                        <div className="max-w-[80%] p-3 rounded-lg bg-gray-200 text-gray-800">
                            <LoadingSpinner className="w-5 h-5" />
                        </div>
                    </div>
                )}
                <div ref={messagesEndRef} />
            </div>
            <div className="p-4 border-t border-gray-200">
                <form onSubmit={handleSubmit} className="relative">
                    <input
                        type="text"
                        value={input}
                        onChange={(e) => setInput(e.target.value)}
                        placeholder="Ask a question..."
                        className="w-full pr-12 px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                        disabled={isLoading}
                    />
                    <button
                        type="submit"
                        disabled={!input.trim() || isLoading}
                        className="absolute right-2 top-1/2 transform -translate-y-1/2 p-1.5 text-gray-400 hover:text-blue-600 disabled:text-gray-300 disabled:cursor-not-allowed transition-colors"
                    >
                        <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    );
}

function SiteTable({ sites, expandedRows, toggleRow, navigateTo, onSelect, selectedSites }) {
    if (!sites || sites.length === 0) {
        return (
            <div className="bg-white rounded-lg border border-gray-200 p-8 text-center">
                <div className="text-gray-500">
                    <svg className="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                    <h3 className="text-lg font-medium text-gray-900 mb-2">No sites found</h3>
                    <p className="text-gray-500">No sites match the current criteria.</p>
                </div>
            </div>
        );
    }

    return (
        <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50 sticky top-0 z-10">
                    <tr>
                        <th className="px-6 py-3"></th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Site</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">State</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Match Score</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Composite Score</th>
                        <th className="relative px-6 py-3"><span className="sr-only">Actions</span></th>
                    </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                    {sites.map(site => (
                        <React.Fragment key={site.rank}>
                            <tr>
                                <td className="px-6 py-4" onClick={(e) => e.stopPropagation()}>
                                    <input 
                                        type="checkbox" 
                                        checked={selectedSites.includes(site.siteCode)}
                                        onChange={() => onSelect(site.siteCode)}
                                        className="site-checkbox"
                                    />
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{site.rank}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-800 cursor-pointer hover:text-blue-600 hover:underline" onClick={() => navigateTo('siteDetail', site)}>{site.site}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{site.state}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-800">
                                    <div className="flex justify-center">
                                        <Tooltip text={getMatchScoreReasoning(site.matchScore, site.details)}>
                                            <span className={`match-score-badge px-2 py-1 text-xs font-semibold rounded-full ${
                                                site.matchScore >= 90 ? 'bg-green-100 text-green-800' :
                                                site.matchScore >= 80 ? 'bg-blue-100 text-blue-800' :
                                                site.matchScore >= 70 ? 'bg-yellow-100 text-yellow-800' :
                                                'bg-red-100 text-red-800'
                                            }`}>
                                                {site.matchScore}%
                                            </span>
                                        </Tooltip>
                                    </div>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">{site.compositeScore}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <div className="flex items-center gap-3 justify-end">
                                        <button onClick={() => navigateTo('siteDetail', site)} className="text-blue-600 hover:text-blue-800 hover:underline">
                                            View Details
                                        </button>
                                        <button onClick={() => toggleRow(site.rank)} className="text-indigo-600 hover:text-indigo-900">
                                            {expandedRows.has(site.rank) ? (
                                                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                                                </svg>
                                            ) : (
                                                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                                </svg>
                                            )}
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {expandedRows.has(site.rank) && (
                                <tr>
                                    <td colSpan="7" className="px-6 py-3 bg-gray-50">
                                        <ExpandedRowContent details={site.details} />
                                    </td>
                                </tr>
                            )}
                        </React.Fragment>
                    ))}
                </tbody>
            </table>
        </div>
    );
}

function SiteCardView({ sites, navigateTo, onSelect, selectedSites }) {
    if (!sites || sites.length === 0) {
        return (
            <div className="text-center py-8">
                <p className="text-gray-500">No sites available for display</p>
            </div>
        );
    }

    return (
        <div className="responsive-grid">
            {sites.map(site => (
                <div key={site.siteCode || site.rank} className="bg-white rounded-lg border border-gray-200 p-5 shadow-sm hover:shadow-md transition-shadow">
                    <div className="flex justify-between items-start mb-3">
                        <div className="flex items-center gap-3">
                            <input 
                                type="checkbox" 
                                checked={selectedSites.includes(site.siteCode)}
                                onChange={() => onSelect(site.siteCode)}
                                className="site-checkbox"
                            />
                            <div>
                                <p className="text-xs text-gray-500">Rank #{site.rank}</p>
                                <h3 className="font-bold text-lg text-gray-900">{site.site}</h3>
                                <p className="text-sm text-gray-600">{site.state}</p>
                            </div>
                        </div>
                        <div className="text-right">
                            <p className="text-xs text-gray-500">Composite</p>
                            <p className="font-bold text-2xl text-blue-600">{site.compositeScore}</p>
                        </div>
                    </div>
                    
                    <div className="text-sm space-y-2">
                        <div className="flex justify-between items-center">
                            <span className="text-gray-600">Match Score:</span>
                            <Tooltip text={getMatchScoreReasoning(site.matchScore, site.details)}>
                                <span className={`match-score-badge px-2 py-1 text-xs font-semibold rounded-full ${
                                    site.matchScore >= 90 ? 'bg-green-100 text-green-800' :
                                    site.matchScore >= 80 ? 'bg-blue-100 text-blue-800' :
                                    site.matchScore >= 70 ? 'bg-yellow-100 text-yellow-800' :
                                    'bg-red-100 text-red-800'
                                }`}>
                                    {site.matchScore}%
                                </span>
                            </Tooltip>
                        </div>
                        
                        <div className="flex justify-between">
                            <span className="text-gray-600">Enrollment Rate:</span>
                            <span className="font-semibold">{site.details?.operationalPerformance?.enrollmentRate || 'N/A'}</span>
                        </div>
                        
                        <div className="flex justify-between">
                            <span className="text-gray-600">Activation Time:</span>
                            <span className="font-semibold">{site.details?.operationalPerformance?.timeToActivate || 'N/A'}</span>
                        </div>
                        
                        <div className="flex justify-between">
                            <span className="text-gray-600">Past Trials:</span>
                            <span className="font-semibold">{site.details?.operationalPerformance?.pastTrials || 'N/A'}</span>
                        </div>
                        
                        <div className="flex justify-between">
                            <span className="text-gray-600">CRC Staff:</span>
                            <span className="font-semibold">{site.details?.clinicalCapabilities?.crcCount || 'N/A'}</span>
                        </div>
                    </div>
                    
                    <div className="mt-4 pt-3 border-t border-gray-100">
                        <button 
                            onClick={() => navigateTo('siteDetail', site)} 
                            className="text-sm font-semibold text-indigo-600 hover:text-indigo-700 transition-colors"
                        >
                            View Details &rarr;
                        </button>
                    </div>
                </div>
            ))}
        </div>
    );
}

const PdfExportContent = ({ scenario }) => {
    if (!scenario) {
        return <div>No scenario data available for PDF export</div>;
    }
    
    return (
    <div className="pdf-export-container">
        <div id="pdf-header-section" className="mb-8">
            <div className="mb-6 p-6 border-b-2 border-gray-300">
                <h2 className="text-3xl font-bold text-gray-800 mb-6">{scenario.title || 'Untitled Scenario'}</h2>
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-x-12 gap-y-4 text-base">
                    <div className="flex flex-col"><span className="font-semibold text-gray-600">Indication:</span> <span className="text-gray-800">{scenario.indication || 'N/A'}</span></div>
                    <div className="flex flex-col"><span className="font-semibold text-gray-600">Phase:</span> <span className="text-gray-800">{scenario.phase || 'N/A'}</span></div>
                    <div className="flex flex-col"><span className="font-semibold text-gray-600">Drug:</span> <span className="text-gray-800">{scenario.drugInfo || 'N/A'}</span></div>
                    <div className="flex flex-col"><span className="font-semibold text-gray-600">Start Date:</span> <span className="text-gray-800">{scenario.startDate || 'N/A'}</span></div>
                </div>
            </div>
            <div className="mb-6 p-6">
                <h3 className="text-xl font-semibold text-gray-700 mb-4">Criteria Weights</h3>
                <div className="grid grid-cols-2 lg:grid-cols-3 gap-x-12 gap-y-3">
                    {Object.entries(scenario?.criteriaWeights || {}).map(([key, value]) => (
                        <div key={key} className="text-base">
                            <span className="font-medium capitalize">{key.replace(/([A-Z])/g, ' $1')}: </span>
                            <span className="font-bold text-blue-600">{value}%</span>
                        </div>
                    ))}
                </div>
            </div>
        </div>
        <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-300 border-2 border-gray-300">
                <thead className="bg-gray-100">
                    <tr>
                        <th className="px-8 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider border-r border-gray-300">Rank</th>
                        <th className="px-8 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider border-r border-gray-300">Site</th>
                        <th className="px-8 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider border-r border-gray-300">State</th>
                        <th className="px-8 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider border-r border-gray-300">Match Score</th>
                        <th className="px-8 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider">Composite Score</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-gray-300">
                    {(scenario.siteRankings || []).map(site => (
                        <tr key={site.rank || site.siteCode || Math.random()} className="pdf-site-section bg-white">
                            <td className="px-8 py-4 text-base font-medium text-gray-900 border-r border-gray-300">{site.rank || 'N/A'}</td>
                            <td className="px-8 py-4 text-base text-gray-800 border-r border-gray-300">{site.site || 'N/A'}</td>
                            <td className="px-8 py-4 text-base text-gray-500 border-r border-gray-300">{site.state || 'N/A'}</td>
                            <td className="px-8 py-4 text-base font-semibold text-gray-800 border-r border-gray-300">
                                {site.matchScore || 0}%
                            </td>
                            <td className="px-8 py-4 text-base font-bold text-gray-900">{site.compositeScore || 'N/A'}</td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
    </div>
    );
};

function ExpandedRowContent({ details }) {
    // Add null check to prevent errors
    if (!details) {
        return (
            <div className="p-4 text-center text-gray-500">
                <p>Site details not available</p>
            </div>
        );
    }
    
    return (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <DetailCard title="Past Performance">
                <DetailItem label="Trials Conducted" value={details.operationalPerformance?.pastTrials || 'N/A'} />
                <DetailItem label="Enrollment Rate" value={details.operationalPerformance?.enrollmentRate || 'N/A'} />
                <DetailItem label="Retention Rate" value={details.operationalPerformance?.retentionRate || 'N/A'} />
                <DetailItem label="Time to Activate" value={details.operationalPerformance?.timeToActivate || 'N/A'} />
            </DetailCard>
            <DetailCard title="Patient Population">
                <DetailItem label="Total Registry Size" value={details.clinicalCapabilities?.patientAccess || 'N/A'} />
                <DetailItem label="Therapeutic Areas" value={details.clinicalCapabilities?.therapeuticAreas?.join(', ') || 'N/A'} />
            </DetailCard>
            <DetailCard title="Infrastructure">
                <DetailItem label="On-site Lab" value={details.infrastructure?.onSiteLab || 'N/A'} />
                <DetailItem label="Imaging Facilities" value={details.infrastructure?.imaging?.join(', ') || 'N/A'} />
            </DetailCard>
            <DetailCard title="Site Info">
                <DetailItem label="Principal Investigator" value={details.siteInfo?.pi || 'N/A'} />
                <DetailItem label="Contact Info">
                    {details.siteInfo?.contact ? (
                        <a href={`mailto:${details.siteInfo.contact}`} className="text-blue-600 hover:underline break-all">{details.siteInfo.contact}</a>
                    ) : (
                        'N/A'
                    )}
                </DetailItem>
            </DetailCard>
        </div>
    );
}

const DetailCard = ({ title, children }) => (
    <div className="bg-white p-4 rounded-lg border border-gray-200">
        <h4 className="font-bold text-md mb-3 text-gray-800">{title}</h4>
        <div className="space-y-2">{children}</div>
    </div>
);

const DetailItem = ({ label, value, children }) => (
    <div className="min-w-0">
        <p className="text-xs text-gray-500">{label}</p>
        <p className="text-sm font-medium text-gray-900 break-words">{value || children}</p>
    </div>
);

function Pagination({ currentPage, totalPages, onPageChange }) {
    const pageNumbers = [];
    for (let i = 1; i <= totalPages; i++) {
        pageNumbers.push(i);
    }

    return (
        <div className="flex justify-center items-center mt-8">
            {/* Previous Button */}
            <button
                onClick={() => onPageChange(currentPage - 1)}
                disabled={currentPage === 1}
                className="px-3 py-2 mx-1 rounded-md bg-white border border-gray-300 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50 transition-colors"
            >
                <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            
            {/* Mobile: Show only current page */}
            <div className="block sm:hidden">
                <span className="px-4 py-2 mx-1 text-sm font-medium text-gray-700 bg-blue-50 border border-blue-200 rounded-md">
                    {currentPage} of {totalPages}
                </span>
            </div>
            
            {/* Desktop: Show all page numbers */}
            <div className="hidden sm:flex">
                {pageNumbers.map(number => (
                    <button
                        key={number}
                        onClick={() => onPageChange(number)}
                        className={`px-3 py-2 mx-1 rounded-md border transition-colors ${
                            currentPage === number 
                                ? 'btn-gradient' 
                                : 'bg-white border-gray-300 hover:bg-gray-50'
                        }`}
                    >
                        {number}
                    </button>
                ))}
            </div>
            
            {/* Next Button */}
            <button
                onClick={() => onPageChange(currentPage + 1)}
                disabled={currentPage === totalPages}
                className="px-3 py-2 mx-1 rounded-md bg-white border border-gray-300 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50 transition-colors"
            >
                <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </div>
    );
}

function ComparisonPage({ scenarios, navigateTo, projects, currentProject }) {
    const [hideIdentical, setHideIdentical] = useState(false);



    if (!scenarios || scenarios.length < 2) {
        return (
            <div className="p-8 text-center">
                <h1 className="text-2xl font-bold mb-4">Comparison</h1>
                <p>Select two or more scenarios to compare.</p>
                <p className="text-sm text-gray-500 mt-2">
                    Received {scenarios ? scenarios.length : 0} scenarios
                </p>
                <p className="text-sm text-gray-500 mt-1">
                    {!scenarios ? 'No scenarios data provided' : scenarios.length === 0 ? 'Empty scenarios array' : 'Insufficient scenarios for comparison'}
                </p>
                <button onClick={() => {
                    // Navigate back to scenarios with the project context
                    if (scenarios && scenarios.length > 0 && scenarios[0].projectId) {
                        const project = projects.find(p => p.id === scenarios[0].projectId);
                        if (project) {
                            navigateTo('scenarios', project);
                        } else {
                            navigateTo('projects');
                        }
                    } else {
                        navigateTo('projects');
                    }
                }} className="flex items-center gap-2 mt-4 px-4 py-2 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700">
                    <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Scenarios
                </button>
            </div>
        );
    }

    const handleHideIdenticalChange = (e) => {
        setHideIdentical(e.target.checked);
    };

    // Helper function to check if values are identical
    const isRowIdentical = (values) => {
        return values.every(val => val === values[0] && val !== 'N/A' && val !== '');
    };

    // Helper function to render a table row with conditional hiding
    const renderTableRow = (label, getValue) => {
        const values = scenarios.map(getValue);
        const isIdentical = isRowIdentical(values);
        
        // Hide row if hideIdentical is checked and row is identical
        if (hideIdentical && isIdentical) {
            return null;
        }
        
        return (
            <tr key={label} className={isIdentical ? 'identical-row' : ''}>
                <td className="px-6 py-4 text-sm font-medium text-gray-700 sticky left-0 z-30 bg-white border-r border-gray-200">{label}</td>
                {scenarios.map(s => (
                    <td key={s.id+String(label)} className="px-6 py-4 text-sm text-gray-800">{getValue(s) || '-'}</td>
                ))}
            </tr>
        );
    };

    return (
        <div className="p-4 sm:p-6 lg:p-8 max-w-screen-2xl mx-auto">
            <header className="mb-6 flex items-center justify-between">
                <div>
                    {/* Breadcrumbs */}
                    <nav className="flex items-center space-x-2 text-sm text-gray-500 mb-4">
                        <button 
                            onClick={() => navigateTo('projects')} 
                            className="hover:text-blue-600 transition-colors"
                        >
                            Projects
                        </button>
                        <span className="text-gray-400">/</span>
                        {currentProject && (
                            <>
                                <button 
                                    onClick={() => navigateTo('scenarios', currentProject)} 
                                    className="hover:text-blue-600 transition-colors"
                                >
                                    {currentProject.name}
                                </button>
                                <span className="text-gray-400">/</span>
                            </>
                        )}
                        <span className="text-gray-900 font-medium">Scenario Comparison ({scenarios.length})</span>
                    </nav>
                    <h1 className="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Scenario Comparison ({scenarios.length})</h1>
                    <p className="text-gray-500">Review key attributes side-by-side and deep-dive into full site results for each scenario.</p>
                </div>
            </header>

            {/* Overview matrix header */}
            <div className="mb-8">
                <div className="flex justify-between items-center mb-4">
                    <h3 className="text-lg font-semibold text-gray-900">Parameters Comparison</h3>
                    <label className="checkbox-container text-sm text-gray-600">
                        <input 
                            type="checkbox" 
                            checked={hideIdentical}
                            onChange={handleHideIdenticalChange}
                        />
                        Hide identical information
                    </label>
                </div>
                <div className="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
                    <div className="overflow-x-auto relative">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gradient-to-r from-gray-50 to-blue-50">
                                <tr>
                                    <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider sticky left-0 z-30 bg-gradient-to-r from-gray-50 to-blue-50 border-r border-gray-200">Field</th>
                                    {scenarios.map(s => (
                                        <th key={s.id} className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase whitespace-nowrap sticky top-0 z-20 bg-gradient-to-r from-gray-50 to-blue-50 border-b border-gray-200">{s.title}</th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200">
                                {[
                                    ['Indication', (s)=>s.indication],
                                    ['Phase', (s)=>s.phase],
                                    ['Drug', (s)=>s.drugInfo],
                                    ['Start Date', (s)=>s.startDate],
                                    ['Objective', (s)=>s.objective],
                                ].map(([label, getter]) => renderTableRow(label, getter))}
                                {/* Criteria weights row */}
                                <tr className="criteria-weights-row">
                                    <td className="px-4 py-3 text-sm font-medium text-gray-700 sticky left-0 z-30 bg-white border-r border-gray-200">Criteria Weights</td>
                                    {scenarios.map(s => (
                                        <td key={s.id+':weights'} className="px-4 py-3 text-sm">
                                            <div className="grid grid-cols-2 gap-2">
                                                {Object.entries(s.criteriaWeights || {}).map(([k,v]) => (
                                                    <div key={k} className="flex justify-between items-center text-xs bg-gradient-to-r from-gray-50 to-blue-50 border border-gray-200 rounded px-2 py-1">
                                                        <span className="capitalize">{String(k).replace(/([A-Z])/g,' $1')}</span>
                                                        <span className="font-semibold text-blue-600">{v}%</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </td>
                                    ))}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            {/* Top 3 Sites Comparison */}
            <div className="bg-white border border-gray-200 rounded-xl shadow-sm p-6 mb-8">
                <h3 className="text-lg font-semibold text-gray-900 mb-6">Top 3 Sites Comparison</h3>
                <div className="responsive-grid">
                    {scenarios.map(s => (
                        <div key={'summary-'+s.id} className="border border-gray-200 rounded-lg p-5 min-w-0">
                            <div className="flex items-center justify-between mb-4">
                                <h4 className="text-md font-semibold text-gray-900 truncate flex-1 mr-3">{s.title}</h4>
                                <span className="px-3 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800 flex-shrink-0">{s.phase}</span>
                            </div>
                            
                            {/* Top 3 Sites Summary */}
                            <div className="space-y-3">
                                {s.siteRankings.slice(0, 3).map((site, index) => (
                                    <div key={site.rank} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg min-w-0">
                                        <div className="flex items-center gap-3 flex-1 min-w-0">
                                            <span className="w-6 h-6 bg-blue-100 text-blue-800 text-xs font-bold rounded-full flex items-center justify-center flex-shrink-0">
                                                {site.rank}
                                            </span>
                                            <span className="text-sm font-medium text-gray-800 truncate flex-1">{site.site}</span>
                                        </div>
                                        <div className="flex items-center gap-2 flex-shrink-0">
                                            <span className="text-xs text-gray-600">{site.state}</span>
                                            <span className="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                                {site.matchScore}%
                                            </span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            
                            {/* Performance Metrics */}
                            <div className="grid grid-cols-2 gap-6 pt-4 mt-4 border-t border-gray-100">
                                <div className="text-center">
                                    <div className="text-xl font-bold text-blue-600">
                                        {s.siteRankings.length}
                                    </div>
                                    <div className="text-xs text-gray-500">Total Sites</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-xl font-bold text-green-600">
                                        {Math.round(s.siteRankings.reduce((sum, site) => sum + site.matchScore, 0) / s.siteRankings.length)}%
                                    </div>
                                    <div className="text-xs text-gray-500">Avg Match</div>
                                </div>
                            </div>
                            
                            {/* View All Sites Button */}
                            <div className="pt-4 mt-4 border-t border-gray-100">
                                <button 
                                    onClick={() => navigateTo('results', s)}
                                    className="w-full flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors"
                                >
                                    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                    </svg>
                                    View All Sites ({s.siteRankings.length})
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            </div>

            {/* Performance Comparison Chart */}
            <div className="bg-white border border-gray-200 rounded-xl shadow-sm p-6 mb-8">
                <h3 className="text-lg font-semibold text-gray-900 mb-6">Performance Comparison</h3>
                
                {/* Enhanced Performance Metrics */}
                <div className="responsive-grid mb-8">
                    {scenarios.map(s => {
                        const avgMatchScore = Math.round(s.siteRankings.reduce((sum, site) => sum + site.matchScore, 0) / s.siteRankings.length);
                        const avgCompositeScore = Math.round(s.siteRankings.reduce((sum, site) => sum + site.compositeScore, 0) / s.siteRankings.length);
                        const topScore = Math.max(...s.siteRankings.map(site => site.matchScore));
                        const consistencyScore = Math.round(100 - (Math.max(...s.siteRankings.map(site => site.matchScore)) - Math.min(...s.siteRankings.map(site => site.matchScore))));
                        
                        return (
                            <div key={s.id} className="bg-gradient-to-br from-blue-50 to-indigo-100 p-4 rounded-lg border border-blue-200 performance-metric">
                                <h4 className="font-semibold text-gray-800 mb-3 text-center">{s.title}</h4>
                                <div className="space-y-2 text-sm">
                                    <div className="flex justify-between items-center">
                                        <span className="text-gray-600">Avg Match Score:</span>
                                        <span className="font-bold text-blue-600">{avgMatchScore}%</span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-gray-600">Avg Composite:</span>
                                        <span className="font-bold text-indigo-600">{avgCompositeScore}</span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-gray-600">Top Score:</span>
                                        <span className="font-bold text-green-600">{topScore}%</span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-gray-600">Consistency:</span>
                                        <span className="font-bold text-purple-600">{consistencyScore}%</span>
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
                
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    {/* Match Score Distribution */}
                    <div>
                        <h4 className="text-sm font-medium text-gray-700 mb-4">Match Score Distribution</h4>
                        <div className="space-y-4">
                            {scenarios.map(s => {
                                const excellent = s.siteRankings.filter(site => site.matchScore >= 90).length;
                                const good = s.siteRankings.filter(site => site.matchScore >= 80 && site.matchScore < 90).length;
                                const moderate = s.siteRankings.filter(site => site.matchScore >= 70 && site.matchScore < 80).length;
                                const poor = s.siteRankings.filter(site => site.matchScore < 70).length;
                                
                                return (
                                    <div key={s.id} className="space-y-3">
                                        <div className="flex items-center justify-between text-sm">
                                            <span className="font-medium text-gray-800 truncate">{s.title}</span>
                                            <span className="text-gray-500 font-semibold">{s.siteRankings.length} sites</span>
                                        </div>
                                        
                                        {/* Enhanced Progress Bar */}
                                        <div className="relative">
                                            <div className="flex gap-1 h-4 rounded-lg overflow-hidden shadow-inner">
                                                <div 
                                                    className="bg-gradient-to-r from-emerald-500 to-green-600 transition-all duration-300" 
                                                    style={{width: `${(excellent/s.siteRankings.length)*100}%`}} 
                                                    title={`Excellent (90%+): ${excellent} sites`}
                                                ></div>
                                                <div 
                                                    className="bg-gradient-to-r from-blue-500 to-cyan-600 transition-all duration-300" 
                                                    style={{width: `${(good/s.siteRankings.length)*100}%`}} 
                                                    title={`Good (80-89%): ${good} sites`}
                                                ></div>
                                                <div 
                                                    className="bg-gradient-to-r from-yellow-500 to-orange-500 transition-all duration-300" 
                                                    style={{width: `${(moderate/s.siteRankings.length)*100}%`}} 
                                                    title={`Moderate (70-79%): ${moderate} sites`}
                                                ></div>
                                                <div 
                                                    className="bg-gradient-to-r from-red-500 to-pink-600 transition-all duration-300" 
                                                    style={{width: `${(poor/s.siteRankings.length)*100}%`}} 
                                                    title={`Poor (<70%): ${poor} sites`}
                                                ></div>
                                            </div>
                                        </div>
                                        
                                        {/* Detailed Legend */}
                                        <div className="grid grid-cols-2 gap-2 text-xs">
                                            <div className="flex items-center gap-2">
                                                <div className="w-3 h-3 bg-gradient-to-r from-emerald-500 to-green-600 rounded"></div>
                                                <span className="text-gray-600">90%+ ({excellent})</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <div className="w-3 h-3 bg-gradient-to-r from-blue-500 to-cyan-600 rounded"></div>
                                                <span className="text-gray-600">80-89% ({good})</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <div className="w-3 h-3 bg-gradient-to-r from-yellow-500 to-orange-500 rounded"></div>
                                                <span className="text-gray-600">70-79% ({moderate})</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <div className="w-3 h-3 bg-gradient-to-r from-red-500 to-pink-600 rounded"></div>
                                                <span className="text-gray-600">&lt;70% ({poor})</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    

                </div>
            </div>

            {/* Key Insights */}
            <div className="bg-white border border-gray-200 rounded-xl shadow-sm p-6">
                <h3 className="text-lg font-semibold text-gray-900 mb-4">Key Insights</h3>
                <div className="responsive-grid">
                    {scenarios.map(s => {
                        const topSite = s.siteRankings[0];
                        const avgScore = Math.round(s.siteRankings.reduce((sum, site) => sum + site.matchScore, 0) / s.siteRankings.length);
                        const highQualitySites = s.siteRankings.filter(site => site.matchScore >= 85).length;
                        
                        return (
                            <div key={s.id} className="space-y-3">
                                <h4 className="font-medium text-gray-800">{s.title}</h4>
                                <div className="space-y-2 text-sm">
                                    <div className="flex justify-between">
                                        <span className="text-gray-600">Best Site:</span>
                                        <span className="font-medium">{topSite?.site || 'N/A'}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-gray-600">Best Score:</span>
                                        <span className="font-medium text-green-600">{topSite?.matchScore || 'N/A'}%</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-gray-600">Avg Score:</span>
                                        <span className="font-medium">{avgScore}%</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-gray-600">High Quality:</span>
                                        <span className="font-medium text-blue-600">{highQualitySites} sites</span>
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            </div>



        </div>
    );
}

const ScenarioDetailColumn = ({ scenario }) => (
    <div className="bg-white p-6 rounded-lg border border-gray-200 space-y-6">
        <h2 className="text-2xl font-bold text-gray-800 border-b pb-4">{scenario.title}</h2>
        
        <div>
            <h3 className="text-lg font-semibold text-gray-700 mb-3">Details</h3>
            <div className="grid grid-cols-2 gap-4 text-sm">
                <DetailItem label="Indication" value={scenario.indication} />
                <DetailItem label="Phase" value={scenario.phase} />
                <DetailItem label="Drug" value={scenario.drugInfo} />
                <DetailItem label="Start Date" value={scenario.startDate} />

            </div>
        </div>

        <div>
            <h3 className="text-lg font-semibold text-gray-700 mb-3">Objective</h3>
            <p className="text-sm text-gray-600">{scenario.objective}</p>
        </div>

        <div>
            <h3 className="text-lg font-semibold text-gray-700 mb-3">Criteria Weights</h3>
            <div className="grid grid-cols-2 gap-x-8 gap-y-2">
                {Object.entries(scenario.criteriaWeights).map(([key, value]) => (
                     <div key={key} className="text-sm">
                        <span className="font-medium capitalize">{key.replace(/([A-Z])/g, ' $1')}: </span>
                        <span className="font-bold text-blue-600">{value}%</span>
                    </div>
                ))}
            </div>
        </div>

        <div>
            <h3 className="text-lg font-semibold text-gray-700 mb-3">Top Ranked Site</h3>
            {scenario.siteRankings && scenario.siteRankings.length > 0 ? (
                <div className="bg-gray-50 p-4 rounded-md">
                    <p className="font-bold text-md">{scenario.siteRankings[0].site}</p>
                    <p className="text-sm text-gray-600">{scenario.siteRankings[0].state}</p>
                    <div className="flex justify-between mt-2 text-sm">
                        <span>Match Score: 
                            <Tooltip text={getMatchScoreReasoning(scenario.siteRankings[0].matchScore, scenario.siteRankings[0].details)}>
                                <span className="font-semibold hover:bg-gray-100 px-1 rounded">{scenario.siteRankings[0].matchScore}%</span>
                            </Tooltip>
                        </span>
                        <span>Composite Score: <span className="font-bold">{scenario.siteRankings[0].compositeScore}</span></span>
                    </div>
                </div>
            ) : <p>No ranking data available.</p>}
        </div>
    </div>
);

function SiteDetailPage({ site, scenario, navigateTo, currentProject }) {
    if (!site) {
        return (
            <div className="p-8 text-center">
                <h1 className="text-2xl font-bold mb-4">Site Not Found</h1>
                <button onClick={() => navigateTo('projects')} className="mt-4 px-4 py-2 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700">
                    Back to Projects
                </button>
            </div>
        );
    }
    const { details } = site;

    return (
        <div className="p-4 sm:p-6 lg:p-8 max-w-screen-2xl mx-auto">
                        <header className="mb-8">
                {/* Breadcrumbs */}
                <nav className="flex items-center space-x-2 text-sm text-gray-500 mb-4">
                    <button 
                        onClick={() => navigateTo('projects')} 
                        className="hover:text-blue-600 transition-colors"
                    >
                        Projects
                    </button>
                    <span className="text-gray-400">/</span>
                    {currentProject && (
                        <>
                            <button 
                                onClick={() => navigateTo('scenarios', currentProject)} 
                                className="hover:text-blue-600 transition-colors"
                            >
                                {currentProject.name}
                            </button>
                            <span className="text-gray-400">/</span>
                        </>
                    )}
                    {scenario && (
                        <>
                            <button 
                                onClick={() => navigateTo('results', scenario)} 
                                className="hover:text-blue-600 transition-colors"
                            >
                                {scenario.title}
                            </button>
                            <span className="text-gray-400">/</span>
                        </>
                    )}
                    <span className="text-gray-900 font-medium">{site.site}</span>
                </nav>
                <h1 className="text-3xl font-bold text-gray-900">{site.site}</h1>
                <p className="text-gray-500 mt-1">{details.siteInfo?.address || 'N/A'}</p>
            </header>
            <div className="space-y-8">
                <DetailSection title="Basic Site Information">
                    <DetailItem label="Site Name" value={site.site} />
                    <DetailItem label="Site Code / Identifier" value={site.siteCode} />
                    <DetailItem label="Address" value={details.siteInfo?.address || 'N/A'} />
                    <DetailItem label="Contact" value={details.siteInfo?.contact || 'N/A'} />
                    <DetailItem label="Website" value={details.siteInfo?.website || 'N/A'} />
                    <DetailItem label="Principal Investigator (PI)" value={details.siteInfo?.pi || 'N/A'} />
                    <DetailItem label="Sub-Investigators" value={details.siteInfo?.subInvestigators?.join(', ') || 'N/A'} />
                    <DetailItem label="Regulatory Authority Approvals" value={details.siteInfo?.regulatoryApprovals || 'N/A'} />
                </DetailSection>

                <DetailSection title="Infrastructure & Facilities">
                    <DetailItem label="On-site Laboratory" value={details.infrastructure?.onSiteLab || 'N/A'} />
                    <DetailItem label="Lab Certifications" value={details.infrastructure?.labCertifications || 'N/A'} />
                    <DetailItem label="Sample Collection & Storage" value={details.infrastructure?.sampleStorage?.join(', ') || 'N/A'} />
                    <DetailItem label="Pharmacy / Investigational Product Storage" value={details.infrastructure?.pharmacy || 'N/A'} />
                    <DetailItem label="Imaging Facilities" value={details.infrastructure?.imaging?.join(', ') || 'N/A'} />
                    <DetailItem label="Emergency Care Facilities" value={details.infrastructure?.emergencyCare || 'N/A'} />
                    <DetailItem label="Number of Hospital Beds" value={details.infrastructure?.hospitalBeds || 'N/A'} />
                    <DetailItem label="Dedicated Clinical Trial Unit" value={details.infrastructure?.dedicatedTrialUnit || 'N/A'} />
                    <DetailItem label="IT Infrastructure" value={details.infrastructure?.itInfrastructure || 'N/A'} />
                </DetailSection>

                <DetailSection title="Clinical Capabilities">
                    <DetailItem label="Therapeutic Areas of Expertise" value={details.clinicalCapabilities?.therapeuticAreas?.join(', ') || 'N/A'} />
                    <DetailItem label="Available Testing Facilities" value={details.clinicalCapabilities?.testingFacilities?.join(', ') || 'N/A'} />
                    <DetailItem label="Access to Patient Populations" value={details.clinicalCapabilities?.patientAccess || 'N/A'} />
                    <DetailItem label="Number of Trained CRCs" value={details.clinicalCapabilities?.crcCount || 'N/A'} />
                    <DetailItem label="GCP Training Records" value={details.clinicalCapabilities?.gcpTrained || 'N/A'} />
                    <DetailItem label="Language & Translation Support" value={details.clinicalCapabilities?.languageSupport || 'N/A'} />
                </DetailSection>
                
                <DetailSection title="Operational Performance">
                    <DetailItem label="Past Trials Conducted" value={details.operationalPerformance?.pastTrials || 'N/A'} />
                    <DetailItem label="Enrollment Performance" value={details.operationalPerformance?.enrollmentRate || 'N/A'} />
                    <DetailItem label="Retention Rates" value={details.operationalPerformance?.retentionRate || 'N/A'} />
                    <DetailItem label="Query Resolution Turnaround Time" value={details.operationalPerformance?.queryTurnaround || 'N/A'} />
                    <DetailItem label="Protocol Deviation History" value={details.operationalPerformance?.deviationHistory || 'N/A'} />
                    <DetailItem label="Inspection / Audit History" value={details.operationalPerformance?.auditHistory || 'N/A'} />
                    <DetailItem label="Adverse Event Reporting Compliance" value={details.operationalPerformance?.aeReporting || 'N/A'} />
                </DetailSection>
                
                <DetailSection title="Quality & Compliance">
                    <DetailItem label="SOPs for Clinical Research" value={details.qualityCompliance?.sops || 'N/A'} />
                    <DetailItem label="Ethics Committee / IRB Details" value={details.qualityCompliance?.irb || 'N/A'} />
                    <DetailItem label="Regulatory Submissions Experience" value={details.qualityCompliance?.regulatorySubmissions || 'N/A'} />
                    <DetailItem label="Data Protection & Patient Confidentiality Compliance" value={details.qualityCompliance?.dataProtection || 'N/A'} />
                </DetailSection>

                <DetailSection title="Additional Notes">
                    <DetailItem label="Affiliations" value={details.additionalNotes?.affiliations || 'N/A'} />
                    <DetailItem label="Accreditations" value={details.additionalNotes?.accreditations || 'N/A'} />
                    <DetailItem label="Investigator Publications" value={details.additionalNotes?.publications || 'N/A'} />
                    <DetailItem label="Recruitment Strategies" value={details.additionalNotes?.recruitmentStrategies || 'N/A'} />
                </DetailSection>
            </div>
        </div>
    );
}

const DetailSection = ({ title, children }) => (
    <div className="bg-white p-6 rounded-lg border border-gray-200">
        <h2 className="text-xl font-semibold text-gray-800 mb-4">{title}</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-8">
            {children}
        </div>
    </div>
);


// --- Match Score Reasoning Helper ---
function getMatchScoreReasoning(matchScore, siteDetails) {
    // Add null checks to prevent errors
    if (!siteDetails || !siteDetails.operationalPerformance || !siteDetails.clinicalCapabilities) {
        return `Match Score: ${matchScore}%\n\nSite details not available.`;
    }
    
    const score = parseInt(matchScore);
    let reasoning = '';
    
    if (score >= 90) {
        reasoning = `üéØ Excellent Match (${score}%)\n\nThis site demonstrates exceptional alignment with your criteria:\n‚Ä¢ High patient availability and enrollment capacity\n‚Ä¢ Strong PI expertise in your therapeutic area\n‚Ä¢ Proven track record with similar trials\n‚Ä¢ Optimal infrastructure and regulatory compliance\n‚Ä¢ Competitive advantage in the region`;
    } else if (score >= 80) {
        reasoning = `‚úÖ Strong Match (${score}%)\n\nThis site shows strong potential:\n‚Ä¢ Good patient population and enrollment rates\n‚Ä¢ Experienced PI with relevant background\n‚Ä¢ Solid infrastructure and operational efficiency\n‚Ä¢ Competitive positioning in the market\n‚Ä¢ Reliable regulatory track record`;
    } else if (score >= 70) {
        reasoning = `‚ö†Ô∏è Moderate Match (${score}%)\n\nThis site meets most requirements:\n‚Ä¢ Adequate patient access and enrollment\n‚Ä¢ Qualified PI with some experience\n‚Ä¢ Basic infrastructure meets needs\n‚Ä¢ Moderate competition in area\n‚Ä¢ Standard regulatory compliance`;
    } else if (score >= 60) {
        reasoning = `‚ö†Ô∏è Limited Match (${score}%)\n\nThis site has some limitations:\n‚Ä¢ Lower patient availability\n‚Ä¢ PI may need additional training\n‚Ä¢ Infrastructure gaps may exist\n‚Ä¢ Higher competition in region\n‚Ä¢ Regulatory challenges possible`;
    } else {
        reasoning = `‚ùå Poor Match (${score}%)\n\nThis site has significant limitations:\n‚Ä¢ Very limited patient access\n‚Ä¢ PI lacks relevant experience\n‚Ä¢ Infrastructure doesn't meet requirements\n‚Ä¢ High competition in area\n‚Ä¢ Regulatory compliance concerns`;
    }
    
    // Add specific site details with safe property access
    const pastTrials = siteDetails.operationalPerformance?.pastTrials || 'N/A';
    const enrollmentRate = siteDetails.operationalPerformance?.enrollmentRate || 'N/A';
    const timeToActivate = siteDetails.operationalPerformance?.timeToActivate || 'N/A';
    const therapeuticAreas = siteDetails.clinicalCapabilities?.therapeuticAreas || [];
    
    reasoning += `\n\nSite Strengths:\n‚Ä¢ ${pastTrials} past trials completed\n‚Ä¢ ${enrollmentRate} enrollment rate\n‚Ä¢ ${timeToActivate} activation time\n‚Ä¢ ${therapeuticAreas.length > 0 ? therapeuticAreas.join(', ') : 'N/A'} therapeutic expertise`;
    
    return reasoning;
}

// --- Mock AI Response Helper (Replaces Gemini API) ---
async function callGemini(prompt, retries = 3, delay = 1000) {
    // Simulate API delay
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // Mock responses based on prompt content
    const mockResponses = {
        'site': 'Based on the site analysis, this location shows strong enrollment capabilities and experienced staff. The historical performance indicates reliable trial execution.',
        'comparison': 'When comparing these sites, consider factors like enrollment rates, regulatory experience, and therapeutic area expertise. Each site has unique strengths.',
        'recommendation': 'I recommend focusing on sites with proven track records in your therapeutic area. Consider both performance metrics and operational efficiency.',
        'default': 'This is a mock AI response. In production, this would connect to a real AI service for clinical trial insights and recommendations.'
    };
    
    // Determine response based on prompt keywords
    if (prompt.toLowerCase().includes('site')) {
        return mockResponses.site;
    } else if (prompt.toLowerCase().includes('compar') || prompt.toLowerCase().includes('compare')) {
        return mockResponses.comparison;
    } else if (prompt.toLowerCase().includes('recommend') || prompt.toLowerCase().includes('suggest')) {
        return mockResponses.recommendation;
    } else {
        return mockResponses.default;
    }
}

function SiteComparisonPage({ navigateTo }) {
    // Get the sites and scenario from the navigation state
    const [sites, setSites] = useState([]);
    const [scenario, setScenario] = useState(null);
    const [hideIdentical, setHideIdentical] = useState(false);

    useEffect(() => {
        // Get the comparison data from localStorage or URL state
        const savedData = localStorage.getItem('pageData');
        if (savedData) {
            try {
                const data = JSON.parse(savedData);
                if (data.siteComparison) {
                    setSites(data.siteComparison.sites || []);
                    setScenario(data.siteComparison.scenario || null);
                }
            } catch (e) {
                console.error('Failed to parse saved data:', e);
            }
        }
    }, []);

    const handleHideIdenticalChange = (e) => {
        setHideIdentical(e.target.checked);
    };

    // Helper function to check if values are identical
    const isRowIdentical = (values) => {
        return values.every(val => val === values[0] && val !== 'N/A' && val !== '');
    };

    // Helper function to render a table row with conditional hiding
    const renderTableRow = (label, getValue) => {
        const values = sites.map(getValue);
        const isIdentical = isRowIdentical(values);
        
        // Hide row if hideIdentical is checked and row is identical
        if (hideIdentical && isIdentical) {
            return null;
        }
        
        return (
            <tr key={label} className={isIdentical ? 'identical-row' : ''}>
                <td className="px-6 py-4 text-sm font-medium text-gray-700 sticky left-0 z-20 bg-white">{label}</td>
                {sites.map(site => (
                    <td key={site.siteCode} className="px-6 py-4 text-sm text-gray-900">
                        {getValue(site)}
                    </td>
                ))}
            </tr>
        );
    };

    if (sites.length < 2) {
        return (
            <div className="p-8 text-center">
                <h1 className="text-2xl font-bold mb-4">Site Comparison</h1>
                <p>Please select at least 2 sites to compare.</p>
                <button onClick={() => navigateTo('projects')} className="flex items-center gap-2 mt-4 px-4 py-2 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700">
                    <svg className="w-5 h-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Projects
                </button>
            </div>
        );
    }

    return (
        <div className="p-4 sm:p-6 lg:p-8 max-w-screen-2xl mx-auto">
            <header className="mb-6">
                <button onClick={() => navigateTo('projects')} className="flex items-center gap-2 text-sm text-blue-600 hover:underline mb-2">
                    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Projects
                </button>
                <h1 className="text-3xl font-bold text-gray-900">Site Comparison ({sites.length} sites)</h1>
                <p className="text-gray-500">Comparing sites for scenario: <span className="font-semibold text-gray-700">{scenario?.title || 'Unknown Scenario'}</span></p>
            </header>

            {/* Site Comparison Table */}
            <div className="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden mb-8">
                <div className="flex justify-between items-center p-4 border-b border-gray-200">
                    <h3 className="text-lg font-semibold text-gray-900">Detailed Site Comparison</h3>
                    <label className="checkbox-container text-sm text-gray-600">
                        <input 
                            type="checkbox" 
                            checked={hideIdentical}
                            onChange={handleHideIdenticalChange}
                        />
                        Hide identical information
                    </label>
                </div>
                <div className="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider sticky left-0 z-20 bg-gray-50">Attribute</th>
                                    {sites.map(site => (
                                        <th key={site.siteCode} className="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase whitespace-nowrap sticky top-0 z-10 bg-gray-50">
                                            {site.site}
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                        <tbody className="divide-y divide-gray-200">
                            {/* Basic Site Info */}
                            <tr>
                                <td className="px-6 py-4 text-sm font-medium text-gray-700 bg-gray-50 sticky left-0 z-20">Basic Information</td>
                                {sites.map(site => (
                                    <td key={site.siteCode} className="px-6 py-4 text-sm text-gray-900"></td>
                                ))}
                            </tr>
                            {renderTableRow('Rank', site => `#${site.rank}`)}
                            {renderTableRow('State', site => site.state)}
                            {renderTableRow('Match Score', site => (
                                <span className="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                    {site.matchScore}%
                                </span>
                            ))}
                            {renderTableRow('Composite Score', site => site.compositeScore)}
                            
                            {/* Site Details */}
                            <tr>
                                <td className="px-6 py-4 text-sm font-medium text-gray-700 bg-gray-50 sticky left-0 z-20">Site Details</td>
                                {sites.map(site => (
                                    <td key={site.siteCode} className="px-6 py-4 text-sm text-gray-900"></td>
                                ))}
                            </tr>
                            <tr>
                                <td className="px-6 py-4 text-sm font-medium text-gray-700 sticky left-0 z-20 bg-white">Principal Investigator</td>
                                {sites.map(site => (
                                    <td key={site.siteCode} className="px-6 py-4 text-sm text-gray-900">{site.details?.siteInfo?.pi || 'N/A'}</td>
                                ))}
                            </tr>
                            <tr>
                                <td className="px-6 py-4 text-sm font-medium text-gray-700 sticky left-0 z-20 bg-white">Site Type</td>
                                {sites.map(site => (
                                    <td key={site.siteCode} className="px-6 py-4 text-sm text-gray-900">{site.details?.siteInfo?.siteType || 'N/A'}</td>
                                ))}
                            </tr>
                            <tr>
                                <td className="px-6 py-4 text-sm font-medium text-gray-700 sticky left-0 z-20 bg-white">IRB Status</td>
                                {sites.map(site => (
                                    <td key={site.siteCode} className="px-6 py-4 text-sm text-gray-900">{site.details?.siteInfo?.irbStatus || 'N/A'}</td>
                                ))}
                            </tr>
                            <tr>
                                <td className="px-6 py-4 text-sm font-medium text-gray-700 sticky left-0 z-20 bg-white">Regulatory Status</td>
                                {sites.map(site => (
                                    <td key={site.siteCode} className="px-6 py-4 text-sm text-gray-900">{site.details?.siteInfo?.regulatoryStatus || 'N/A'}</td>
                                ))}
                            </tr>
                            
                            {/* Operational Performance */}
                            <tr>
                                <td className="px-6 py-4 text-sm font-medium text-gray-700 bg-gray-50 sticky left-0 z-20">Operational Performance</td>
                                {sites.map(site => (
                                    <td key={site.siteCode} className="px-6 py-4 text-sm text-gray-900"></td>
                                ))}
                            </tr>
                            <tr>
                                <td className="px-6 py-4 text-sm font-medium text-gray-700 sticky left-0 z-20 bg-white">Enrollment Rate</td>
                                {sites.map(site => (
                                    <td key={site.siteCode} className="px-6 py-4 text-sm text-gray-900">{site.details?.operationalPerformance?.enrollmentRate || 'N/A'}</td>
                                ))}
                            </tr>
                            <tr>
                                <td className="px-6 py-4 text-sm font-medium text-gray-700 sticky left-0 z-20 bg-white">Activation Time</td>
                                {sites.map(site => (
                                    <td key={site.siteCode} className="px-6 py-4 text-sm text-gray-900">{site.details?.operationalPerformance?.timeToActivate || 'N/A'}</td>
                                ))}
                            </tr>
                            <tr>
                                <td className="px-6 py-4 text-sm font-medium text-gray-700 sticky left-0 z-20 bg-white">Past Trials</td>
                                {sites.map(site => (
                                    <td key={site.siteCode} className="px-6 py-4 text-sm text-gray-900">{site.details?.operationalPerformance?.pastTrials || 'N/A'}</td>
                                ))}
                            </tr>
                            <tr>
                                <td className="px-6 py-4 text-sm font-medium text-gray-700 sticky left-0 z-20 bg-white">Success Rate</td>
                                {sites.map(site => (
                                    <td key={site.siteCode} className="px-6 py-4 text-sm text-gray-900">{site.details?.operationalPerformance?.successRate || 'N/A'}</td>
                                ))}
                            </tr>
                            
                            {/* Patient Population */}
                            <tr>
                                <td className="px-6 py-4 text-sm font-medium text-gray-700 bg-gray-50 sticky left-0 z-20">Patient Population</td>
                                {sites.map(site => (
                                    <td key={site.siteCode} className="px-6 py-4 text-sm text-gray-900"></td>
                                ))}
                            </tr>
                            <tr>
                                <td className="px-6 py-4 text-sm font-medium text-gray-700 sticky left-0 z-20 bg-white">Available Patients</td>
                                {sites.map(site => (
                                    <td key={site.siteCode} className="px-6 py-4 text-sm text-gray-900">{site.details?.patientPopulation?.availablePatients || 'N/A'}</td>
                                ))}
                            </tr>
                            <tr>
                                <td className="px-6 py-4 text-sm font-medium text-gray-700 sticky left-0 z-20 bg-white">Demographics</td>
                                {sites.map(site => (
                                    <td key={site.siteCode} className="px-6 py-4 text-sm text-gray-900">{site.details?.patientPopulation?.demographics || 'N/A'}</td>
                                ))}
                            </tr>
                            <tr>
                                <td className="px-6 py-4 text-sm font-medium text-gray-700 sticky left-0 z-20 bg-white">Disease Prevalence</td>
                                {sites.map(site => (
                                    <td key={site.siteCode} className="px-6 py-4 text-sm text-gray-900">{site.details?.patientPopulation?.diseasePrevalence || 'N/A'}</td>
                                ))}
                            </tr>
                            
                            {/* Infrastructure */}
                            <tr>
                                <td className="px-6 py-4 text-sm font-medium text-gray-700 bg-gray-50 sticky left-0 z-20">Infrastructure</td>
                                {sites.map(site => (
                                    <td key={site.siteCode} className="px-6 py-4 text-sm text-gray-900"></td>
                                ))}
                            </tr>
                            <tr>
                                <td className="px-6 py-4 text-sm font-medium text-gray-700 sticky left-0 z-20 bg-white">Facilities</td>
                                {sites.map(site => (
                                    <td key={site.siteCode} className="px-6 py-4 text-sm text-gray-900">{site.details?.infrastructure?.facilities || 'N/A'}</td>
                                ))}
                            </tr>
                            <tr>
                                <td className="px-6 py-4 text-sm font-medium text-gray-700 sticky left-0 z-20 bg-white">Equipment</td>
                                {sites.map(site => (
                                    <td key={site.siteCode} className="px-6 py-4 text-sm text-gray-900">{site.details?.infrastructure?.equipment || 'N/A'}</td>
                                ))}
                            </tr>
                            <tr>
                                <td className="px-6 py-4 text-sm font-medium text-gray-700 sticky left-0 z-20 bg-white">Staffing</td>
                                {sites.map(site => (
                                    <td key={site.siteCode} className="px-6 py-4 text-sm text-gray-900">{site.details?.infrastructure?.staffing || 'N/A'}</td>
                                ))}
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

            {/* Action Buttons */}
            <div className="flex gap-4">
                <button 
                    onClick={() => navigateTo('projects')}
                    className="flex items-center gap-2 mt-4 px-4 py-2 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700">
                    <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Projects
                </button>
                <button 
                    onClick={() => navigateTo('results', scenario)}
                    className="flex items-center gap-2 mt-4 px-4 py-2 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors"
                >
                    <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Results
                </button>
            </div>
        </div>
    );
}

// Create Project Page Component
function CreateProjectPage({ navigateTo, onSave }) {
    const [formData, setFormData] = useState({
        name: '',
        description: '',
        therapeuticArea: '',
        sponsor: '',
        status: 'Active',
        startDate: '',
        endDate: '',
        budget: '',
        teamSize: '',
        location: ''
    });

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({
            ...prev,
            [name]: value
        }));
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        
        // Create new project
        const newProject = {
            id: 'project_' + Date.now(),
            ...formData,
            createdAt: new Date().toISOString(),
            scenarios: []
        };
        
        onSave(newProject);
        navigateTo('projects');
    };

    const therapeuticAreaOptions = [
        'Oncology', 'Cardiovascular', 'Neurology', 'Endocrinology', 'Immunology',
        'Respiratory', 'Gastroenterology', 'Dermatology', 'Ophthalmology', 'Psychiatry',
        'Infectious Disease', 'Rare Disease', 'Other'
    ];

    const statusOptions = ['Active', 'Completed', 'On Hold', 'Cancelled'];

    return (
        <div className="max-w-screen-2xl mx-auto p-4 sm:p-6 lg:p-8">
            <header className="mb-8">
                <button onClick={() => navigateTo('projects')} className="flex items-center gap-2 text-blue-600 hover:underline mb-2 h-6">
                    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Projects
                </button>
                <h1 className="text-3xl font-bold text-gray-900">Create New Project</h1>
                <p className="text-gray-500 mt-1">Set up a new clinical research project.</p>
            </header>
            
            <form onSubmit={handleSubmit} className="space-y-8">
                <div className="form-section p-8">
                    <h2 className="text-xl font-semibold text-gray-800 mb-6">Project Details</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <InputField label="Project Name *" name="name" value={formData.name} onChange={handleInputChange} required />
                        <CustomDropdownField label="Therapeutic Area *" options={therapeuticAreaOptions} selected={formData.therapeuticArea} onSelect={(val) => setFormData(p => ({...p, therapeuticArea: val}))} required />
                        <div className="col-span-1 md:col-span-2">
                            <TextAreaField label="Description" name="description" value={formData.description} onChange={handleInputChange} />
                        </div>
                        <InputField label="Sponsor" name="sponsor" value={formData.sponsor} onChange={handleInputChange} />
                        <CustomDropdownField label="Status" options={statusOptions} selected={formData.status} onSelect={(val) => setFormData(p => ({...p, status: val}))} />
                        <InputField label="Start Date" name="startDate" type="date" value={formData.startDate} onChange={handleInputChange} />
                        <InputField label="End Date" name="endDate" type="date" value={formData.endDate} onChange={handleInputChange} />
                        <InputField label="Budget" name="budget" value={formData.budget} onChange={handleInputChange} placeholder="e.g., $500,000" />
                        <InputField label="Team Size" name="teamSize" type="number" value={formData.teamSize} onChange={handleInputChange} placeholder="Number of team members" />
                        <InputField label="Location" name="location" value={formData.location} onChange={handleInputChange} placeholder="e.g., United States, Europe" />
                    </div>
                </div>

                <div className="flex gap-4">
                    <button type="submit" className="btn-gradient px-6 py-3 font-semibold rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all">
                        Create Project
                    </button>
                    <button type="button" onClick={() => navigateTo('projects')} className="px-6 py-3 font-semibold text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    );
}

const domContainer = document.querySelector('#root');
const root = ReactDOM.createRoot(domContainer);
root.render(<App />);    </script>
</body>
</html>
